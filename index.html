<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta property="og:title" content="مركز تراست لصيانة الأجهزة المنزلية">
<meta property="og:image" content="https://i.postimg.cc/vHbYGnf2/logo.jpg">
<meta property="og:url" content="https://yasser-q8.github.io/trustcenter/">    
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برنامج مركز تراست لصيانة الأجهزة المنزلية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* إعادة تعيين عام */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* تصميم جديد لشاشة الدخول مع أنيميشن */
        body.login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #111;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        /* الحاوية الرئيسية للأنيميشن */
        .login-ring-container {
            position: relative;
            width: 500px;
            height: 500px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* الحلقات المتحركة */
        .ring {
            position: absolute;
            inset: 0;
            border: 2px solid #fff;
            transition: 0.5s;
        }
        
        .ring:nth-child(1) {
            border-radius: 38% 62% 63% 37% / 41% 44% 56% 59%;
            animation: animate 6s linear infinite;
            border-color: #ff00cc;
        }
        
        .ring:nth-child(2) {
            border-radius: 41% 44% 56% 59% / 38% 62% 63% 37%;
            animation: animate 4s linear infinite;
            border-color: #00ffff;
        }
        
        .ring:nth-child(3) {
            border-radius: 41% 44% 56% 59% / 38% 62% 63% 37%;
            animation: animate2 10s linear infinite;
            border-color: #ffcc00;
        }
        
        .ring:hover {
            border: 6px solid var(--clr);
            filter: drop-shadow(0 0 20px var(--clr));
        }
        
        @keyframes animate {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        @keyframes animate2 {
            0% {
                transform: rotate(360deg);
            }
            100% {
                transform: rotate(0deg);
            }
        }
        
        /* صندوق الدخول داخل الأنيميشن */
        .login-box-animated {
            position: absolute;
            width: 350px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .login-box-animated h2 {
            font-size: 2em;
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            margin-bottom: 10px;
        }
        
        /* شعار المركز داخل الأنيميشن */
        .login-logo-animated {
            width: 120px;
            height: 120px;
            margin-bottom: 10px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid #FF6E00;
            box-shadow: 0 0 20px rgba(255, 110, 0, 0.5);
            background: white;
        }
        
        .login-logo-animated img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .login-title-animated {
            color: white;
            font-size: 2em;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            margin-bottom: 5px;
            text-align: center;
        }
        
        .login-subtitle-animated {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.2em;
            text-align: center;
            margin-bottom: 30px;
        }
        
        /* حقول الإدخال المعدلة */
        .inputBx {
            position: relative;
            width: 100%;
            margin-bottom: 15px;
        }
        
        .inputBx input, .inputBx select {
            position: relative;
            width: 100%;
            padding: 12px 15px;
            background: #222 !important;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            font-size: 1em;
            color: white !important;
            outline: none;
            transition: 0.3s;
        }
        
        .inputBx input:focus, .inputBx select:focus {
            border-color: #FF6E00;
            box-shadow: 0 0 10px rgba(255, 110, 0, 0.5);
        }
        
        .inputBx input::placeholder {
            color: rgba(255, 255, 255, 0.6) !important;
        }
        
        /* تحسين القائمة المنسدلة */
        .inputBx select option {
            background: #222 !important;
            color: white !important;
        }
        
        /* زر تسجيل الدخول */
        .inputBx input[type="submit"] {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            background: linear-gradient(45deg, #FF6E00, #FF8C42);
            color: white;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }
        
        .inputBx input[type="submit"]:hover {
            background: linear-gradient(45deg, #FF8C42, #FF6E00);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 110, 0, 0.3);
        }
        
        /* الروابط */
        .links {
            position: relative;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            margin-top: 15px;
        }
        
        .links a {
            color: white;
            text-decoration: none;
            font-size: 0.9em;
            transition: 0.3s;
        }
        
        .links a:hover {
            color: #FF6E00;
            text-shadow: 0 0 10px rgba(255, 110, 0, 0.5);
        }
        
        /* رسالة الخطأ */
        #loginError {
            color: #ff6b6b;
            margin-top: 10px;
            text-align: center;
            display: none;
            padding: 8px;
            border-radius: 5px;
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            width: 100%;
        }
        
        /* توقيع المطور في شاشة الدخول */
        .signature-card-login {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, #FF6E00, #80EF80, #2196F3);
            color: white;
            padding: 10px 18px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 1000;
            animation: float 6s ease-in-out infinite;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .signature-card-login:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.4); 
        }
        
        @keyframes float { 
            0% { transform: translateY(0px); } 
            50% { transform: translateY(-8px); } 
            100% { transform: translateY(0px); } 
        }
        
        .signature-card-login .name { 
            font-size: 1.1rem; 
            font-weight: 700; 
            margin-bottom: 3px; 
        }
        
        .signature-card-login .title { 
            font-size: 0.75rem; 
            opacity: 0.9; 
            font-weight: 500; 
        }
        
        /* التجاوب مع الشاشات الصغيرة */
        @media (max-width: 768px) {
            .login-ring-container {
                width: 100%;
                height: 100%;
                padding: 20px;
            }
            
            .login-box-animated {
                width: 90%;
                max-width: 320px;
                padding: 25px 20px;
            }
            
            .login-title-animated {
                font-size: 1.5em;
            }
            
            .login-subtitle-animated {
                font-size: 1em;
            }
            
            .signature-card-login {
                position: relative;
                bottom: auto;
                left: auto;
                margin: 20px auto 0;
                width: fit-content;
                animation: none;
            }
        }
        
        /* =========== التصميم الأصلي للتطبيق الرئيسي =========== */
        body.app-screen {
            background-color: #e6f7ff;
            color: #333;
            line-height: 1.6;
            background-image: url('https://i.postimg.cc/zDSN2f6D/logo-Copy.jpg');
            background-repeat: repeat;
            background-size: 150px;
            background-attachment: fixed;
            background-position: center;
            background-blend-mode: overlay;
            overflow-y: auto;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1350px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* شاشة تسجيل الدخول الأصلية (مخفية) */
        .login-container {
            display: none;
        }
        
        /* الهيدر */
        header {
            background: linear-gradient(135deg, #1a8c5e 0%, #2ecc71 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 3px solid #FF6E00;
        }
        
        .logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .header-text h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .header-text p {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .user-name {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .logout-btn {
            background-color: #FF6E00;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .logout-btn:hover {
            background-color: #e65c00;
        }
        
        /* شريط التنقل */
        nav {
            display: flex;
            background: linear-gradient(135deg, #FF8C42, #FF6E00);
            border-radius: 10px;
            margin-bottom: 30px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
        }
        
        .nav-btn {
            flex: 1;
            min-width: 150px;
            text-align: center;
            padding: 15px 10px;
            background: transparent;
            border: none;
            font-size: 0.95rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .nav-btn.active {
            background-color: rgba(255, 255, 255, 0.3);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .nav-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .nav-btn.disabled:hover {
            background: transparent;
        }
        
        /* محتوى الصفحات */
        .content-section {
            display: none;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            backdrop-filter: blur(5px);
        }
        
        .content-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-title {
            font-size: 1.5rem;
            color: #1a8c5e;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0f7e9;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: #FF6E00;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #444;
        }
        
        input, select, textarea {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border 0.3s;
            background: white;
            color: #333;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #FF6E00;
        }
        
        .btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #1a8c5e, #2ecc71);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            background: linear-gradient(135deg, #2ecc71, #1a8c5e);
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }
        
        .btn-orange {
            background: linear-gradient(135deg, #FF6E00, #FF8C42);
        }
        
        .btn-orange:hover {
            background: linear-gradient(135deg, #FF8C42, #FF6E00);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #34ce57);
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #34ce57, #28a745);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #e4606d);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #e4606d, #dc3545);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #4dc7d9);
        }
        
        .btn-info:hover {
            background: linear-gradient(135deg, #4dc7d9, #17a2b8);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 700;
            color: #1a8c5e;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .action-btns {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 5px 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .edit-btn {
            background: linear-gradient(135deg, #FFC107, #ffd54f);
            color: #333;
        }
        
        .delete-btn {
            background: linear-gradient(135deg, #dc3545, #e4606d);
            color: white;
        }
        
        .pay-btn {
            background: linear-gradient(135deg, #28a745, #34ce57);
            color: white;
        }
        
        /* كروت الإحصائيات */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-top: 5px solid #FF6E00;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .card h3 {
            color: #1a8c5e;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .card-value {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }
        
        .card-profit {
            color: #1a8c5e;
        }
        
        .card-loss {
            color: #dc3545;
        }
        
        .date-filter {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .report-table {
            overflow-x: auto;
        }
        
        .empty-message {
            text-align: center;
            padding: 40px;
            color: #777;
            font-size: 1.1rem;
        }
        
        .empty-message i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ddd;
        }
        
        /* مربعات مصروفات الأوردر */
        .expense-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .expense-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }
        
        .expense-box label {
            display: block;
            margin-bottom: 8px;
            color: #1a8c5e;
            font-weight: 600;
        }
        
        /* شريط البحث */
        .search-bar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #FF6E00;
        }
        
        /* شاشة السلف */
        .advance-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .advance-history {
            margin-top: 30px;
        }
        
        .advance-summary {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-right: 5px solid #1a8c5e;
        }
        
        .advance-summary h4 {
            color: #1a8c5e;
            margin-bottom: 10px;
        }
        
        .advance-summary p {
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        /* شاشة العملاء */
        .customer-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 5px solid #FF6E00;
        }
        
        .customer-info {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .customer-info-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #eee;
        }
        
        .customer-info-label {
            font-weight: 600;
            color: #1a8c5e;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .customer-info-value {
            font-size: 1.1rem;
        }
        
        /* النسخ الاحتياطي */
        .backup-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .backup-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .backup-item {
            background: white;
            padding: 12px 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 4px solid #1a8c5e;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .backup-item-info {
            display: flex;
            flex-direction: column;
        }
        
        .backup-item-name {
            font-weight: 600;
            color: #333;
        }
        
        .backup-item-date {
            font-size: 0.9rem;
            color: #777;
        }
        
        .backup-actions {
            display: flex;
            gap: 10px;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #777;
            font-size: 0.9rem;
        }
        
        /* توقيع المطور في التطبيق الرئيسي */
        .signature-card {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, #FF6E00, #80EF80, #2196F3);
            color: white;
            padding: 10px 18px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 1000;
            animation: float 6s ease-in-out infinite;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .signature-card:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.4); 
        }
        
        .signature-card .name { 
            font-size: 1.1rem; 
            font-weight: 700; 
            margin-bottom: 3px; 
        }
        
        .signature-card .title { 
            font-size: 0.75rem; 
            opacity: 0.9; 
            font-weight: 500; 
        }
        
        @media (max-width: 768px) { 
            .signature-card { 
                position: relative; 
                bottom: auto; 
                left: auto; 
                margin: 20px auto 0; 
                width: fit-content; 
                animation: none; 
            } 
            
            .nav-btn {
                min-width: 120px;
                font-size: 0.9rem;
                padding: 12px 5px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .header-text h1 {
                font-size: 1.4rem;
            }
            
            header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .user-info {
                width: 100%;
                justify-content: center;
                margin-top: 15px;
            }
            
            .date-filter {
                flex-direction: column;
                align-items: stretch;
            }
        }
        
        /* شاشة تغيير كلمة المرور */
        .change-password-container {
            max-width: 500px;
            margin: 0 auto;
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
        }
        
        /* إخفاء العناصر حسب الصلاحية */
        .hidden-by-role {
            display: none !important;
        }
        
        /* تلقائي إظهار بيانات العميل */
        .customer-autofill {
            background: #e8f5e9;
            padding: 10px 15px;
            border-radius: 5px;
            margin-top: 10px;
            border-right: 3px solid #1a8c5e;
            display: none;
        }
        
        .customer-autofill.show {
            display: block;
        }
        
        /* مودال تسديد السلفة */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-title {
            color: #1a8c5e;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* حالة التطبيق */
        #mainApp {
            display: none;
        }
        
        /* عرض شاشة الدخول */
        body.login-screen #loginScreen {
            display: flex;
        }
        
        body.login-screen #mainApp {
            display: none;
        }
        
        /* عرض التطبيق الرئيسي */
        body.app-screen #loginScreen {
            display: none;
        }
        
        body.app-screen #mainApp {
            display: block;
        }
    </style>
</head>
<body class="login-screen">
    <!-- شاشة تسجيل الدخول مع الأنيميشن -->
    <div id="loginScreen">
        <div class="login-ring-container">
            <!-- الحلقات المتحركة -->
            <div class="ring" style="--clr:#ff00cc;"></div>
            <div class="ring" style="--clr:#00ffff;"></div>
            <div class="ring" style="--clr:#ffcc00;"></div>
            
            <!-- صندوق الدخول -->
            <div class="login-box-animated">
                <div class="login-logo-animated">
                    <img src="https://i.postimg.cc/zDSN2f6D/logo-Copy.jpg" alt="شعار مركز تراست">
                </div>
                <h2 class="login-title-animated">مركز تراست</h2>
                <p class="login-subtitle-animated">لصيانة الأجهزة المنزلية</p>
                
                <div class="inputBx">
                    <select id="loginUser">
                        <option value="">اختر المستخدم</option>
                        <option value="1">Yasser (مطور النظام)</option>
                        <option value="2">وائل (المدير العام)</option>
                        <option value="3">محمد (مشرف)</option>
                        <option value="4">جمال (مدخل بيانات)</option>
                    </select>
                </div>
                
                <div class="inputBx">
                    <input type="password" id="loginPassword" placeholder="كلمة المرور (123)">
                </div>
                
                <div class="inputBx">
                    <input type="submit" value="تسجيل الدخول" id="loginBtn">
                </div>
                
              
                
                <div id="loginError">
                    <i class="fas fa-exclamation-circle"></i> كلمة المرور غير صحيحة
                </div>
            </div>
        </div>
        
        <!-- توقيع المطور في شاشة الدخول -->
        <div class="signature-card-login">
            <div class="name">Yasser Elkhateeb</div>
            <div class="title">مطور البرنامج 01146118541</div>
        </div>
    </div>
    
    <!-- الواجهة الرئيسية -->
    <div id="mainApp">
        <div class="container">
            <header>
                <div class="logo-container">
                    <div class="logo">
                        <img src="https://i.postimg.cc/zDSN2f6D/logo-Copy.jpg" alt="شعار مركز تراست">
                    </div>
                    <div class="header-text">
                        <h1>مركز تراست لصيانة الأجهزة المنزلية</h1>
                        <p>برنامج إدارة مركز الصيانة - نظام متكامل للمحاسبة والتقارير</p>
                    </div>
                </div>
                <div class="user-info">
                    <div class="user-name" id="currentUserName"></div>
                    <div class="user-name" id="currentUserRole"></div>
                    <button id="logoutBtn" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                    </button>
                    <button id="changePasswordBtn" class="logout-btn" style="background-color: #1a8c5e;">
                        <i class="fas fa-key"></i> تغيير كلمة المرور
                    </button>
                </div>
            </header>
            
            <nav>
                <button class="nav-btn active" data-section="dashboard" id="dashboardNav">
                    <i class="fas fa-home"></i> لوحة التحكم
                </button>
                <button class="nav-btn" data-section="customers" id="customersNav">
                    <i class="fas fa-users"></i> العملاء
                </button>
                <button class="nav-btn" data-section="settings" id="settingsNav">
                    <i class="fas fa-cogs"></i> الإعدادات
                </button>
                <button class="nav-btn" data-section="orders">
                    <i class="fas fa-file-invoice-dollar"></i> تسجيل الفواتير
                </button>
                <button class="nav-btn" data-section="order-expenses">
                    <i class="fas fa-tools"></i> مصروفات الأوردر
                </button>
                <button class="nav-btn" data-section="general-expenses" id="generalExpensesNav">
                    <i class="fas fa-receipt"></i> المصروفات العامة
                </button>
                <button class="nav-btn" data-section="advances">
                    <i class="fas fa-hand-holding-usd"></i> سلف الموظفين
                </button>
                <button class="nav-btn" data-section="reports" id="reportsNav">
                    <i class="fas fa-chart-bar"></i> التقارير
                </button>
            </nav>
            
            <!-- لوحة التحكم -->
            <section id="dashboard" class="content-section active">
                <h2 class="section-title"><i class="fas fa-home"></i> لوحة التحكم وملخص العمليات</h2>
                
                <!-- فلاتر التاريخ -->
                <div class="date-filter">
                    <div>
                        <label for="summaryFromDate">من تاريخ</label>
                        <input type="date" id="summaryFromDate">
                    </div>
                    <div>
                        <label for="summaryToDate">إلى تاريخ</label>
                        <input type="date" id="summaryToDate">
                    </div>
                    <button id="filterSummaryBtn" class="btn">
                        <i class="fas fa-filter"></i> تصفية الملخص
                    </button>
                    <button id="resetSummaryBtn" class="btn">
                        <i class="fas fa-redo"></i> هذا الشهر
                    </button>
                </div>
                
                <!-- كروت الإحصائيات -->
                <div class="dashboard-cards">
                    <div class="card">
                        <h3>إجمالي الإيرادات</h3>
                        <div class="card-value" id="totalRevenue">0 ج.م</div>
                        <p id="revenuePeriod">منذ بداية الشهر</p>
                    </div>
                    <div class="card">
                        <h3>عدد الفواتير</h3>
                        <div class="card-value" id="totalOrders">0</div>
                        <p id="ordersPeriod">فواتير هذا الشهر</p>
                    </div>
                    <div class="card">
                        <h3>صافي الربح</h3>
                        <div class="card-value card-profit" id="netProfit">0 ج.م</div>
                        <p id="profitPeriod">لهذا الشهر</p>
                    </div>
                    <div class="card">
                        <h3>المصروفات</h3>
                        <div class="card-value" id="totalExpenses">0 ج.م</div>
                        <p id="expensesPeriod">إجمالي المصروفات</p>
                    </div>
                    <div class="card">
                        <h3>الفنيين النشطين</h3>
                        <div class="card-value" id="activeTechnicians">0</div>
                        <p>عدد الفنيين المسجلين</p>
                    </div>
                    <div class="card">
                        <h3>السلف المستحقة</h3>
                        <div class="card-value" id="totalAdvances">0 ج.م</div>
                        <p>إجمالي سلف الموظفين</p>
                    </div>
                    <div class="card">
                        <h3>عمولات الفنيين</h3>
                        <div class="card-value" id="totalCommissions">0 ج.م</div>
                        <p id="commissionsPeriod">لهذا الشهر</p>
                    </div>
                    <div class="card">
                        <h3>نسبة الربحية</h3>
                        <div class="card-value" id="profitPercentage">0%</div>
                        <p id="percentagePeriod">متوسط الربحية</p>
                    </div>
                </div>
                
                <!-- تفاصيل الملخص -->
                <div style="margin-top: 30px;">
                    <h3 class="section-title"><i class="fas fa-table"></i> تفاصيل الملخص</h3>
                    <div class="dashboard-cards" id="detailedSummary">
                        <!-- سيتم ملؤها بالبيانات من JavaScript -->
                    </div>
                </div>
                
                <!-- آخر الفواتير -->
                <div style="margin-top: 30px;">
                    <h3 class="section-title"><i class="fas fa-chart-line"></i> آخر الفواتير</h3>
                    <div class="report-table">
                        <table id="recentOrdersTable">
                            <thead>
                                <tr>
                                    <th>رقم الفاتورة</th>
                                    <th>التاريخ</th>
                                    <th>اسم العميل</th>
                                    <th>نوع التصليح</th>
                                    <th>المبلغ (ج.م)</th>
                                    <th>اسم الفني</th>
                                </tr>
                            </thead>
                            <tbody id="recentOrdersTableBody">
                                <!-- سيتم ملؤها بالبيانات من JavaScript -->
                            </tbody>
                        </table>
                        <div id="noRecentOrders" class="empty-message">
                            <i class="fas fa-file-invoice"></i>
                            <p>لا يوجد فواتير مسجلة بعد.</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- شاشة العملاء -->
            <section id="customers" class="content-section">
                <h2 class="section-title"><i class="fas fa-users"></i> إدارة العملاء</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="customerNameInput">اسم العميل *</label>
                        <input type="text" id="customerNameInput" placeholder="اسم العميل">
                    </div>
                    <div class="form-group">
                        <label for="customerPhoneInput">رقم الهاتف *</label>
                        <input type="tel" id="customerPhoneInput" placeholder="رقم هاتف العميل">
                    </div>
                    <div class="form-group">
                        <label for="customerAddressInput">عنوان العميل</label>
                        <input type="text" id="customerAddressInput" placeholder="عنوان العميل">
                    </div>
                </div>
                <div class="action-btns">
                    <button id="saveCustomerBtn" class="btn btn-success">
                        <i class="fas fa-save"></i> حفظ العميل
                    </button>
                    <button id="updateCustomerBtn" class="btn btn-success hidden-by-role">
                        <i class="fas fa-save"></i> تحديث العميل
                    </button>
                    <button id="cancelCustomerBtn" class="btn btn-danger hidden-by-role">
                        <i class="fas fa-times"></i> إلغاء التعديل
                    </button>
                </div>
                
                <!-- شريط البحث -->
                <div class="search-bar" style="margin-top: 30px;">
                    <input type="text" id="searchCustomers" class="search-input" placeholder="ابحث باسم العميل أو رقم الهاتف أو العنوان...">
                </div>
                
                <div id="customersList">
                    <!-- سيتم ملؤها بالبيانات من JavaScript -->
                </div>
            </section>
            
            <!-- شاشة الإعدادات -->
            <section id="settings" class="content-section">
                <h2 class="section-title"><i class="fas fa-cogs"></i> إعدادات النظام</h2>
                
                <!-- النسخ الاحتياطي -->
                <div style="margin-bottom: 40px;">
                    <h3 style="color: #1a8c5e; margin-bottom: 15px;"><i class="fas fa-database"></i> النسخ الاحتياطي</h3>
                    <div class="backup-section">
                        <p>النسخ الاحتياطي التلقائي يتم كل ساعة تلقائياً. يمكنك أيضاً إنشاء نسخة يدوية.</p>
                        <div class="action-btns" style="margin-top: 15px;">
                            <button id="createBackupBtn" class="btn btn-success">
                                <i class="fas fa-save"></i> إنشاء نسخة احتياطية يدوية
                            </button>
                            <button id="restoreLastBackupBtn" class="btn btn-info">
                                <i class="fas fa-history"></i> استعادة آخر نسخة
                            </button>
                        </div>
                        
                        <div class="backup-list" id="backupList">
                            <!-- سيتم ملؤها بالبيانات من JavaScript -->
                        </div>
                    </div>
                </div>
                
                <!-- إدارة الفنيين -->
                <div style="margin-bottom: 40px;">
                    <h3 style="color: #1a8c5e; margin-bottom: 15px;"><i class="fas fa-users"></i> إدارة الفنيين</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="techName">اسم الفني</label>
                            <input type="text" id="techName" placeholder="أدخل اسم الفني">
                        </div>
                        <div class="form-group">
                            <label for="techPercentage">نسبة العمولة (%)</label>
                            <input type="number" id="techPercentage" min="0" max="100" placeholder="النسبة من 0 إلى 100">
                        </div>
                    </div>
                    <div class="action-btns">
                        <button id="addTechBtn" class="btn btn-orange">
                            <i class="fas fa-plus"></i> إضافة فني
                        </button>
                        <button id="updateTechBtn" class="btn btn-success hidden-by-role">
                            <i class="fas fa-save"></i> تحديث الفني
                        </button>
                        <button id="cancelTechBtn" class="btn btn-danger hidden-by-role">
                            <i class="fas fa-times"></i> إلغاء التعديل
                        </button>
                    </div>
                    
                    <div class="table-container" style="margin-top: 30px;">
                        <h4 style="color: #444; margin-bottom: 15px;">قائمة الفنيين</h4>
                        <table id="techTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>اسم الفني</th>
                                    <th>نسبة العمولة (%)</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="techTableBody">
                                <!-- سيتم ملؤها بالبيانات من JavaScript -->
                            </tbody>
                        </table>
                        <div id="noTechs" class="empty-message">
                            <i class="fas fa-users"></i>
                            <p>لا يوجد فنيين مسجلين بعد. قم بإضافة فنيين للنظام.</p>
                        </div>
                    </div>
                </div>
                
                <!-- إدارة المستخدمين -->
                <div id="usersManagement" class="hidden-by-role">
                    <h3 style="color: #1a8c5e; margin-bottom: 15px;"><i class="fas fa-user-cog"></i> إدارة المستخدمين</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="userName">اسم المستخدم</label>
                            <input type="text" id="userName" placeholder="أدخل اسم المستخدم">
                        </div>
                        <div class="form-group">
                            <label for="userRole">دور المستخدم</label>
                            <select id="userRole">
                                <option value="superAdmin">المدير العام</option>
                                <option value="admin">مشرف</option>
                                <option value="dataEntry">مدخل بيانات</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="userPassword">كلمة المرور</label>
                            <input type="text" id="userPassword" placeholder="كلمة المرور (123)">
                        </div>
                    </div>
                    <div class="action-btns">
                        <button id="addUserBtn" class="btn btn-orange">
                            <i class="fas fa-plus"></i> إضافة مستخدم
                        </button>
                        <button id="updateUserBtn" class="btn btn-success hidden-by-role">
                            <i class="fas fa-save"></i> تحديث المستخدم
                        </button>
                        <button id="cancelUserBtn" class="btn btn-danger hidden-by-role">
                            <i class="fas fa-times"></i> إلغاء التعديل
                        </button>
                    </div>
                    
                    <div class="table-container" style="margin-top: 30px;">
                        <h4 style="color: #444; margin-bottom: 15px;">قائمة المستخدمين</h4>
                        <table id="usersTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>اسم المستخدم</th>
                                    <th>الدور</th>
                                    <th>كلمة المرور</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- سيتم ملؤها بالبيانات من JavaScript -->
                            </tbody>
                        </table>
                        <div id="noUsers" class="empty-message">
                            <i class="fas fa-users"></i>
                            <p>لا يوجد مستخدمين مسجلين بعد.</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- شاشة تسجيل الفواتير -->
            <section id="orders" class="content-section">
                <h2 class="section-title"><i class="fas fa-file-invoice-dollar"></i> تسجيل فاتورة إيراد جديدة</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="orderNumber">رقم الأوردر (الفاتورة)</label>
                        <input type="text" id="orderNumber" placeholder="رقم الفاتورة">
                    </div>
                    <div class="form-group">
                        <label for="orderDate">تاريخ الفاتورة</label>
                        <input type="date" id="orderDate">
                    </div>
                    <div class="form-group">
                        <label for="customerPhone">رقم موبايل العميل *</label>
                        <input type="tel" id="customerPhone" placeholder="رقم هاتف العميل">
                    </div>
                </div>
                
                <!-- بيانات العميل التلقائية -->
                <div id="customerAutofill" class="customer-autofill">
                    <div class="customer-info">
                        <div class="customer-info-item">
                            <div class="customer-info-label">اسم العميل</div>
                            <div class="customer-info-value" id="autofillName">-</div>
                        </div>
                        <div class="customer-info-item">
                            <div class="customer-info-label">العنوان</div>
                            <div class="customer-info-value" id="autofillAddress">-</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="customerName">اسم العميل *</label>
                        <input type="text" id="customerName" placeholder="اسم العميل">
                    </div>
                    <div class="form-group">
                        <label for="customerAddress">عنوان العميل</label>
                        <input type="text" id="customerAddress" placeholder="عنوان العميل">
                    </div>
                    <div class="form-group">
                        <label for="technician">الفني القائم بالتصليح</label>
                        <select id="technician">
                            <option value="">اختر الفني</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="repairType">نوع التصليح</label>
                        <select id="repairType">
                            <option value="ثلاجة وتكييف">ثلاجة وتكييف</option>
                            <option value="تكييف">تكييف</option>
                            <option value="أجهزة منزلية">أجهزة منزلية</option>
                            <option value="أخرى">أخرى</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="orderAmount">مبلغ الفاتورة (ج.م)</label>
                        <input type="number" id="orderAmount" min="0" placeholder="إجمالي مبلغ الفاتورة">
                    </div>
                </div>
                <div class="form-group">
                    <label for="orderDescription">بيان الفاتورة (وصف الأعمال)</label>
                    <textarea id="orderDescription" rows="3" placeholder="تفاصيل الأعمال المنفذة"></textarea>
                </div>
                <div class="action-btns">
                    <button id="saveOrderBtn" class="btn btn-success">
                        <i class="fas fa-save"></i> حفظ الفاتورة
                    </button>
                    <button id="updateOrderBtn" class="btn btn-success hidden-by-role">
                        <i class="fas fa-save"></i> تحديث الفاتورة
                    </button>
                    <button id="cancelOrderBtn" class="btn btn-danger hidden-by-role">
                        <i class="fas fa-times"></i> إلغاء التعديل
                    </button>
                </div>
                
                <!-- شريط البحث -->
                <div class="search-bar" style="margin-top: 40px;">
                    <input type="text" id="searchOrders" class="search-input" placeholder="ابحث برقم الفاتورة أو اسم العميل أو رقم الهاتف أو العنوان...">
                </div>
                
                <div class="table-container">
                    <h3 class="section-title"><i class="fas fa-list"></i> الفواتير المسجلة</h3>
                    <table id="ordersTable">
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>التاريخ</th>
                                <th>اسم العميل</th>
                                <th>هاتف العميل</th>
                                <th>العنوان</th>
                                <th>نوع التصليح</th>
                                <th>المبلغ (ج.م)</th>
                                <th>اسم الفني</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- سيتم ملؤها بالبيانات من JavaScript -->
                        </tbody>
                    </table>
                    <div id="noOrders" class="empty-message">
                        <i class="fas fa-file-invoice"></i>
                        <p>لا يوجد فواتير مسجلة بعد. قم بإضافة فاتورة جديدة.</p>
                    </div>
                </div>
            </section>
            
            <!-- شاشة مصروفات الأوردر -->
            <section id="order-expenses" class="content-section">
                <h2 class="section-title"><i class="fas fa-tools"></i> تسجيل مصروفات الأوردر</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="expenseOrderNumber">رقم الأوردر (الفاتورة)</label>
                        <select id="expenseOrderNumber">
                            <option value="">اختر رقم الفاتورة</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="expenseDate">تاريخ المصروف</label>
                        <input type="date" id="expenseDate">
                    </div>
                </div>
                
                <div class="expense-inputs">
                    <div class="expense-box">
                        <label for="partsExpense">قطع غيار (ج.م)</label>
                        <input type="number" id="partsExpense" min="0" placeholder="مبلغ قطع الغيار">
                    </div>
                    <div class="expense-box">
                        <label for="transportExpense">مواصلات (ج.م)</label>
                        <input type="number" id="transportExpense" min="0" placeholder="مبلغ المواصلات">
                    </div>
                    <div class="expense-box">
                        <label for="otherExpense">أخرى (ج.م)</label>
                        <input type="number" id="otherExpense" min="0" placeholder="مصاريف أخرى">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="expenseDescription">بيان المصروف</label>
                    <textarea id="expenseDescription" rows="3" placeholder="تفاصيل المصروف"></textarea>
                </div>
                <div class="action-btns">
                    <button id="saveExpenseBtn" class="btn btn-success">
                        <i class="fas fa-save"></i> حفظ المصروف
                    </button>
                    <button id="updateExpenseBtn" class="btn btn-success hidden-by-role">
                        <i class="fas fa-save"></i> تحديث المصروف
                    </button>
                    <button id="cancelExpenseBtn" class="btn btn-danger hidden-by-role">
                        <i class="fas fa-times"></i> إلغاء التعديل
                    </button>
                </div>
                
                <div class="table-container" style="margin-top: 40px;">
                    <h3 class="section-title"><i class="fas fa-list"></i> مصروفات الأوردرات</h3>
                    <table id="expensesTable">
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>تاريخ المصروف</th>
                                <th>قطع غيار</th>
                                <th>مواصلات</th>
                                <th>أخرى</th>
                                <th>الإجمالي</th>
                                <th>البيان</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody">
                            <!-- سيتم ملؤها بالبيانات من JavaScript -->
                        </tbody>
                    </table>
                    <div id="noExpenses" class="empty-message">
                        <i class="fas fa-tools"></i>
                        <p>لا يوجد مصروفات مسجلة بعد. قم بإضافة مصروف جديد.</p>
                    </div>
                </div>
            </section>
            
            <!-- شاشة المصروفات العامة -->
            <section id="general-expenses" class="content-section">
                <h2 class="section-title"><i class="fas fa-receipt"></i> تسجيل مصروفات عامة</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="generalExpenseDate">تاريخ المصروف</label>
                        <input type="date" id="generalExpenseDate">
                    </div>
                    <div class="form-group">
                        <label for="generalExpenseType">نوع المصروف</label>
                        <select id="generalExpenseType">
                            <option value="ايجار المركز">ايجار المركز</option>
                            <option value="ايجار سكن الموظفين">ايجار سكن الموظفين</option>
                            <option value="ايجار شقة 1">ايجار شقة 1</option>
                            <option value="الرواتب">الرواتب</option>
                            <option value="النظافة">النظافة</option>
                            <option value="الضيافة">الضيافة</option>
                            <option value="أخرى">أخرى</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="generalExpenseAmount">مبلغ المصروف (ج.م)</label>
                        <input type="number" id="generalExpenseAmount" min="0" placeholder="مبلغ المصروف">
                    </div>
                </div>
                <div class="form-group">
                    <label for="generalExpenseDescription">بيان المصروف</label>
                    <textarea id="generalExpenseDescription" rows="3" placeholder="تفاصيل المصروف"></textarea>
                </div>
                <div class="action-btns">
                    <button id="saveGeneralExpenseBtn" class="btn btn-success">
                        <i class="fas fa-plus"></i> إضافة مصروف عام
                    </button>
                    <button id="updateGeneralExpenseBtn" class="btn btn-success hidden-by-role">
                        <i class="fas fa-save"></i> تحديث المصروف
                    </button>
                    <button id="cancelGeneralExpenseBtn" class="btn btn-danger hidden-by-role">
                        <i class="fas fa-times"></i> إلغاء التعديل
                    </button>
                </div>
                
                <div class="table-container" style="margin-top: 40px;">
                    <h3 class="section-title"><i class="fas fa-list"></i> المصروفات العامة المسجلة</h3>
                    <table id="generalExpensesTable">
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>نوع المصروف</th>
                                <th>المبلغ (ج.م)</th>
                                <th>البيان</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="generalExpensesTableBody">
                            <!-- سيتم ملؤها بالبيانات من JavaScript -->
                        </tbody>
                    </table>
                    <div id="noGeneralExpenses" class="empty-message">
                        <i class="fas fa-receipt"></i>
                        <p>لا يوجد مصروفات عامة مسجلة بعد. قم بإضافة مصروف عام جديد.</p>
                    </div>
                </div>
            </section>
            
            <!-- شاشة السلف -->
            <section id="advances" class="content-section">
                <h2 class="section-title"><i class="fas fa-hand-holding-usd"></i> إدارة سلف الموظفين والفنيين</h2>
                
                <div class="advance-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="advanceEmployee">اسم الموظف/الفني</label>
                            <select id="advanceEmployee">
                                <option value="">اختر الموظف</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="advanceDate">تاريخ السلفة</label>
                            <input type="date" id="advanceDate">
                        </div>
                        <div class="form-group">
                            <label for="advanceAmount">مبلغ السلفة (ج.م)</label>
                            <input type="number" id="advanceAmount" min="0" placeholder="مبلغ السلفة">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="advanceReason">سبب السلفة</label>
                        <textarea id="advanceReason" rows="3" placeholder="سبب السلفة"></textarea>
                    </div>
                    <div class="action-btns">
                        <button id="saveAdvanceBtn" class="btn btn-success">
                            <i class="fas fa-save"></i> حفظ السلفة
                        </button>
                        <button id="updateAdvanceBtn" class="btn btn-success hidden-by-role">
                            <i class="fas fa-save"></i> تحديث السلفة
                        </button>
                        <button id="cancelAdvanceBtn" class="btn btn-danger hidden-by-role">
                            <i class="fas fa-times"></i> إلغاء التعديل
                        </button>
                    </div>
                </div>
                
                <div class="advance-history">
                    <h3 class="section-title"><i class="fas fa-history"></i> كشف حساب الذمة للموظفين</h3>
                    
                    <div class="date-filter">
                        <div class="form-group">
                            <label for="advanceEmployeeFilter">اختر الموظف</label>
                            <select id="advanceEmployeeFilter">
                                <option value="">جميع الموظفين</option>
                            </select>
                        </div>
                        <div>
                            <label for="advanceFromDate">من تاريخ</label>
                            <input type="date" id="advanceFromDate">
                        </div>
                        <div>
                            <label for="advanceToDate">إلى تاريخ</label>
                            <input type="date" id="advanceToDate">
                        </div>
                        <button id="filterAdvancesBtn" class="btn">
                            <i class="fas fa-filter"></i> تصفية السلف
                        </button>
                        <button id="resetAdvancesBtn" class="btn">
                            <i class="fas fa-redo"></i> عرض الكل
                        </button>
                    </div>
                    
                    <!-- ملخص الذمة -->
                    <div id="advanceSummary" class="advance-summary">
                        <!-- سيتم ملؤها بالبيانات من JavaScript -->
                    </div>
                    
                    <div class="report-table">
                        <table id="advancesTable">
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>اسم الموظف</th>
                                    <th>المبلغ (ج.م)</th>
                                    <th>النوع</th>
                                    <th>سبب السلفة/التسديد</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="advancesTableBody">
                                <!-- سيتم ملؤها بالبيانات من JavaScript -->
                            </tbody>
                        </table>
                        <div id="noAdvances" class="empty-message">
                            <i class="fas fa-hand-holding-usd"></i>
                            <p>لا يوجد سلف مسجلة بعد. قم بإضافة سلفة جديدة.</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- شاشة التقارير -->
            <section id="reports" class="content-section">
                <h2 class="section-title"><i class="fas fa-chart-bar"></i> تقارير ربحية الفواتير</h2>
                
                <div class="date-filter">
                    <div>
                        <label for="reportFromDate">من تاريخ</label>
                        <input type="date" id="reportFromDate">
                    </div>
                    <div>
                        <label for="reportToDate">إلى تاريخ</label>
                        <input type="date" id="reportToDate">
                    </div>
                    <button id="filterReportBtn" class="btn">
                        <i class="fas fa-filter"></i> تصفية التقارير
                    </button>
                    <button id="resetReportBtn" class="btn">
                        <i class="fas fa-redo"></i> عرض الكل
                    </button>
                </div>
                
                <div class="report-table">
                    <table id="profitReportTable">
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>التاريخ</th>
                                <th>قيمة الفاتورة</th>
                                <th>اسم الفني</th>
                                <th>عمولة الفني</th> 
                                <th>مصروفات الأوردر</th>
                                <th>صافي الربح</th>
                                <th>نسبة الربح</th>
                            </tr>
                        </thead>
                        <tbody id="profitReportTableBody">
                            <!-- سيتم ملؤها بالبيانات من JavaScript -->
                        </tbody>
                    </table>
                    <div id="noReportData" class="empty-message">
                        <i class="fas fa-chart-line"></i>
                        <p>لا توجد بيانات لتقرير الربحية. قم بإضافة فواتير ومصروفات أولاً.</p>
                    </div>
                </div>
                
                <div style="margin-top: 40px;">
                    <h3 class="section-title"><i class="fas fa-chart-bar"></i> تقرير مجمع</h3>
                    <div class="dashboard-cards" id="aggregateReport">
                        <!-- سيتم ملؤها بالبيانات من JavaScript -->
                    </div>
                </div>
            </section>
            
            <!-- مودال تسديد السلفة -->
            <div id="payAdvanceModal" class="modal">
                <div class="modal-content">
                    <h3 class="modal-title"><i class="fas fa-money-bill-wave"></i> تسديد جزء من السلفة</h3>
                    <div class="form-group">
                        <label for="payEmployeeName">اسم الموظف</label>
                        <input type="text" id="payEmployeeName" readonly>
                    </div>
                    <div class="form-group">
                        <label for="payAdvanceAmount">المبلغ المستحق (ج.م)</label>
                        <input type="number" id="payAdvanceAmount" readonly>
                    </div>
                    <div class="form-group">
                        <label for="payAmount">مبلغ التسديد (ج.م) *</label>
                        <input type="number" id="payAmount" min="1" placeholder="أدخل مبلغ التسديد">
                    </div>
                    <div class="form-group">
                        <label for="payDate">تاريخ التسديد</label>
                        <input type="date" id="payDate">
                    </div>
                    <div class="form-group">
                        <label for="payNotes">ملاحظات التسديد</label>
                        <textarea id="payNotes" rows="3" placeholder="ملاحظات حول التسديد"></textarea>
                    </div>
                    <div class="modal-buttons">
                        <button id="confirmPayBtn" class="btn btn-success">
                            <i class="fas fa-check"></i> تأكيد التسديد
                        </button>
                        <button id="cancelPayBtn" class="btn btn-danger">
                            <i class="fas fa-times"></i> إلغاء
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- نافذة تغيير كلمة المرور -->
            <div id="changePasswordModal" class="modal">
                <div class="modal-content">
                    <h3 class="modal-title"><i class="fas fa-key"></i> تغيير كلمة المرور</h3>
                    <div class="form-group">
                        <label for="oldPassword">كلمة المرور القديمة</label>
                        <input type="password" id="oldPassword">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">كلمة المرور الجديدة</label>
                        <input type="password" id="newPassword">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">تأكيد كلمة المرور الجديدة</label>
                        <input type="password" id="confirmPassword">
                    </div>
                    <div class="modal-buttons">
                        <button id="savePasswordBtn" class="btn btn-success">
                            <i class="fas fa-save"></i> حفظ
                        </button>
                        <button id="cancelPasswordBtn" class="btn btn-danger">
                            <i class="fas fa-times"></i> إلغاء
                        </button>
                    </div>
                    <div id="passwordError" style="color: #dc3545; margin-top: 15px; display: none;"></div>
                </div>
            </div>
            
            <footer>
                <p>برنامج إدارة مركز تراست لصيانة الأجهزة المنزلية &copy; 2026 - نظام متكامل للمحاسبة والتقارير</p>
                <p>جميع الحقوق محفوظة</p>
            </footer>
        </div>
        
        <!-- توقيع المطور في التطبيق الرئيسي -->
        <div class="signature-card">
            <div class="name">Yasser Elkhateeb</div>
            <div class="title">مطور البرنامج 01146118541</div>
        </div>
    </div>

    <script>
        // البيانات الافتراضية
        let currentUser = null;
        let editingTechId = null;
        let editingOrderId = null;
        let editingExpenseId = null;
        let editingGeneralExpenseId = null;
        let editingAdvanceId = null;
        let editingUserId = null;
        let editingCustomerId = null;
        let currentPayAdvance = null;
        let backupTimer = null;
        
        // المستخدمون الافتراضيون
        let users = JSON.parse(localStorage.getItem('users')) || [
            {id: 1, name: "Yasser", role: "superAdmin", password: "123"},
            {id: 2, name: "وائل", role: "superAdmin", password: "123"},
            {id: 3, name: "محمد", role: "admin", password: "123"},
            {id: 4, name: "جمال", role: "dataEntry", password: "123"}
        ];
        
        let technicians = JSON.parse(localStorage.getItem('technicians')) || [
            {id: 1, name: "أبو علي", percentage: 15},
            {id: 2, name: "احمد", percentage: 20},
            {id: 3, name: "جمال", percentage: 18}
        ];
        
        let customers = JSON.parse(localStorage.getItem('customers')) || [
            {id: 1, name: "علي محمد", phone: "01012345678", address: "شارع محمد نجيب - سيدي بشر"},
            {id: 2, name: "محمود أحمد", phone: "01087654321", address: "شارع 45 - العصافرة"},
            {id: 3, name: "سعيد جمال", phone: "01055556666", address: "فيكتوريا - شارع سيبوية"}
        ];
        
        let orders = JSON.parse(localStorage.getItem('orders')) || [
            {id: 1, orderNumber: "ORD-001", date: "2025-12-01", customerName: "علي محمد", customerPhone: "01012345678", customerAddress: "شارع محمد نجيب - سيدي بشر", technicianId: 1, repairType: "ثلاجة وتكييف", amount: 5500, description: "صيانة ثلاجة"},
            {id: 2, orderNumber: "ORD-002", date: "2025-12-05", customerName: "محمود أحمد", customerPhone: "01087654321", customerAddress: "شارع 45 - العصافرة", technicianId: 2, repairType: "تكييف", amount: 2800, description: "صيانة تكييف"},
            {id: 3, orderNumber: "ORD-003", date: "2025-12-10", customerName: "سعيد جمال", customerPhone: "01055556666", customerAddress: "فيكتوريا - شارع سيبوية", technicianId: 3, repairType: "أجهزة منزلية", amount: 2300, description: "صيانة غسالة"}
        ];
        
        let orderExpenses = JSON.parse(localStorage.getItem('orderExpenses')) || [
            {id: 1, orderNumber: "ORD-001", date: "2025-12-01", parts: 100, transport: 50, other: 0, description: "شراء قطع غيار للثلاجة ومواصلات"},
            {id: 2, orderNumber: "ORD-002", date: "2025-12-05", parts: 200, transport: 0, other: 0, description: "شراء قطع غيار للتكييف"}
        ];
        
        let generalExpenses = JSON.parse(localStorage.getItem('generalExpenses')) || [
            {id: 1, date: "2025-12-01", type: "ايجار المركز", amount: 2000, description: "ايجار مركز الصيانة"},
            {id: 2, date: "2025-12-01", type: "الرواتب", amount: 5000, description: "رواتب الموظفين"},
            {id: 3, date: "2025-12-05", type: "النظافة", amount: 300, description: "مصاريف نظافة المركز"}
        ];
        
        let advances = JSON.parse(localStorage.getItem('advances')) || [
            {id: 1, employee: "أبو علي", date: "2025-12-01", amount: 500, reason: "سلفة شهرية", type: "سلفة"},
            {id: 2, employee: "احمد", date: "2025-12-05", amount: 300, reason: "مصاريف علاج", type: "سلفة"},
            {id: 3, employee: "أبو علي", date: "2025-12-10", amount: 200, reason: "تسديد جزء من السلفة", type: "تسديد"}
        ];
        
        // النسخ الاحتياطية
        let backups = JSON.parse(localStorage.getItem('backups')) || [];
        
        // حفظ البيانات في localStorage
        function saveData() {
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('technicians', JSON.stringify(technicians));
            localStorage.setItem('customers', JSON.stringify(customers));
            localStorage.setItem('orders', JSON.stringify(orders));
            localStorage.setItem('orderExpenses', JSON.stringify(orderExpenses));
            localStorage.setItem('generalExpenses', JSON.stringify(generalExpenses));
            localStorage.setItem('advances', JSON.stringify(advances));
            localStorage.setItem('backups', JSON.stringify(backups));
        }
        
        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            // تعيين التواريخ الحالية
            const today = new Date().toISOString().split('T')[0];
            const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
            
            // تعيين التواريخ في التطبيق الرئيسي (عند التحميل)
            if (document.getElementById('orderDate')) {
                document.getElementById('orderDate').value = today;
                document.getElementById('expenseDate').value = today;
                document.getElementById('generalExpenseDate').value = today;
                document.getElementById('advanceDate').value = today;
                document.getElementById('payDate').value = today;
                document.getElementById('summaryFromDate').value = firstDayOfMonth;
                document.getElementById('summaryToDate').value = today;
                document.getElementById('reportFromDate').value = firstDayOfMonth;
                document.getElementById('reportToDate').value = today;
                document.getElementById('advanceFromDate').value = firstDayOfMonth;
                document.getElementById('advanceToDate').value = today;
            }
            
            // إضافة المستمعين للأحداث
            setupEventListeners();
            
            // بدء النسخ الاحتياطي التلقائي
            startAutoBackup();
        });
        
        // الحصول على اسم الدور
        function getRoleName(role, userName) {
            switch(role) {
                case 'superAdmin': 
                    if (userName === "Yasser") {
                        return "مطور النظام";
                    }
                    return 'المدير العام';
                case 'admin': return 'مشرف';
                case 'dataEntry': return 'مدخل بيانات';
                default: return role;
            }
        }
        
        // إعداد المستمعين للأحداث
        function setupEventListeners() {
            // تسجيل الدخول
            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
                        
            // تسجيل الخروج
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // تغيير كلمة المرور
            document.getElementById('changePasswordBtn').addEventListener('click', showChangePasswordModal);
            document.getElementById('cancelPasswordBtn').addEventListener('click', hideChangePasswordModal);
            document.getElementById('savePasswordBtn').addEventListener('click', changePassword);
            
            // التنقل بين الأقسام
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.classList.contains('disabled')) return;
                    
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(this.dataset.section).classList.add('active');
                });
            });
            
            // إدارة الفنيين
            if (document.getElementById('addTechBtn')) {
                document.getElementById('addTechBtn').addEventListener('click', addTechnician);
                document.getElementById('updateTechBtn').addEventListener('click', updateTechnician);
                document.getElementById('cancelTechBtn').addEventListener('click', cancelEditTechnician);
            }
            
            // إدارة المستخدمين
            if (document.getElementById('addUserBtn')) {
                document.getElementById('addUserBtn').addEventListener('click', addUser);
                document.getElementById('updateUserBtn').addEventListener('click', updateUser);
                document.getElementById('cancelUserBtn').addEventListener('click', cancelEditUser);
            }
            
            // إدارة العملاء
            if (document.getElementById('saveCustomerBtn')) {
                document.getElementById('saveCustomerBtn').addEventListener('click', saveCustomer);
                document.getElementById('updateCustomerBtn').addEventListener('click', updateCustomer);
                document.getElementById('cancelCustomerBtn').addEventListener('click', cancelEditCustomer);
                document.getElementById('searchCustomers').addEventListener('input', searchCustomers);
            }
            
            // إدارة الفواتير
            if (document.getElementById('saveOrderBtn')) {
                document.getElementById('saveOrderBtn').addEventListener('click', saveOrder);
                document.getElementById('updateOrderBtn').addEventListener('click', updateOrder);
                document.getElementById('cancelOrderBtn').addEventListener('click', cancelEditOrder);
                document.getElementById('searchOrders').addEventListener('input', searchOrders);
                document.getElementById('customerPhone').addEventListener('blur', fillCustomerInfo);
                document.getElementById('customerPhone').addEventListener('input', function() {
                    if (this.value.trim() === '') {
                        document.getElementById('customerAutofill').classList.remove('show');
                    }
                });
            }
            
            // إدارة مصروفات الأوردر
            if (document.getElementById('saveExpenseBtn')) {
                document.getElementById('saveExpenseBtn').addEventListener('click', saveOrderExpense);
                document.getElementById('updateExpenseBtn').addEventListener('click', updateOrderExpense);
                document.getElementById('cancelExpenseBtn').addEventListener('click', cancelEditExpense);
            }
            
            // إدارة المصروفات العامة
            if (document.getElementById('saveGeneralExpenseBtn')) {
                document.getElementById('saveGeneralExpenseBtn').addEventListener('click', saveGeneralExpense);
                document.getElementById('updateGeneralExpenseBtn').addEventListener('click', updateGeneralExpense);
                document.getElementById('cancelGeneralExpenseBtn').addEventListener('click', cancelEditGeneralExpense);
            }
            
            // إدارة السلف
            if (document.getElementById('saveAdvanceBtn')) {
                document.getElementById('saveAdvanceBtn').addEventListener('click', saveAdvance);
                document.getElementById('updateAdvanceBtn').addEventListener('click', updateAdvance);
                document.getElementById('cancelAdvanceBtn').addEventListener('click', cancelEditAdvance);
                document.getElementById('filterAdvancesBtn').addEventListener('click', loadAdvances);
                document.getElementById('resetAdvancesBtn').addEventListener('click', function() {
                    document.getElementById('advanceEmployeeFilter').value = '';
                    document.getElementById('advanceFromDate').value = '';
                    document.getElementById('advanceToDate').value = '';
                    loadAdvances();
                });
            }
            
            // تسديد السلفة
            if (document.getElementById('cancelPayBtn')) {
                document.getElementById('cancelPayBtn').addEventListener('click', hidePayAdvanceModal);
                document.getElementById('confirmPayBtn').addEventListener('click', confirmPayAdvance);
            }
            
            // النسخ الاحتياطي
            if (document.getElementById('createBackupBtn')) {
                document.getElementById('createBackupBtn').addEventListener('click', createManualBackup);
                document.getElementById('restoreLastBackupBtn').addEventListener('click', restoreLastBackup);
            }
            
            // التقارير
            if (document.getElementById('filterReportBtn')) {
                document.getElementById('filterReportBtn').addEventListener('click', loadProfitReport);
                document.getElementById('resetReportBtn').addEventListener('click', function() {
                    document.getElementById('reportFromDate').value = '';
                    document.getElementById('reportToDate').value = '';
                    loadProfitReport();
                });
            }
            
            // ملخص العمليات في لوحة التحكم
            if (document.getElementById('filterSummaryBtn')) {
                document.getElementById('filterSummaryBtn').addEventListener('click', loadDashboard);
                document.getElementById('resetSummaryBtn').addEventListener('click', function() {
                    const today = new Date();
                    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                    
                    document.getElementById('summaryFromDate').value = firstDayOfMonth;
                    document.getElementById('summaryToDate').value = new Date().toISOString().split('T')[0];
                    loadDashboard();
                });
            }
        }
        
        // تسجيل الدخول
        function login() {
            const userId = document.getElementById('loginUser').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!userId) {
                showLoginError('الرجاء اختيار مستخدم');
                return;
            }
            
            const user = users.find(u => u.id == userId);
            
            if (user && user.password === password) {
                currentUser = user;
                
                // تغيير فئة body لإظهار التطبيق الرئيسي
                document.body.classList.remove('login-screen');
                document.body.classList.add('app-screen');
                
                // تحديث معلومات المستخدم
                document.getElementById('currentUserName').textContent = `مرحباً ${user.name}`;
// إخفاء عنصر الدور بالكامل
document.getElementById('currentUserRole').style.display = 'none';                // تحميل البيانات بناءً على صلاحيات المستخدم
                loadDataBasedOnRole();
                applyUserPermissions();
                
                // إخفاء توقيع المطور في شاشة الدخول
                document.querySelector('.signature-card-login').style.display = 'none';
            } else {
                showLoginError('كلمة المرور غير صحيحة');
            }
        }
        
        // إظهار خطأ تسجيل الدخول
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            errorDiv.style.display = 'block';
            
            // إخفاء الرسالة بعد 3 ثواني
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 3000);
        }
        
        // تسجيل الخروج
        function logout() {
            currentUser = null;
            
            // تغيير فئة body لإظهار شاشة الدخول
            document.body.classList.remove('app-screen');
            document.body.classList.add('login-screen');
            
            // مسح حقل كلمة المرور
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').style.display = 'none';
            
            // إظهار توقيع المطور في شاشة الدخول
            document.querySelector('.signature-card-login').style.display = 'block';
        }
        
        // تطبيق صلاحيات المستخدم
        function applyUserPermissions() {
            if (!currentUser) return;
            
            const role = currentUser.role;
            
            // إخفاء/إظهار الأزرار حسب الصلاحية
            const allEditButtons = document.querySelectorAll('.btn-success, .btn-danger, .edit-btn, .delete-btn, .pay-btn');
            const allUpdateButtons = document.querySelectorAll('#updateTechBtn, #updateUserBtn, #updateOrderBtn, #updateExpenseBtn, #updateGeneralExpenseBtn, #updateAdvanceBtn, #updateCustomerBtn');
            const allCancelButtons = document.querySelectorAll('#cancelTechBtn, #cancelUserBtn, #cancelOrderBtn, #cancelExpenseBtn, #cancelGeneralExpenseBtn, #cancelAdvanceBtn, #cancelCustomerBtn');
            
            // إدارة المستخدمين - مرئية فقط لسوبر أدمن
            const usersManagement = document.getElementById('usersManagement');
            const userManagementButtons = document.querySelectorAll('#addUserBtn, #updateUserBtn, #cancelUserBtn');
            
            // النسخ الاحتياطي - مرئي فقط لسوبر أدمن
            const backupButtons = document.querySelectorAll('#createBackupBtn, #restoreLastBackupBtn');
            
            // إظهار/إخفاء أقسام التنقل
            const dashboardNav = document.getElementById('dashboardNav');
            const customersNav = document.getElementById('customersNav');
            const settingsNav = document.getElementById('settingsNav');
            const reportsNav = document.getElementById('reportsNav');
            const generalExpensesNav = document.getElementById('generalExpensesNav');
            
            if (role === 'superAdmin') {
                // سوبر أدمن: كل الصلاحيات
                if (usersManagement) usersManagement.classList.remove('hidden-by-role');
                userManagementButtons.forEach(btn => {
                    if (btn) btn.classList.remove('hidden-by-role');
                });
                backupButtons.forEach(btn => {
                    if (btn) btn.classList.remove('hidden-by-role');
                });
                allEditButtons.forEach(btn => {
                    if (btn) btn.classList.remove('hidden-by-role');
                });
                allUpdateButtons.forEach(btn => {
                    if (btn) btn.classList.remove('hidden-by-role');
                });
                allCancelButtons.forEach(btn => {
                    if (btn) btn.classList.remove('hidden-by-role');
                });
                
                if (dashboardNav) dashboardNav.classList.remove('disabled');
                if (customersNav) customersNav.classList.remove('disabled');
                if (settingsNav) settingsNav.classList.remove('disabled');
                if (reportsNav) reportsNav.classList.remove('disabled');
                if (generalExpensesNav) generalExpensesNav.classList.remove('disabled');
            } else if (role === 'admin') {
                // أدمن: لا يرى الإعدادات أو التقارير
                if (usersManagement) usersManagement.classList.add('hidden-by-role');
                userManagementButtons.forEach(btn => {
                    if (btn) btn.classList.add('hidden-by-role');
                });
                backupButtons.forEach(btn => {
                    if (btn) btn.classList.add('hidden-by-role');
                });
                allEditButtons.forEach(btn => {
                    if (btn) btn.classList.remove('hidden-by-role');
                });
                allUpdateButtons.forEach(btn => {
                    if (btn) btn.classList.remove('hidden-by-role');
                });
                allCancelButtons.forEach(btn => {
                    if (btn) btn.classList.remove('hidden-by-role');
                });
                
                if (dashboardNav) dashboardNav.classList.remove('disabled');
                if (customersNav) customersNav.classList.remove('disabled');
                if (settingsNav) settingsNav.classList.add('disabled');
                if (reportsNav) reportsNav.classList.add('disabled');
                if (generalExpensesNav) generalExpensesNav.classList.remove('disabled');
                
                // إذا كان في الإعدادات أو التقارير، انتقل إلى لوحة التحكم
                const activeSection = document.querySelector('.content-section.active');
                if (activeSection && ['settings', 'reports'].includes(activeSection.id)) {
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                    if (dashboardNav) {
                        dashboardNav.classList.add('active');
                        document.getElementById('dashboard').classList.add('active');
                    }
                }
            } else if (role === 'dataEntry') {
                // مدخل بيانات: فقط إضافة، لا تعديل ولا حذف ولا تقارير ولا إعدادات
                if (usersManagement) usersManagement.classList.add('hidden-by-role');
                userManagementButtons.forEach(btn => {
                    if (btn) btn.classList.add('hidden-by-role');
                });
                backupButtons.forEach(btn => {
                    if (btn) btn.classList.add('hidden-by-role');
                });
                allEditButtons.forEach(btn => {
                    if (btn) btn.classList.add('hidden-by-role');
                });
                allUpdateButtons.forEach(btn => {
                    if (btn) btn.classList.add('hidden-by-role');
                });
                allCancelButtons.forEach(btn => {
                    if (btn) btn.classList.add('hidden-by-role');
                });
                
                if (dashboardNav) dashboardNav.classList.remove('disabled');
                if (customersNav) customersNav.classList.remove('disabled');
                if (settingsNav) settingsNav.classList.add('disabled');
                if (reportsNav) reportsNav.classList.add('disabled');
                if (generalExpensesNav) generalExpensesNav.classList.add('disabled');
                
                // إظهار أزرار الحفظ فقط
                const saveButtons = [
                    document.getElementById('saveOrderBtn'),
                    document.getElementById('saveExpenseBtn'),
                    document.getElementById('saveCustomerBtn'),
                    document.getElementById('saveGeneralExpenseBtn'),
                    document.getElementById('saveAdvanceBtn')
                ];
                
                saveButtons.forEach(btn => {
                    if (btn) btn.classList.remove('hidden-by-role');
                });
                
                // إذا كان في الإعدادات أو التقارير، انتقل إلى لوحة التحكم
                const activeSection = document.querySelector('.content-section.active');
                if (activeSection && ['settings', 'reports', 'general-expenses'].includes(activeSection.id)) {
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                    if (dashboardNav) {
                        dashboardNav.classList.add('active');
                        document.getElementById('dashboard').classList.add('active');
                    }
                }
            }
        }
        
        // تحميل البيانات بناءً على صلاحيات المستخدم
        function loadDataBasedOnRole() {
            loadTechnicians();
            loadCustomers();
            loadOrders();
            loadOrderExpenses();
            loadGeneralExpenses();
            loadAdvances();
            loadProfitReport();
            loadDashboard();
            
            if (currentUser.role === 'superAdmin') {
                loadUsers();
                loadBackups();
            }
        }
        
        // تحميل لوحة التحكم مع ملخص العمليات
        function loadDashboard() {
            const fromDate = document.getElementById('summaryFromDate') ? document.getElementById('summaryFromDate').value : '';
            const toDate = document.getElementById('summaryToDate') ? document.getElementById('summaryToDate').value : '';
            
            let filteredOrders = orders;
            let filteredOrderExpenses = orderExpenses;
            let filteredGeneralExpenses = generalExpenses;
            
            // تطبيق الفلاتر إذا كانت محددة
            if (fromDate || toDate) {
                const from = fromDate ? new Date(fromDate) : null;
                const to = toDate ? new Date(toDate) : null;
                
                filteredOrders = orders.filter(order => {
                    const orderDate = new Date(order.date);
                    if (from && orderDate < from) return false;
                    if (to && orderDate > to) return false;
                    return true;
                });
                
                filteredOrderExpenses = orderExpenses.filter(exp => {
                    const expDate = new Date(exp.date);
                    if (from && expDate < from) return false;
                    if (to && expDate > to) return false;
                    return true;
                });
                
                filteredGeneralExpenses = generalExpenses.filter(exp => {
                    const expDate = new Date(exp.date);
                    if (from && expDate < from) return false;
                    if (to && expDate > to) return false;
                    return true;
                });
            }
            
            // الإيرادات
            const totalRevenue = filteredOrders.reduce((sum, order) => sum + order.amount, 0);
            
            // مصروفات الأوردر
            const totalOrderExpenses = filteredOrderExpenses.reduce((sum, exp) => {
                return sum + (exp.parts || 0) + (exp.transport || 0) + (exp.other || 0);
            }, 0);
            
            // المصروفات العامة
            const totalGeneralExpenses = filteredGeneralExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const totalExpenses = totalOrderExpenses + totalGeneralExpenses;
            
            // عمولات الفنيين
            let totalTechCommission = 0;
            filteredOrders.forEach(order => {
                const tech = technicians.find(t => t.id === order.technicianId);
                if (tech) {
                    totalTechCommission += order.amount * (tech.percentage / 100);
                }
            });
            
            // صافي الربح
            const netProfit = totalRevenue - totalTechCommission - totalExpenses;
            
            // نسبة الربحية
            const profitPercentage = totalRevenue > 0 ? ((netProfit / totalRevenue) * 100).toFixed(1) : 0;
            
            // السلف
            const totalAdvances = advances
                .filter(adv => adv.type === 'سلفة')
                .reduce((sum, adv) => sum + adv.amount, 0);
            
            const totalPayments = advances
                .filter(adv => adv.type === 'تسديد')
                .reduce((sum, adv) => sum + adv.amount, 0);
            
            const netAdvances = totalAdvances - totalPayments;
            
            // تحديث الفترة المعروضة
            let periodText = '';
            if (fromDate && toDate) {
                periodText = `من ${formatDate(fromDate)} إلى ${formatDate(toDate)}`;
            } else {
                const today = new Date();
                const monthName = today.toLocaleString('ar-EG', { month: 'long' });
                periodText = `لشهر ${monthName}`;
            }
            
            if (document.getElementById('revenuePeriod')) {
                document.getElementById('revenuePeriod').textContent = periodText;
                document.getElementById('ordersPeriod').textContent = periodText;
                document.getElementById('profitPeriod').textContent = periodText;
                document.getElementById('expensesPeriod').textContent = periodText;
                document.getElementById('commissionsPeriod').textContent = periodText;
                document.getElementById('percentagePeriod').textContent = periodText;
                
                // تحديث البيانات في لوحة التحكم
                document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString() + ' ج.م';
                document.getElementById('totalOrders').textContent = filteredOrders.length;
                document.getElementById('netProfit').textContent = netProfit.toLocaleString() + ' ج.م';
                document.getElementById('totalExpenses').textContent = totalExpenses.toLocaleString() + ' ج.م';
                document.getElementById('activeTechnicians').textContent = technicians.length;
                document.getElementById('totalAdvances').textContent = netAdvances.toLocaleString() + ' ج.م';
                document.getElementById('totalCommissions').textContent = totalTechCommission.toLocaleString() + ' ج.م';
                document.getElementById('profitPercentage').textContent = profitPercentage + '%';
                
                // تحديث تفاصيل الملخص
                const detailedSummary = document.getElementById('detailedSummary');
                if (detailedSummary) {
                    detailedSummary.innerHTML = '';
                    
                    const summaryCards = [
                        {
                            title: 'إيرادات الفواتير',
                            value: totalRevenue.toLocaleString() + ' ج.م',
                            description: `من ${filteredOrders.length} فاتورة`
                        },
                        {
                            title: 'مصروفات الأوردر',
                            value: totalOrderExpenses.toLocaleString() + ' ج.م',
                            description: `من ${filteredOrderExpenses.length} مصروف`
                        },
                        {
                            title: 'المصروفات العامة',
                            value: totalGeneralExpenses.toLocaleString() + ' ج.م',
                            description: `من ${filteredGeneralExpenses.length} مصروف`
                        },
                        {
                            title: 'عمولات الفنيين',
                            value: totalTechCommission.toLocaleString() + ' ج.م',
                            description: `${((totalTechCommission / totalRevenue) * 100 || 0).toFixed(1)}% من الإيرادات`
                        }
                    ];
                    
                    summaryCards.forEach(card => {
                        const cardElement = document.createElement('div');
                        cardElement.className = 'card';
                        cardElement.innerHTML = `
                            <h3>${card.title}</h3>
                            <div class="card-value">${card.value}</div>
                            <p>${card.description}</p>
                        `;
                        detailedSummary.appendChild(cardElement);
                    });
                }
                
                // آخر الفواتير (5 فواتير)
                const recentOrders = filteredOrders.slice(-5).reverse();
                const recentOrdersTableBody = document.getElementById('recentOrdersTableBody');
                const noRecentOrders = document.getElementById('noRecentOrders');
                
                if (recentOrdersTableBody && noRecentOrders) {
                    recentOrdersTableBody.innerHTML = '';
                    
                    if (recentOrders.length === 0) {
                        noRecentOrders.style.display = 'block';
                        if (document.getElementById('recentOrdersTable')) {
                            document.getElementById('recentOrdersTable').style.display = 'none';
                        }
                    } else {
                        noRecentOrders.style.display = 'none';
                        if (document.getElementById('recentOrdersTable')) {
                            document.getElementById('recentOrdersTable').style.display = 'table';
                        }
                        
                        recentOrders.forEach(order => {
                            const tech = technicians.find(t => t.id === order.technicianId);
                            const techName = tech ? tech.name : 'غير معروف';
                            
                            const row = recentOrdersTableBody.insertRow();
                            row.innerHTML = `
                                <td>${order.orderNumber}</td>
                                <td>${formatDate(order.date)}</td>
                                <td>${order.customerName}</td>
                                <td>${order.repairType}</td>
                                <td>${order.amount.toLocaleString()} ج.م</td>
                                <td>${techName}</td>
                            `;
                        });
                    }
                }
            }
        }
        
        // تحميل الفنيين
        function loadTechnicians() {
            const techTableBody = document.getElementById('techTableBody');
            const noTechs = document.getElementById('noTechs');
            const technicianSelect = document.getElementById('technician');
            const advanceEmployeeSelect = document.getElementById('advanceEmployee');
            const advanceEmployeeFilter = document.getElementById('advanceEmployeeFilter');
            
            if (techTableBody) techTableBody.innerHTML = '';
            if (technicianSelect) technicianSelect.innerHTML = '<option value="">اختر الفني</option>';
            if (advanceEmployeeSelect) advanceEmployeeSelect.innerHTML = '<option value="">اختر الموظف</option>';
            if (advanceEmployeeFilter) advanceEmployeeFilter.innerHTML = '<option value="">جميع الموظفين</option>';
            
            if (technicians.length === 0) {
                if (noTechs) noTechs.style.display = 'block';
                if (document.getElementById('techTable')) {
                    document.getElementById('techTable').style.display = 'none';
                }
            } else {
                if (noTechs) noTechs.style.display = 'none';
                if (document.getElementById('techTable')) {
                    document.getElementById('techTable').style.display = 'table';
                }
                
                technicians.forEach((tech, index) => {
                    // إضافة إلى الجدول
                    if (techTableBody) {
                        const row = techTableBody.insertRow();
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${tech.name}</td>
                            <td>${tech.percentage}%</td>
                            <td class="action-btns">
                                <button class="action-btn edit-btn" onclick="editTechnician(${tech.id})">
                                    <i class="fas fa-edit"></i> تعديل
                                </button>
                                <button class="action-btn delete-btn" onclick="deleteTechnician(${tech.id})">
                                    <i class="fas fa-trash"></i> حذف
                                </button>
                            </td>
                        `;
                    }
                    
                    // إضافة إلى القائمة المنسدلة للفواتير
                    if (technicianSelect) {
                        const option = document.createElement('option');
                        option.value = tech.id;
                        option.textContent = `${tech.name} (${tech.percentage}%)`;
                        technicianSelect.appendChild(option);
                    }
                    
                    // إضافة إلى القائمة المنسدلة للسلف
                    if (advanceEmployeeSelect) {
                        const option2 = document.createElement('option');
                        option2.value = tech.name;
                        option2.textContent = tech.name;
                        advanceEmployeeSelect.appendChild(option2);
                    }
                    
                    // إضافة إلى فلتر السلف
                    if (advanceEmployeeFilter) {
                        const option3 = document.createElement('option');
                        option3.value = tech.name;
                        option3.textContent = tech.name;
                        advanceEmployeeFilter.appendChild(option3);
                    }
                });
            }
            
            // تحديث قائمة الفواتير في شاشة المصروفات
            updateOrderNumberSelect();
        }
        
        // إضافة فني جديد
        function addTechnician() {
            const nameInput = document.getElementById('techName');
            const percentageInput = document.getElementById('techPercentage');
            
            if (!nameInput || !percentageInput) return;
            
            const name = nameInput.value.trim();
            const percentage = parseInt(percentageInput.value);
            
            if (!name || isNaN(percentage) || percentage < 0 || percentage > 100) {
                alert('الرجاء إدخال اسم فني ونسبة صحيحة بين 0 و 100');
                return;
            }
            
            const newId = technicians.length > 0 ? Math.max(...technicians.map(t => t.id)) + 1 : 1;
            
            technicians.push({
                id: newId,
                name: name,
                percentage: percentage
            });
            
            saveData();
            loadTechnicians();
            loadDashboard();
            
            // مسح الحقول
            nameInput.value = '';
            percentageInput.value = '';
        }
        
        // تعديل فني
        function editTechnician(id) {
            const tech = technicians.find(t => t.id === id);
            if (tech) {
                if (document.getElementById('techName')) {
                    document.getElementById('techName').value = tech.name;
                    document.getElementById('techPercentage').value = tech.percentage;
                    
                    editingTechId = id;
                    
                    // إظهار أزرار التحديث والإلغاء
                    if (document.getElementById('addTechBtn')) {
                        document.getElementById('addTechBtn').classList.add('hidden-by-role');
                        document.getElementById('updateTechBtn').classList.remove('hidden-by-role');
                        document.getElementById('cancelTechBtn').classList.remove('hidden-by-role');
                    }
                }
            }
        }
        
        // تحديث فني
        function updateTechnician() {
            if (!editingTechId) return;
            
            const nameInput = document.getElementById('techName');
            const percentageInput = document.getElementById('techPercentage');
            
            if (!nameInput || !percentageInput) return;
            
            const name = nameInput.value.trim();
            const percentage = parseInt(percentageInput.value);
            
            if (!name || isNaN(percentage) || percentage < 0 || percentage > 100) {
                alert('الرجاء إدخال اسم فني ونسبة صحيحة بين 0 و 100');
                return;
            }
            
            const techIndex = technicians.findIndex(t => t.id === editingTechId);
            if (techIndex !== -1) {
                technicians[techIndex].name = name;
                technicians[techIndex].percentage = percentage;
                
                saveData();
                loadTechnicians();
                loadOrders();
                loadAdvances();
                loadDashboard();
                
                // مسح الحقول وإعادة الحالة
                cancelEditTechnician();
            }
        }
        
        // إلغاء تعديل فني
        function cancelEditTechnician() {
            editingTechId = null;
            if (document.getElementById('techName')) {
                document.getElementById('techName').value = '';
                document.getElementById('techPercentage').value = '';
                
                if (document.getElementById('addTechBtn')) {
                    document.getElementById('addTechBtn').classList.remove('hidden-by-role');
                    document.getElementById('updateTechBtn').classList.add('hidden-by-role');
                    document.getElementById('cancelTechBtn').classList.add('hidden-by-role');
                }
            }
        }
        
        // حذف فني
        function deleteTechnician(id) {
            if (confirm('هل أنت متأكد من حذف هذا الفني؟')) {
                technicians = technicians.filter(tech => tech.id !== id);
                saveData();
                loadTechnicians();
                loadOrders();
                loadAdvances();
                loadDashboard();
            }
        }
        
        // تحميل العملاء
        function loadCustomers() {
            const customersList = document.getElementById('customersList');
            if (!customersList) return;
            
            customersList.innerHTML = '';
            
            if (customers.length === 0) {
                customersList.innerHTML = `
                    <div class="empty-message">
                        <i class="fas fa-users"></i>
                        <p>لا يوجد عملاء مسجلين بعد. قم بإضافة عميل جديد.</p>
                    </div>
                `;
            } else {
                customers.forEach(customer => {
                    const customerCard = document.createElement('div');
                    customerCard.className = 'customer-card';
                    customerCard.innerHTML = `
                        <div class="customer-info">
                            <div class="customer-info-item">
                                <div class="customer-info-label">اسم العميل</div>
                                <div class="customer-info-value">${customer.name}</div>
                            </div>
                            <div class="customer-info-item">
                                <div class="customer-info-label">رقم الهاتف</div>
                                <div class="customer-info-value">${customer.phone}</div>
                            </div>
                            <div class="customer-info-item">
                                <div class="customer-info-label">العنوان</div>
                                <div class="customer-info-value">${customer.address || '-'}</div>
                            </div>
                        </div>
                        <div class="action-btns">
                            <button class="action-btn edit-btn" onclick="editCustomer(${customer.id})">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteCustomer(${customer.id})">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    `;
                    customersList.appendChild(customerCard);
                });
            }
        }
        
        // البحث في العملاء
        function searchCustomers() {
            const searchText = document.getElementById('searchCustomers').value.toLowerCase();
            const customerCards = document.querySelectorAll('.customer-card');
            let found = false;
            
            customerCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                if (text.includes(searchText)) {
                    card.style.display = '';
                    found = true;
                } else {
                    card.style.display = 'none';
                }
            });
            
            // إظهار رسالة إذا لم يتم العثور على نتائج
            const customersList = document.getElementById('customersList');
            const noResultsMsg = customersList.querySelector('.no-results');
            if (!found && searchText) {
                if (!noResultsMsg) {
                    const msg = document.createElement('div');
                    msg.className = 'empty-message no-results';
                    msg.innerHTML = `
                        <i class="fas fa-search"></i>
                        <p>لا توجد نتائج للبحث "${searchText}"</p>
                    `;
                    customersList.appendChild(msg);
                }
            } else if (noResultsMsg) {
                noResultsMsg.remove();
            }
        }
        
        // حفظ عميل جديد
        function saveCustomer() {
            const nameInput = document.getElementById('customerNameInput');
            const phoneInput = document.getElementById('customerPhoneInput');
            const addressInput = document.getElementById('customerAddressInput');
            
            if (!nameInput || !phoneInput || !addressInput) return;
            
            const name = nameInput.value.trim();
            const phone = phoneInput.value.trim();
            const address = addressInput.value.trim();
            
            if (!name || !phone) {
                alert('الرجاء إدخال اسم العميل ورقم الهاتف');
                return;
            }
            
            // التحقق من عدم تكرار رقم الهاتف
            if (customers.some(customer => customer.phone === phone)) {
                alert('رقم الهاتف موجود مسبقاً. الرجاء استخدام رقم هاتف مختلف.');
                return;
            }
            
            const newId = customers.length > 0 ? Math.max(...customers.map(c => c.id)) + 1 : 1;
            
            customers.push({
                id: newId,
                name: name,
                phone: phone,
                address: address
            });
            
            saveData();
            loadCustomers();
            
            // مسح الحقول
            nameInput.value = '';
            phoneInput.value = '';
            addressInput.value = '';
        }
        
        // تعديل عميل
        function editCustomer(id) {
            const customer = customers.find(c => c.id === id);
            if (customer) {
                if (document.getElementById('customerNameInput')) {
                    document.getElementById('customerNameInput').value = customer.name;
                    document.getElementById('customerPhoneInput').value = customer.phone;
                    document.getElementById('customerAddressInput').value = customer.address || '';
                    
                    editingCustomerId = id;
                    
                    // إظهار أزرار التحديث والإلغاء
                    if (document.getElementById('saveCustomerBtn')) {
                        document.getElementById('saveCustomerBtn').classList.add('hidden-by-role');
                        document.getElementById('updateCustomerBtn').classList.remove('hidden-by-role');
                        document.getElementById('cancelCustomerBtn').classList.remove('hidden-by-role');
                    }
                }
            }
        }
        
        // تحديث عميل
        function updateCustomer() {
            if (!editingCustomerId) return;
            
            const nameInput = document.getElementById('customerNameInput');
            const phoneInput = document.getElementById('customerPhoneInput');
            const addressInput = document.getElementById('customerAddressInput');
            
            if (!nameInput || !phoneInput || !addressInput) return;
            
            const name = nameInput.value.trim();
            const phone = phoneInput.value.trim();
            const address = addressInput.value.trim();
            
            if (!name || !phone) {
                alert('الرجاء إدخال اسم العميل ورقم الهاتف');
                return;
            }
            
            // التحقق من عدم تكرار رقم الهاتف (باستثناء العميل الحالي)
            if (customers.some(customer => customer.phone === phone && customer.id !== editingCustomerId)) {
                alert('رقم الهاتف موجود مسبقاً. الرجاء استخدام رقم هاتف مختلف.');
                return;
            }
            
            const customerIndex = customers.findIndex(c => c.id === editingCustomerId);
            if (customerIndex !== -1) {
                customers[customerIndex].name = name;
                customers[customerIndex].phone = phone;
                customers[customerIndex].address = address;
                
                saveData();
                loadCustomers();
                
                // مسح الحقول وإعادة الحالة
                cancelEditCustomer();
            }
        }
        
        // إلغاء تعديل عميل
        function cancelEditCustomer() {
            editingCustomerId = null;
            if (document.getElementById('customerNameInput')) {
                document.getElementById('customerNameInput').value = '';
                document.getElementById('customerPhoneInput').value = '';
                document.getElementById('customerAddressInput').value = '';
                
                if (document.getElementById('saveCustomerBtn')) {
                    document.getElementById('saveCustomerBtn').classList.remove('hidden-by-role');
                    document.getElementById('updateCustomerBtn').classList.add('hidden-by-role');
                    document.getElementById('cancelCustomerBtn').classList.add('hidden-by-role');
                }
            }
        }
        
        // حذف عميل
        function deleteCustomer(id) {
            if (confirm('هل أنت متأكد من حذف هذا العميل؟')) {
                customers = customers.filter(customer => customer.id !== id);
                saveData();
                loadCustomers();
                loadOrders();
            }
        }
        
        // ملء بيانات العميل تلقائياً عند إدخال رقم الهاتف
        function fillCustomerInfo() {
            const phone = document.getElementById('customerPhone') ? document.getElementById('customerPhone').value.trim() : '';
            const autofillDiv = document.getElementById('customerAutofill');
            const nameInput = document.getElementById('customerName');
            const addressInput = document.getElementById('customerAddress');
            
            if (!phone || !autofillDiv || !nameInput || !addressInput) return;
            
            if (!phone) {
                autofillDiv.classList.remove('show');
                return;
            }
            
            // البحث عن العميل بالرقم
            const customer = customers.find(c => c.phone === phone);
            
            if (customer) {
                // ملء البيانات تلقائياً
                nameInput.value = customer.name;
                addressInput.value = customer.address || '';
                
                // إظهار بيانات العميل
                document.getElementById('autofillName').textContent = customer.name;
                document.getElementById('autofillAddress').textContent = customer.address || '-';
                autofillDiv.classList.add('show');
            } else {
                // مسح الحقول إذا لم يتم العثور على العميل
                nameInput.value = '';
                addressInput.value = '';
                autofillDiv.classList.remove('show');
            }
        }
        
        // تحميل الفواتير
        function loadOrders() {
            const ordersTableBody = document.getElementById('ordersTableBody');
            const noOrders = document.getElementById('noOrders');
            
            if (!ordersTableBody || !noOrders) return;
            
            ordersTableBody.innerHTML = '';
            
            if (orders.length === 0) {
                noOrders.style.display = 'block';
                if (document.getElementById('ordersTable')) {
                    document.getElementById('ordersTable').style.display = 'none';
                }
            } else {
                noOrders.style.display = 'none';
                if (document.getElementById('ordersTable')) {
                    document.getElementById('ordersTable').style.display = 'table';
                }
                
                orders.forEach(order => {
                    const tech = technicians.find(t => t.id === order.technicianId);
                    const techName = tech ? tech.name : 'غير معروف';
                    
                    const row = ordersTableBody.insertRow();
                    row.innerHTML = `
                        <td>${order.orderNumber}</td>
                        <td>${formatDate(order.date)}</td>
                        <td>${order.customerName}</td>
                        <td>${order.customerPhone}</td>
                        <td>${order.customerAddress || '-'}</td>
                        <td>${order.repairType}</td>
                        <td>${order.amount.toLocaleString()} ج.م</td>
                        <td>${techName}</td>
                        <td class="action-btns">
                            <button class="action-btn edit-btn ${currentUser && currentUser.role === 'dataEntry' ? 'hidden-by-role' : ''}" onclick="editOrder(${order.id})">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="action-btn delete-btn ${currentUser && currentUser.role === 'dataEntry' ? 'hidden-by-role' : ''}" onclick="deleteOrder(${order.id})">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </td>
                    `;
                });
            }
            
            // تحديث قائمة الفواتير في شاشة المصروفات
            updateOrderNumberSelect();
        }
        
        // البحث في الفواتير
        function searchOrders() {
            const searchText = document.getElementById('searchOrders').value.toLowerCase();
            const rows = document.querySelectorAll('#ordersTableBody tr');
            let found = false;
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchText)) {
                    row.style.display = '';
                    found = true;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // إظهار/إخفاء رسالة عدم وجود نتائج
            const noResults = document.getElementById('noOrders');
            const table = document.getElementById('ordersTable');
            
            if (!found && searchText) {
                if (noResults) {
                    noResults.style.display = 'block';
                    noResults.innerHTML = `
                        <i class="fas fa-search"></i>
                        <p>لا توجد نتائج للبحث "${searchText}"</p>
                    `;
                }
                if (table) table.style.display = 'none';
            } else if (found) {
                if (noResults) noResults.style.display = 'none';
                if (table) table.style.display = 'table';
            }
        }
        
        // حفظ فاتورة جديدة
        function saveOrder() {
            const orderNumber = document.getElementById('orderNumber') ? document.getElementById('orderNumber').value.trim() : '';
            const orderDate = document.getElementById('orderDate') ? document.getElementById('orderDate').value : '';
            const customerPhone = document.getElementById('customerPhone') ? document.getElementById('customerPhone').value.trim() : '';
            const customerName = document.getElementById('customerName') ? document.getElementById('customerName').value.trim() : '';
            const customerAddress = document.getElementById('customerAddress') ? document.getElementById('customerAddress').value.trim() : '';
            const technicianId = document.getElementById('technician') ? parseInt(document.getElementById('technician').value) : 0;
            const repairType = document.getElementById('repairType') ? document.getElementById('repairType').value : '';
            const orderAmount = document.getElementById('orderAmount') ? parseInt(document.getElementById('orderAmount').value) : 0;
            const orderDescription = document.getElementById('orderDescription') ? document.getElementById('orderDescription').value.trim() : '';
            
            if (!orderNumber || !orderDate || !customerPhone || !customerName || !technicianId || !repairType || isNaN(orderAmount) || orderAmount <= 0) {
                alert('الرجاء ملء جميع الحقول المطلوبة بشكل صحيح');
                return;
            }
            
            // التحقق من عدم تكرار رقم الفاتورة
            if (orders.some(order => order.orderNumber === orderNumber)) {
                alert('رقم الفاتورة موجود مسبقاً. الرجاء استخدام رقم فاتورة مختلف.');
                return;
            }
            
            // حفظ العميل إذا كان جديداً
            if (!customers.some(c => c.phone === customerPhone)) {
                const newCustomerId = customers.length > 0 ? Math.max(...customers.map(c => c.id)) + 1 : 1;
                customers.push({
                    id: newCustomerId,
                    name: customerName,
                    phone: customerPhone,
                    address: customerAddress
                });
                saveData();
                loadCustomers();
            }
            
            const newId = orders.length > 0 ? Math.max(...orders.map(o => o.id)) + 1 : 1;
            
            orders.push({
                id: newId,
                orderNumber: orderNumber,
                date: orderDate,
                customerName: customerName,
                customerPhone: customerPhone,
                customerAddress: customerAddress,
                technicianId: technicianId,
                repairType: repairType,
                amount: orderAmount,
                description: orderDescription
            });
            
            saveData();
            loadOrders();
            loadDashboard();
            
            // مسح الحقول
            clearOrderForm();
        }
        
        // مسح نموذج الفاتورة
        function clearOrderForm() {
            if (document.getElementById('orderNumber')) {
                document.getElementById('orderNumber').value = '';
                document.getElementById('customerPhone').value = '';
                document.getElementById('customerName').value = '';
                document.getElementById('customerAddress').value = '';
                document.getElementById('technician').value = '';
                document.getElementById('repairType').value = 'ثلاجة وتكييف';
                document.getElementById('orderAmount').value = '';
                document.getElementById('orderDescription').value = '';
                
                const autofillDiv = document.getElementById('customerAutofill');
                if (autofillDiv) autofillDiv.classList.remove('show');
            }
        }
        
        // تحميل مصروفات الأوردر
        function loadOrderExpenses() {
            const expensesTableBody = document.getElementById('expensesTableBody');
            const noExpenses = document.getElementById('noExpenses');
            
            if (!expensesTableBody || !noExpenses) return;
            
            expensesTableBody.innerHTML = '';
            
            if (orderExpenses.length === 0) {
                noExpenses.style.display = 'block';
                if (document.getElementById('expensesTable')) {
                    document.getElementById('expensesTable').style.display = 'none';
                }
            } else {
                noExpenses.style.display = 'none';
                if (document.getElementById('expensesTable')) {
                    document.getElementById('expensesTable').style.display = 'table';
                }
                
                orderExpenses.forEach(expense => {
                    const total = (expense.parts || 0) + (expense.transport || 0) + (expense.other || 0);
                    
                    const row = expensesTableBody.insertRow();
                    row.innerHTML = `
                        <td>${expense.orderNumber}</td>
                        <td>${formatDate(expense.date)}</td>
                        <td>${(expense.parts || 0).toLocaleString()} ج.م</td>
                        <td>${(expense.transport || 0).toLocaleString()} ج.م</td>
                        <td>${(expense.other || 0).toLocaleString()} ج.م</td>
                        <td>${total.toLocaleString()} ج.م</td>
                        <td>${expense.description}</td>
                        <td class="action-btns">
                            <button class="action-btn edit-btn ${currentUser && currentUser.role === 'dataEntry' ? 'hidden-by-role' : ''}" onclick="editOrderExpense(${expense.id})">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="action-btn delete-btn ${currentUser && currentUser.role === 'dataEntry' ? 'hidden-by-role' : ''}" onclick="deleteOrderExpense(${expense.id})">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </td>
                    `;
                });
            }
        }
        
        // حفظ مصروف أوردر جديد
        function saveOrderExpense() {
            const orderNumber = document.getElementById('expenseOrderNumber') ? document.getElementById('expenseOrderNumber').value : '';
            const expenseDate = document.getElementById('expenseDate') ? document.getElementById('expenseDate').value : '';
            const partsExpense = document.getElementById('partsExpense') ? parseInt(document.getElementById('partsExpense').value) || 0 : 0;
            const transportExpense = document.getElementById('transportExpense') ? parseInt(document.getElementById('transportExpense').value) || 0 : 0;
            const otherExpense = document.getElementById('otherExpense') ? parseInt(document.getElementById('otherExpense').value) || 0 : 0;
            const expenseDescription = document.getElementById('expenseDescription') ? document.getElementById('expenseDescription').value.trim() : '';
            
            if (!orderNumber || !expenseDate || (partsExpense === 0 && transportExpense === 0 && otherExpense === 0)) {
                alert('الرجاء ملء جميع الحقول المطلوبة بشكل صحيح');
                return;
            }
            
            const newId = orderExpenses.length > 0 ? Math.max(...orderExpenses.map(e => e.id)) + 1 : 1;
            
            orderExpenses.push({
                id: newId,
                orderNumber: orderNumber,
                date: expenseDate,
                parts: partsExpense,
                transport: transportExpense,
                other: otherExpense,
                description: expenseDescription
            });
            
            saveData();
            loadOrderExpenses();
            loadDashboard();
            
            // مسح الحقول
            clearExpenseForm();
        }
        
        // مسح نموذج مصروف الأوردر
        function clearExpenseForm() {
            if (document.getElementById('expenseOrderNumber')) {
                document.getElementById('expenseOrderNumber').value = '';
                document.getElementById('partsExpense').value = '';
                document.getElementById('transportExpense').value = '';
                document.getElementById('otherExpense').value = '';
                document.getElementById('expenseDescription').value = '';
            }
        }
        
        // تحميل المصروفات العامة
        function loadGeneralExpenses() {
            const generalExpensesTableBody = document.getElementById('generalExpensesTableBody');
            const noGeneralExpenses = document.getElementById('noGeneralExpenses');
            
            if (!generalExpensesTableBody || !noGeneralExpenses) return;
            
            generalExpensesTableBody.innerHTML = '';
            
            if (generalExpenses.length === 0) {
                noGeneralExpenses.style.display = 'block';
                if (document.getElementById('generalExpensesTable')) {
                    document.getElementById('generalExpensesTable').style.display = 'none';
                }
            } else {
                noGeneralExpenses.style.display = 'none';
                if (document.getElementById('generalExpensesTable')) {
                    document.getElementById('generalExpensesTable').style.display = 'table';
                }
                
                generalExpenses.forEach(expense => {
                    const row = generalExpensesTableBody.insertRow();
                    row.innerHTML = `
                        <td>${formatDate(expense.date)}</td>
                        <td>${expense.type}</td>
                        <td>${expense.amount.toLocaleString()} ج.م</td>
                        <td>${expense.description}</td>
                        <td class="action-btns">
                            <button class="action-btn edit-btn ${currentUser && currentUser.role === 'dataEntry' ? 'hidden-by-role' : ''}" onclick="editGeneralExpense(${expense.id})">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="action-btn delete-btn ${currentUser && currentUser.role === 'dataEntry' ? 'hidden-by-role' : ''}" onclick="deleteGeneralExpense(${expense.id})">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </td>
                    `;
                });
            }
        }
        
        // حفظ مصروف عام جديد
        function saveGeneralExpense() {
            const expenseDate = document.getElementById('generalExpenseDate') ? document.getElementById('generalExpenseDate').value : '';
            const expenseType = document.getElementById('generalExpenseType') ? document.getElementById('generalExpenseType').value : '';
            const expenseAmount = document.getElementById('generalExpenseAmount') ? parseInt(document.getElementById('generalExpenseAmount').value) : 0;
            const expenseDescription = document.getElementById('generalExpenseDescription') ? document.getElementById('generalExpenseDescription').value.trim() : '';
            
            if (!expenseDate || !expenseType || isNaN(expenseAmount) || expenseAmount <= 0) {
                alert('الرجاء ملء جميع الحقول المطلوبة بشكل صحيح');
                return;
            }
            
            const newId = generalExpenses.length > 0 ? Math.max(...generalExpenses.map(e => e.id)) + 1 : 1;
            
            generalExpenses.push({
                id: newId,
                date: expenseDate,
                type: expenseType,
                amount: expenseAmount,
                description: expenseDescription
            });
            
            saveData();
            loadGeneralExpenses();
            loadDashboard();
            
            // مسح الحقول
            clearGeneralExpenseForm();
        }
        
        // مسح نموذج المصروف العام
        function clearGeneralExpenseForm() {
            if (document.getElementById('generalExpenseType')) {
                document.getElementById('generalExpenseType').value = 'ايجار المركز';
                document.getElementById('generalExpenseAmount').value = '';
                document.getElementById('generalExpenseDescription').value = '';
            }
        }
        
        // تحميل السلف
        function loadAdvances() {
            const employeeFilter = document.getElementById('advanceEmployeeFilter') ? document.getElementById('advanceEmployeeFilter').value : '';
            const fromDate = document.getElementById('advanceFromDate') ? document.getElementById('advanceFromDate').value : '';
            const toDate = document.getElementById('advanceToDate') ? document.getElementById('advanceToDate').value : '';
            
            const advancesTableBody = document.getElementById('advancesTableBody');
            const noAdvances = document.getElementById('noAdvances');
            const advanceSummary = document.getElementById('advanceSummary');
            
            if (advancesTableBody) advancesTableBody.innerHTML = '';
            
            // تصفية السلف حسب الموظف والتاريخ
            let filteredAdvances = advances;
            
            if (employeeFilter) {
                filteredAdvances = filteredAdvances.filter(advance => advance.employee === employeeFilter);
            }
            
            if (fromDate || toDate) {
                filteredAdvances = filteredAdvances.filter(advance => {
                    const advanceDate = new Date(advance.date);
                    const from = fromDate ? new Date(fromDate) : null;
                    const to = toDate ? new Date(toDate) : null;
                    
                    if (from && advanceDate < from) return false;
                    if (to && advanceDate > to) return false;
                    
                    return true;
                });
            }
            
            // حساب إجمالي السلف والتسديدات لكل موظف
            const employeeSummary = {};
            filteredAdvances.forEach(advance => {
                if (!employeeSummary[advance.employee]) {
                    employeeSummary[advance.employee] = { totalAdvances: 0, totalPayments: 0, balance: 0 };
                }
                
                if (advance.type === 'سلفة') {
                    employeeSummary[advance.employee].totalAdvances += advance.amount;
                } else if (advance.type === 'تسديد') {
                    employeeSummary[advance.employee].totalPayments += advance.amount;
                }
                
                employeeSummary[advance.employee].balance = employeeSummary[advance.employee].totalAdvances - employeeSummary[advance.employee].totalPayments;
            });
            
            // عرض ملخص الذمة
            if (advanceSummary) {
                let summaryHTML = '<h4>ملخص الذمة للموظفين</h4>';
                
                if (Object.keys(employeeSummary).length === 0) {
                    summaryHTML += '<p>لا توجد بيانات لعرض الملخص.</p>';
                } else {
                    for (const [employee, data] of Object.entries(employeeSummary)) {
                        summaryHTML += `
                            <p><strong>${employee}:</strong> إجمالي السلف: ${data.totalAdvances.toLocaleString()} ج.م | إجمالي التسديدات: ${data.totalPayments.toLocaleString()} ج.م | الرصيد: <span style="color: ${data.balance > 0 ? '#dc3545' : '#1a8c5e'}">${data.balance.toLocaleString()} ج.م</span></p>
                        `;
                    }
                }
                
                advanceSummary.innerHTML = summaryHTML;
            }
            
            if (filteredAdvances.length === 0) {
                if (noAdvances) noAdvances.style.display = 'block';
                if (document.getElementById('advancesTable')) {
                    document.getElementById('advancesTable').style.display = 'none';
                }
            } else {
                if (noAdvances) noAdvances.style.display = 'none';
                if (document.getElementById('advancesTable')) {
                    document.getElementById('advancesTable').style.display = 'table';
                }
                
                filteredAdvances.forEach(advance => {
                    if (advancesTableBody) {
                        const row = advancesTableBody.insertRow();
                        const typeClass = advance.type === 'سلفة' ? 'card-loss' : 'card-profit';
                        const typeText = advance.type === 'سلفة' ? 'سلفة' : 'تسديد';
                        
                        row.innerHTML = `
                            <td>${formatDate(advance.date)}</td>
                            <td>${advance.employee}</td>
                            <td class="${typeClass}">${advance.amount.toLocaleString()} ج.م</td>
                            <td>${typeText}</td>
                            <td>${advance.reason}</td>
                            <td class="action-btns">
                                <button class="action-btn edit-btn ${currentUser && currentUser.role === 'dataEntry' ? 'hidden-by-role' : ''}" onclick="editAdvance(${advance.id})">
                                    <i class="fas fa-edit"></i> تعديل
                                </button>
                                <button class="action-btn delete-btn ${currentUser && currentUser.role === 'dataEntry' ? 'hidden-by-role' : ''}" onclick="deleteAdvance(${advance.id})">
                                    <i class="fas fa-trash"></i> حذف
                                </button>
                                ${advance.type === 'سلفة' ? `<button class="action-btn pay-btn ${currentUser && currentUser.role === 'dataEntry' ? 'hidden-by-role' : ''}" onclick="showPayAdvanceModal('${advance.employee}')">
                                    <i class="fas fa-money-bill-wave"></i> تسديد
                                </button>` : ''}
                            </td>
                        `;
                    }
                });
            }
            
            loadDashboard();
        }
        
        // حفظ سلفة جديدة
        function saveAdvance() {
            const employee = document.getElementById('advanceEmployee') ? document.getElementById('advanceEmployee').value : '';
            const advanceDate = document.getElementById('advanceDate') ? document.getElementById('advanceDate').value : '';
            const advanceAmount = document.getElementById('advanceAmount') ? parseInt(document.getElementById('advanceAmount').value) : 0;
            const advanceReason = document.getElementById('advanceReason') ? document.getElementById('advanceReason').value.trim() : '';
            
            if (!employee || !advanceDate || isNaN(advanceAmount) || advanceAmount <= 0) {
                alert('الرجاء ملء جميع الحقول المطلوبة بشكل صحيح');
                return;
            }
            
            const newId = advances.length > 0 ? Math.max(...advances.map(a => a.id)) + 1 : 1;
            
            advances.push({
                id: newId,
                employee: employee,
                date: advanceDate,
                amount: advanceAmount,
                reason: advanceReason,
                type: 'سلفة'
            });
            
            saveData();
            loadAdvances();
            
            // مسح الحقول
            clearAdvanceForm();
        }
        
        // مسح نموذج السلفة
        function clearAdvanceForm() {
            if (document.getElementById('advanceEmployee')) {
                document.getElementById('advanceEmployee').value = '';
                document.getElementById('advanceAmount').value = '';
                document.getElementById('advanceReason').value = '';
            }
        }
        
        // إظهار مودال تسديد السلفة
        function showPayAdvanceModal(employeeName) {
            // حساب إجمالي السلف والتسديدات للموظف
            const employeeAdvances = advances.filter(a => a.employee === employeeName);
            const totalAdvances = employeeAdvances
                .filter(a => a.type === 'سلفة')
                .reduce((sum, a) => sum + a.amount, 0);
            
            const totalPayments = employeeAdvances
                .filter(a => a.type === 'تسديد')
                .reduce((sum, a) => sum + a.amount, 0);
            
            const balance = totalAdvances - totalPayments;
            
            if (balance <= 0) {
                alert('لا يوجد سلف مستحقة لهذا الموظف');
                return;
            }
            
            currentPayAdvance = employeeName;
            
            if (document.getElementById('payEmployeeName')) {
                document.getElementById('payEmployeeName').value = employeeName;
                document.getElementById('payAdvanceAmount').value = balance;
                document.getElementById('payAmount').value = '';
                document.getElementById('payNotes').value = '';
                document.getElementById('payDate').value = new Date().toISOString().split('T')[0];
                
                document.getElementById('payAdvanceModal').style.display = 'flex';
            }
        }
        
        // إخفاء مودال تسديد السلفة
        function hidePayAdvanceModal() {
            if (document.getElementById('payAdvanceModal')) {
                document.getElementById('payAdvanceModal').style.display = 'none';
                currentPayAdvance = null;
            }
        }
        
        // تأكيد تسديد السلفة
        function confirmPayAdvance() {
            const employeeName = document.getElementById('payEmployeeName') ? document.getElementById('payEmployeeName').value : '';
            const payAmount = document.getElementById('payAmount') ? parseInt(document.getElementById('payAmount').value) : 0;
            const payDate = document.getElementById('payDate') ? document.getElementById('payDate').value : '';
            const payNotes = document.getElementById('payNotes') ? document.getElementById('payNotes').value.trim() : '';
            const balance = document.getElementById('payAdvanceAmount') ? parseInt(document.getElementById('payAdvanceAmount').value) : 0;
            
            if (!payAmount || payAmount <= 0) {
                alert('الرجاء إدخال مبلغ تسديد صحيح');
                return;
            }
            
            if (payAmount > balance) {
                alert('مبلغ التسديد لا يمكن أن يكون أكبر من المبلغ المستحق');
                return;
            }
            
            const newId = advances.length > 0 ? Math.max(...advances.map(a => a.id)) + 1 : 1;
            
            advances.push({
                id: newId,
                employee: employeeName,
                date: payDate,
                amount: payAmount,
                reason: payNotes || 'تسديد جزء من السلفة',
                type: 'تسديد'
            });
            
            saveData();
            loadAdvances();
            hidePayAdvanceModal();
        }
        
        // تحميل التقارير
        function loadProfitReport() {
            const fromDate = document.getElementById('reportFromDate') ? document.getElementById('reportFromDate').value : '';
            const toDate = document.getElementById('reportToDate') ? document.getElementById('reportToDate').value : '';
            
            let filteredOrders = orders;
            let filteredOrderExpenses = orderExpenses;
            
            // تطبيق الفلاتر إذا كانت محددة
            if (fromDate || toDate) {
                const from = fromDate ? new Date(fromDate) : null;
                const to = toDate ? new Date(toDate) : null;
                
                filteredOrders = orders.filter(order => {
                    const orderDate = new Date(order.date);
                    if (from && orderDate < from) return false;
                    if (to && orderDate > to) return false;
                    return true;
                });
                
                filteredOrderExpenses = orderExpenses.filter(exp => {
                    const expDate = new Date(exp.date);
                    if (from && expDate < from) return false;
                    if (to && expDate > to) return false;
                    return true;
                });
            }
            
            const profitReportTableBody = document.getElementById('profitReportTableBody');
            const noReportData = document.getElementById('noReportData');
            const aggregateReport = document.getElementById('aggregateReport');
            
            if (profitReportTableBody) profitReportTableBody.innerHTML = '';
            
            if (filteredOrders.length === 0) {
                if (noReportData) noReportData.style.display = 'block';
                if (document.getElementById('profitReportTable')) {
                    document.getElementById('profitReportTable').style.display = 'none';
                }
                if (aggregateReport) aggregateReport.innerHTML = '';
            } else {
                if (noReportData) noReportData.style.display = 'none';
                if (document.getElementById('profitReportTable')) {
                    document.getElementById('profitReportTable').style.display = 'table';
                }
                
                let totalRevenue = 0;
                let totalCommissions = 0;
                let totalExpenses = 0;
                let totalProfit = 0;
                
                filteredOrders.forEach(order => {
                    const tech = technicians.find(t => t.id === order.technicianId);
                    const techName = tech ? tech.name : 'غير معروف';
                    const techPercentage = tech ? tech.percentage : 0;
                    
                    // حساب مصروفات هذا الأوردر
                    const orderExpenses = filteredOrderExpenses.filter(exp => exp.orderNumber === order.orderNumber);
                    const totalOrderExpenses = orderExpenses.reduce((sum, exp) => {
                        return sum + (exp.parts || 0) + (exp.transport || 0) + (exp.other || 0);
                    }, 0);
                    
                    // حساب العمولة
                    const commission = order.amount * (techPercentage / 100);
                    
                    // حساب الربح
                    const profit = order.amount - commission - totalOrderExpenses;
                    const profitPercentage = order.amount > 0 ? ((profit / order.amount) * 100).toFixed(1) : 0;
                    
                    // تحديث الإجماليات
                    totalRevenue += order.amount;
                    totalCommissions += commission;
                    totalExpenses += totalOrderExpenses;
                    totalProfit += profit;
                    
                    if (profitReportTableBody) {
                        const row = profitReportTableBody.insertRow();
                        row.innerHTML = `
                            <td>${order.orderNumber}</td>
                            <td>${formatDate(order.date)}</td>
                            <td>${order.amount.toLocaleString()} ج.م</td>
                            <td>${techName}</td>
                            <td>${commission.toLocaleString()} ج.م</td>
                            <td>${totalOrderExpenses.toLocaleString()} ج.م</td>
                            <td>${profit.toLocaleString()} ج.م</td>
                            <td>${profitPercentage}%</td>
                        `;
                    }
                });
                
                // تحديث التقرير المجمع
                const overallProfitPercentage = totalRevenue > 0 ? ((totalProfit / totalRevenue) * 100).toFixed(1) : 0;
                
                if (aggregateReport) {
                    aggregateReport.innerHTML = `
                        <div class="card">
                            <h3>إجمالي الإيرادات</h3>
                            <div class="card-value">${totalRevenue.toLocaleString()} ج.م</div>
                            <p>من ${filteredOrders.length} فاتورة</p>
                        </div>
                        <div class="card">
                            <h3>إجمالي العمولات</h3>
                            <div class="card-value">${totalCommissions.toLocaleString()} ج.م</div>
                            <p>${((totalCommissions / totalRevenue) * 100 || 0).toFixed(1)}% من الإيرادات</p>
                        </div>
                        <div class="card">
                            <h3>إجمالي المصروفات</h3>
                            <div class="card-value">${totalExpenses.toLocaleString()} ج.م</div>
                            <p>${((totalExpenses / totalRevenue) * 100 || 0).toFixed(1)}% من الإيرادات</p>
                        </div>
                        <div class="card">
                            <h3>صافي الربح</h3>
                            <div class="card-value card-profit">${totalProfit.toLocaleString()} ج.م</div>
                            <p>نسبة الربحية: ${overallProfitPercentage}%</p>
                        </div>
                    `;
                }
            }
        }
        
        // تحميل المستخدمين
        function loadUsers() {
            const usersTableBody = document.getElementById('usersTableBody');
            const noUsers = document.getElementById('noUsers');
            
            if (!usersTableBody || !noUsers) return;
            
            usersTableBody.innerHTML = '';
            
            if (users.length === 0) {
                noUsers.style.display = 'block';
                if (document.getElementById('usersTable')) {
                    document.getElementById('usersTable').style.display = 'none';
                }
            } else {
                noUsers.style.display = 'none';
                if (document.getElementById('usersTable')) {
                    document.getElementById('usersTable').style.display = 'table';
                }
                
                users.forEach((user, index) => {
                    const row = usersTableBody.insertRow();
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${user.name}</td>
                        <td>${getRoleName(user.role, user.name)}</td>
                        <td>${user.password}</td>
                        <td class="action-btns">
                            <button class="action-btn edit-btn" onclick="editUser(${user.id})">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteUser(${user.id})">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </td>
                    `;
                });
            }
        }
        
        // إضافة مستخدم جديد
        function addUser() {
            const nameInput = document.getElementById('userName');
            const roleInput = document.getElementById('userRole');
            const passwordInput = document.getElementById('userPassword');
            
            if (!nameInput || !roleInput || !passwordInput) return;
            
            const name = nameInput.value.trim();
            const role = roleInput.value;
            const password = passwordInput.value.trim();
            
            if (!name || !role || !password) {
                alert('الرجاء إدخال جميع البيانات المطلوبة');
                return;
            }
            
            const newId = users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1;
            
            users.push({
                id: newId,
                name: name,
                role: role,
                password: password
            });
            
            saveData();
            loadUsers();
            
            // مسح الحقول
            nameInput.value = '';
            roleInput.value = 'superAdmin';
            passwordInput.value = '';
        }
        
        // تعديل مستخدم
        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (user) {
                if (document.getElementById('userName')) {
                    document.getElementById('userName').value = user.name;
                    document.getElementById('userRole').value = user.role;
                    document.getElementById('userPassword').value = user.password;
                    
                    editingUserId = id;
                    
                    // إظهار أزرار التحديث والإلغاء
                    if (document.getElementById('addUserBtn')) {
                        document.getElementById('addUserBtn').classList.add('hidden-by-role');
                        document.getElementById('updateUserBtn').classList.remove('hidden-by-role');
                        document.getElementById('cancelUserBtn').classList.remove('hidden-by-role');
                    }
                }
            }
        }
        
        // تحديث مستخدم
        function updateUser() {
            if (!editingUserId) return;
            
            const nameInput = document.getElementById('userName');
            const roleInput = document.getElementById('userRole');
            const passwordInput = document.getElementById('userPassword');
            
            if (!nameInput || !roleInput || !passwordInput) return;
            
            const name = nameInput.value.trim();
            const role = roleInput.value;
            const password = passwordInput.value.trim();
            
            if (!name || !role || !password) {
                alert('الرجاء إدخال جميع البيانات المطلوبة');
                return;
            }
            
            const userIndex = users.findIndex(u => u.id === editingUserId);
            if (userIndex !== -1) {
                users[userIndex].name = name;
                users[userIndex].role = role;
                users[userIndex].password = password;
                
                saveData();
                loadUsers();
                
                // مسح الحقول وإعادة الحالة
                cancelEditUser();
            }
        }
        
        // إلغاء تعديل مستخدم
        function cancelEditUser() {
            editingUserId = null;
            if (document.getElementById('userName')) {
                document.getElementById('userName').value = '';
                document.getElementById('userRole').value = 'superAdmin';
                document.getElementById('userPassword').value = '';
                
                if (document.getElementById('addUserBtn')) {
                    document.getElementById('addUserBtn').classList.remove('hidden-by-role');
                    document.getElementById('updateUserBtn').classList.add('hidden-by-role');
                    document.getElementById('cancelUserBtn').classList.add('hidden-by-role');
                }
            }
        }
        
        // حذف مستخدم
        function deleteUser(id) {
            if (id === currentUser.id) {
                alert('لا يمكن حذف المستخدم الحالي');
                return;
            }
            
            if (confirm('هل أنت متأكد من حذف هذا المستخدم؟')) {
                users = users.filter(user => user.id !== id);
                saveData();
                loadUsers();
            }
        }
        
        // تحميل النسخ الاحتياطية
        function loadBackups() {
            const backupList = document.getElementById('backupList');
            if (!backupList) return;
            
            backupList.innerHTML = '';
            
            if (backups.length === 0) {
                backupList.innerHTML = '<p>لا توجد نسخ احتياطية بعد.</p>';
            } else {
                backups.forEach(backup => {
                    const backupDate = new Date(backup.date);
                    const dateStr = backupDate.toLocaleString('ar-EG');
                    
                    const backupItem = document.createElement('div');
                    backupItem.className = 'backup-item';
                    backupItem.innerHTML = `
                        <div class="backup-item-info">
                            <div class="backup-item-name">${backup.name}</div>
                            <div class="backup-item-date">${dateStr}</div>
                        </div>
                        <div class="backup-actions">
                            <button class="action-btn edit-btn" onclick="restoreBackup(${backup.id})">
                                <i class="fas fa-history"></i> استعادة
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteBackup(${backup.id})">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    `;
                    backupList.appendChild(backupItem);
                });
            }
        }
        
        // إنشاء نسخة احتياطية يدوية
        function createManualBackup() {
            const timestamp = new Date().getTime();
            const dateStr = new Date().toLocaleString('ar-EG');
            
            const backupData = {
                id: timestamp,
                name: `نسخة يدوية - ${dateStr}`,
                date: new Date().toISOString(),
                data: {
                    users: JSON.parse(JSON.stringify(users)),
                    technicians: JSON.parse(JSON.stringify(technicians)),
                    customers: JSON.parse(JSON.stringify(customers)),
                    orders: JSON.parse(JSON.stringify(orders)),
                    orderExpenses: JSON.parse(JSON.stringify(orderExpenses)),
                    generalExpenses: JSON.parse(JSON.stringify(generalExpenses)),
                    advances: JSON.parse(JSON.stringify(advances))
                }
            };
            
            // إضافة النسخة إلى القائمة
            backups.unshift(backupData);
            
            // الاحتفاظ فقط بآخر 10 نسخ
            if (backups.length > 10) {
                backups = backups.slice(0, 10);
            }
            
            saveData();
            loadBackups();
            
            alert('تم إنشاء نسخة احتياطية بنجاح');
        }
        
        // استعادة آخر نسخة
        function restoreLastBackup() {
            if (backups.length === 0) {
                alert('لا توجد نسخ احتياطية');
                return;
            }
            
            if (confirm('هل أنت متأكد من استعادة آخر نسخة احتياطية؟ سيتم استبدال جميع البيانات الحالية.')) {
                const lastBackup = backups[0];
                restoreBackup(lastBackup.id);
            }
        }
        
        // استعادة نسخة محددة
        function restoreBackup(backupId) {
            const backup = backups.find(b => b.id === backupId);
            if (!backup) return;
            
            if (confirm(`هل أنت متأكد من استعادة النسخة "${backup.name}"؟ سيتم استبدال جميع البيانات الحالية.`)) {
                users = JSON.parse(JSON.stringify(backup.data.users));
                technicians = JSON.parse(JSON.stringify(backup.data.technicians));
                customers = JSON.parse(JSON.stringify(backup.data.customers));
                orders = JSON.parse(JSON.stringify(backup.data.orders));
                orderExpenses = JSON.parse(JSON.stringify(backup.data.orderExpenses));
                generalExpenses = JSON.parse(JSON.stringify(backup.data.generalExpenses));
                advances = JSON.parse(JSON.stringify(backup.data.advances));
                
                saveData();
                loadDataBasedOnRole();
                
                alert('تم استعادة النسخة الاحتياطية بنجاح');
            }
        }
        
        // حذف نسخة احتياطية
        function deleteBackup(id) {
            if (confirm('هل أنت متأكد من حذف هذه النسخة الاحتياطية؟')) {
                backups = backups.filter(backup => backup.id !== id);
                saveData();
                loadBackups();
            }
        }
        
        // إظهار نافذة تغيير كلمة المرور
        function showChangePasswordModal() {
            if (document.getElementById('changePasswordModal')) {
                document.getElementById('changePasswordModal').style.display = 'flex';
            }
        }
        
        // إخفاء نافذة تغيير كلمة المرور
        function hideChangePasswordModal() {
            if (document.getElementById('changePasswordModal')) {
                document.getElementById('changePasswordModal').style.display = 'none';
                document.getElementById('oldPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                const passwordError = document.getElementById('passwordError');
                if (passwordError) passwordError.style.display = 'none';
            }
        }
        
        // تغيير كلمة المرور
        function changePassword() {
            const oldPassword = document.getElementById('oldPassword') ? document.getElementById('oldPassword').value : '';
            const newPassword = document.getElementById('newPassword') ? document.getElementById('newPassword').value : '';
            const confirmPassword = document.getElementById('confirmPassword') ? document.getElementById('confirmPassword').value : '';
            const passwordError = document.getElementById('passwordError');
            
            if (!oldPassword || !newPassword || !confirmPassword) {
                if (passwordError) {
                    passwordError.textContent = 'الرجاء إدخال جميع الحقول';
                    passwordError.style.display = 'block';
                }
                return;
            }
            
            if (oldPassword !== currentUser.password) {
                if (passwordError) {
                    passwordError.textContent = 'كلمة المرور القديمة غير صحيحة';
                    passwordError.style.display = 'block';
                }
                return;
            }
            
            if (newPassword !== confirmPassword) {
                if (passwordError) {
                    passwordError.textContent = 'كلمة المرور الجديدة غير متطابقة';
                    passwordError.style.display = 'block';
                }
                return;
            }
            
            // تحديث كلمة المرور
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex].password = newPassword;
                currentUser.password = newPassword;
                saveData();
                
                alert('تم تغيير كلمة المرور بنجاح');
                hideChangePasswordModal();
            }
        }
        
        // تحديث قائمة أرقام الفواتير في شاشة المصروفات
        function updateOrderNumberSelect() {
            const orderNumberSelect = document.getElementById('expenseOrderNumber');
            if (!orderNumberSelect) return;
            
            orderNumberSelect.innerHTML = '<option value="">اختر رقم الفاتورة</option>';
            
            orders.forEach(order => {
                const option = document.createElement('option');
                option.value = order.orderNumber;
                option.textContent = `${order.orderNumber} (${formatDate(order.date)})`;
                orderNumberSelect.appendChild(option);
            });
        }
        
        // تنسيق التاريخ
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // دالة بدء النسخ الاحتياطي التلقائي
        function startAutoBackup() {
            // إنشاء نسخة أولية عند بدء التشغيل
            createAutoBackup();
            
            // ضبط المؤقت للنسخ كل ساعة (3600000 مللي ثانية)
            backupTimer = setInterval(createAutoBackup, 3600000);
        }
        
        // إنشاء نسخة احتياطية تلقائية
        function createAutoBackup() {
            const timestamp = new Date().getTime();
            const dateStr = new Date().toLocaleString('ar-EG');
            
            const backupData = {
                id: timestamp,
                name: `نسخة تلقائية - ${dateStr}`,
                date: new Date().toISOString(),
                data: {
                    users: JSON.parse(JSON.stringify(users)),
                    technicians: JSON.parse(JSON.stringify(technicians)),
                    customers: JSON.parse(JSON.stringify(customers)),
                    orders: JSON.parse(JSON.stringify(orders)),
                    orderExpenses: JSON.parse(JSON.stringify(orderExpenses)),
                    generalExpenses: JSON.parse(JSON.stringify(generalExpenses)),
                    advances: JSON.parse(JSON.stringify(advances))
                }
            };
            
            // إضافة النسخة إلى القائمة
            backups.unshift(backupData);
            
            // الاحتفاظ فقط بآخر 10 نسخ
            if (backups.length > 10) {
                backups = backups.slice(0, 10);
            }
            
            saveData();
            
            // تحديث قائمة النسخ إذا كانت صفحة الإعدادات مفتوحة
            if (currentUser && currentUser.role === 'superAdmin') {
                loadBackups();
            }
        }
        
        // تعريف الدوال التي تحتاج إلى الوصول من أزرار HTML
        window.fillCustomerInfo = fillCustomerInfo;
        window.editTechnician = editTechnician;
        window.editCustomer = editCustomer;
        window.deleteCustomer = deleteCustomer;
        window.editOrder = function(id) {
            const order = orders.find(o => o.id === id);
            if (order && document.getElementById('orderNumber')) {
                document.getElementById('orderNumber').value = order.orderNumber;
                document.getElementById('orderDate').value = order.date;
                document.getElementById('customerPhone').value = order.customerPhone;
                document.getElementById('customerName').value = order.customerName;
                document.getElementById('customerAddress').value = order.customerAddress || '';
                document.getElementById('technician').value = order.technicianId;
                document.getElementById('repairType').value = order.repairType;
                document.getElementById('orderAmount').value = order.amount;
                document.getElementById('orderDescription').value = order.description;
                
                // إظهار بيانات العميل
                const autofillDiv = document.getElementById('customerAutofill');
                if (autofillDiv) {
                    document.getElementById('autofillName').textContent = order.customerName;
                    document.getElementById('autofillAddress').textContent = order.customerAddress || '-';
                    autofillDiv.classList.add('show');
                }
                
                editingOrderId = id;
                
                // إظهار أزرار التحديث والإلغاء
                if (document.getElementById('saveOrderBtn')) {
                    document.getElementById('saveOrderBtn').classList.add('hidden-by-role');
                    document.getElementById('updateOrderBtn').classList.remove('hidden-by-role');
                    document.getElementById('cancelOrderBtn').classList.remove('hidden-by-role');
                }
            }
        };
        
        window.updateOrder = function() {
            if (!editingOrderId) return;
            
            const orderNumber = document.getElementById('orderNumber') ? document.getElementById('orderNumber').value.trim() : '';
            const orderDate = document.getElementById('orderDate') ? document.getElementById('orderDate').value : '';
            const customerPhone = document.getElementById('customerPhone') ? document.getElementById('customerPhone').value.trim() : '';
            const customerName = document.getElementById('customerName') ? document.getElementById('customerName').value.trim() : '';
            const customerAddress = document.getElementById('customerAddress') ? document.getElementById('customerAddress').value.trim() : '';
            const technicianId = document.getElementById('technician') ? parseInt(document.getElementById('technician').value) : 0;
            const repairType = document.getElementById('repairType') ? document.getElementById('repairType').value : '';
            const orderAmount = document.getElementById('orderAmount') ? parseInt(document.getElementById('orderAmount').value) : 0;
            const orderDescription = document.getElementById('orderDescription') ? document.getElementById('orderDescription').value.trim() : '';
            
            if (!orderNumber || !orderDate || !customerPhone || !customerName || !technicianId || !repairType || isNaN(orderAmount) || orderAmount <= 0) {
                alert('الرجاء ملء جميع الحقول المطلوبة بشكل صحيح');
                return;
            }
            
            // التحقق من عدم تكرار رقم الفاتورة (باستثناء الفاتورة الحالية)
            if (orders.some(order => order.orderNumber === orderNumber && order.id !== editingOrderId)) {
                alert('رقم الفاتورة موجود مسبقاً. الرجاء استخدام رقم فاتورة مختلف.');
                return;
            }
            
            const orderIndex = orders.findIndex(o => o.id === editingOrderId);
            if (orderIndex !== -1) {
                orders[orderIndex].orderNumber = orderNumber;
                orders[orderIndex].date = orderDate;
                orders[orderIndex].customerName = customerName;
                orders[orderIndex].customerPhone = customerPhone;
                orders[orderIndex].customerAddress = customerAddress;
                orders[orderIndex].technicianId = technicianId;
                orders[orderIndex].repairType = repairType;
                orders[orderIndex].amount = orderAmount;
                orders[orderIndex].description = orderDescription;
                
                saveData();
                loadOrders();
                loadDashboard();
                
                // مسح الحقول وإعادة الحالة
                cancelEditOrder();
            }
        };
        
        window.cancelEditOrder = function() {
            editingOrderId = null;
            clearOrderForm();
            
            if (document.getElementById('saveOrderBtn')) {
                document.getElementById('saveOrderBtn').classList.remove('hidden-by-role');
                document.getElementById('updateOrderBtn').classList.add('hidden-by-role');
                document.getElementById('cancelOrderBtn').classList.add('hidden-by-role');
            }
        };
        
        window.deleteOrder = function(id) {
            if (confirm('هل أنت متأكد من حذف هذه الفاتورة؟')) {
                orders = orders.filter(order => order.id !== id);
                saveData();
                loadOrders();
                loadDashboard();
            }
        };
        
        window.editOrderExpense = function(id) {
            const expense = orderExpenses.find(e => e.id === id);
            if (expense && document.getElementById('expenseOrderNumber')) {
                document.getElementById('expenseOrderNumber').value = expense.orderNumber;
                document.getElementById('expenseDate').value = expense.date;
                document.getElementById('partsExpense').value = expense.parts || 0;
                document.getElementById('transportExpense').value = expense.transport || 0;
                document.getElementById('otherExpense').value = expense.other || 0;
                document.getElementById('expenseDescription').value = expense.description;
                
                editingExpenseId = id;
                
                // إظهار أزرار التحديث والإلغاء
                if (document.getElementById('saveExpenseBtn')) {
                    document.getElementById('saveExpenseBtn').classList.add('hidden-by-role');
                    document.getElementById('updateExpenseBtn').classList.remove('hidden-by-role');
                    document.getElementById('cancelExpenseBtn').classList.remove('hidden-by-role');
                }
            }
        };
        
        window.updateOrderExpense = function() {
            if (!editingExpenseId) return;
            
            const orderNumber = document.getElementById('expenseOrderNumber') ? document.getElementById('expenseOrderNumber').value : '';
            const expenseDate = document.getElementById('expenseDate') ? document.getElementById('expenseDate').value : '';
            const partsExpense = document.getElementById('partsExpense') ? parseInt(document.getElementById('partsExpense').value) || 0 : 0;
            const transportExpense = document.getElementById('transportExpense') ? parseInt(document.getElementById('transportExpense').value) || 0 : 0;
            const otherExpense = document.getElementById('otherExpense') ? parseInt(document.getElementById('otherExpense').value) || 0 : 0;
            const expenseDescription = document.getElementById('expenseDescription') ? document.getElementById('expenseDescription').value.trim() : '';
            
            if (!orderNumber || !expenseDate || (partsExpense === 0 && transportExpense === 0 && otherExpense === 0)) {
                alert('الرجاء ملء جميع الحقول المطلوبة بشكل صحيح');
                return;
            }
            
            const expenseIndex = orderExpenses.findIndex(e => e.id === editingExpenseId);
            if (expenseIndex !== -1) {
                orderExpenses[expenseIndex].orderNumber = orderNumber;
                orderExpenses[expenseIndex].date = expenseDate;
                orderExpenses[expenseIndex].parts = partsExpense;
                orderExpenses[expenseIndex].transport = transportExpense;
                orderExpenses[expenseIndex].other = otherExpense;
                orderExpenses[expenseIndex].description = expenseDescription;
                
                saveData();
                loadOrderExpenses();
                loadDashboard();
                
                // مسح الحقول وإعادة الحالة
                cancelEditExpense();
            }
        };
        
        window.cancelEditExpense = function() {
            editingExpenseId = null;
            clearExpenseForm();
            
            if (document.getElementById('saveExpenseBtn')) {
                document.getElementById('saveExpenseBtn').classList.remove('hidden-by-role');
                document.getElementById('updateExpenseBtn').classList.add('hidden-by-role');
                document.getElementById('cancelExpenseBtn').classList.add('hidden-by-role');
            }
        };
        
        window.deleteOrderExpense = function(id) {
            if (confirm('هل أنت متأكد من حذف هذا المصروف؟')) {
                orderExpenses = orderExpenses.filter(expense => expense.id !== id);
                saveData();
                loadOrderExpenses();
                loadDashboard();
            }
        };
        
        window.editGeneralExpense = function(id) {
            const expense = generalExpenses.find(e => e.id === id);
            if (expense && document.getElementById('generalExpenseDate')) {
                document.getElementById('generalExpenseDate').value = expense.date;
                document.getElementById('generalExpenseType').value = expense.type;
                document.getElementById('generalExpenseAmount').value = expense.amount;
                document.getElementById('generalExpenseDescription').value = expense.description;
                
                editingGeneralExpenseId = id;
                
                // إظهار أزرار التحديث والإلغاء
                if (document.getElementById('saveGeneralExpenseBtn')) {
                    document.getElementById('saveGeneralExpenseBtn').classList.add('hidden-by-role');
                    document.getElementById('updateGeneralExpenseBtn').classList.remove('hidden-by-role');
                    document.getElementById('cancelGeneralExpenseBtn').classList.remove('hidden-by-role');
                }
            }
        };
        
        window.updateGeneralExpense = function() {
            if (!editingGeneralExpenseId) return;
            
            const expenseDate = document.getElementById('generalExpenseDate') ? document.getElementById('generalExpenseDate').value : '';
            const expenseType = document.getElementById('generalExpenseType') ? document.getElementById('generalExpenseType').value : '';
            const expenseAmount = document.getElementById('generalExpenseAmount') ? parseInt(document.getElementById('generalExpenseAmount').value) : 0;
            const expenseDescription = document.getElementById('generalExpenseDescription') ? document.getElementById('generalExpenseDescription').value.trim() : '';
            
            if (!expenseDate || !expenseType || isNaN(expenseAmount) || expenseAmount <= 0) {
                alert('الرجاء ملء جميع الحقول المطلوبة بشكل صحيح');
                return;
            }
            
            const expenseIndex = generalExpenses.findIndex(e => e.id === editingGeneralExpenseId);
            if (expenseIndex !== -1) {
                generalExpenses[expenseIndex].date = expenseDate;
                generalExpenses[expenseIndex].type = expenseType;
                generalExpenses[expenseIndex].amount = expenseAmount;
                generalExpenses[expenseIndex].description = expenseDescription;
                
                saveData();
                loadGeneralExpenses();
                loadDashboard();
                
                // مسح الحقول وإعادة الحالة
                cancelEditGeneralExpense();
            }
        };
        
        window.cancelEditGeneralExpense = function() {
            editingGeneralExpenseId = null;
            clearGeneralExpenseForm();
            
            if (document.getElementById('saveGeneralExpenseBtn')) {
                document.getElementById('saveGeneralExpenseBtn').classList.remove('hidden-by-role');
                document.getElementById('updateGeneralExpenseBtn').classList.add('hidden-by-role');
                document.getElementById('cancelGeneralExpenseBtn').classList.add('hidden-by-role');
            }
        };
        
        window.deleteGeneralExpense = function(id) {
            if (confirm('هل أنت متأكد من حذف هذا المصروف العام؟')) {
                generalExpenses = generalExpenses.filter(expense => expense.id !== id);
                saveData();
                loadGeneralExpenses();
                loadDashboard();
            }
        };
        
        window.editAdvance = function(id) {
            const advance = advances.find(a => a.id === id);
            if (advance && document.getElementById('advanceEmployee')) {
                document.getElementById('advanceEmployee').value = advance.employee;
                document.getElementById('advanceDate').value = advance.date;
                document.getElementById('advanceAmount').value = advance.amount;
                document.getElementById('advanceReason').value = advance.reason;
                
                editingAdvanceId = id;
                
                // إظهار أزرار التحديث والإلغاء
                if (document.getElementById('saveAdvanceBtn')) {
                    document.getElementById('saveAdvanceBtn').classList.add('hidden-by-role');
                    document.getElementById('updateAdvanceBtn').classList.remove('hidden-by-role');
                    document.getElementById('cancelAdvanceBtn').classList.remove('hidden-by-role');
                }
            }
        };
        
        window.updateAdvance = function() {
            if (!editingAdvanceId) return;
            
            const employee = document.getElementById('advanceEmployee') ? document.getElementById('advanceEmployee').value : '';
            const advanceDate = document.getElementById('advanceDate') ? document.getElementById('advanceDate').value : '';
            const advanceAmount = document.getElementById('advanceAmount') ? parseInt(document.getElementById('advanceAmount').value) : 0;
            const advanceReason = document.getElementById('advanceReason') ? document.getElementById('advanceReason').value.trim() : '';
            
            if (!employee || !advanceDate || isNaN(advanceAmount) || advanceAmount <= 0) {
                alert('الرجاء ملء جميع الحقول المطلوبة بشكل صحيح');
                return;
            }
            
            const advanceIndex = advances.findIndex(a => a.id === editingAdvanceId);
            if (advanceIndex !== -1) {
                advances[advanceIndex].employee = employee;
                advances[advanceIndex].date = advanceDate;
                advances[advanceIndex].amount = advanceAmount;
                advances[advanceIndex].reason = advanceReason;
                
                saveData();
                loadAdvances();
                
                // مسح الحقول وإعادة الحالة
                cancelEditAdvance();
            }
        };
        
        window.cancelEditAdvance = function() {
            editingAdvanceId = null;
            clearAdvanceForm();
            
            if (document.getElementById('saveAdvanceBtn')) {
                document.getElementById('saveAdvanceBtn').classList.remove('hidden-by-role');
                document.getElementById('updateAdvanceBtn').classList.add('hidden-by-role');
                document.getElementById('cancelAdvanceBtn').classList.add('hidden-by-role');
            }
        };
        
        window.deleteAdvance = function(id) {
            if (confirm('هل أنت متأكد من حذف هذه السلفة؟')) {
                advances = advances.filter(advance => advance.id !== id);
                saveData();
                loadAdvances();
            }
        };
        
        window.showPayAdvanceModal = showPayAdvanceModal;
        window.restoreBackup = restoreBackup;
        window.deleteBackup = deleteBackup;
        window.editUser = editUser;
        window.deleteUser = deleteUser;
        window.deleteTechnician = deleteTechnician;
    </script>
</body>
</html>
