<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برنامج مركز تراست لصيانة الأجهزة المنزلية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #e6f7ff;
            color: #333;
            line-height: 1.6;
            background-image: url('https://i.postimg.cc/LX5MPzBx/logo.jpg');
            background-repeat: repeat;
            background-size: 150px;
            background-attachment: fixed;
            background-position: center;
            background-blend-mode: overlay;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* شاشة تسجيل الدخول */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .login-logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid #FF6E00;
        }
        
        .login-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .login-title {
            color: #1a8c5e;
            margin-bottom: 30px;
            font-size: 1.8rem;
        }
        
        .login-input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .login-input:focus {
            outline: none;
            border-color: #FF6E00;
        }
        
        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #FF6E00, #FF8C42);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .login-btn:hover {
            background: linear-gradient(135deg, #FF8C42, #FF6E00);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 110, 0, 0.3);
        }
        
        /* الهيدر */
        header {
            background: linear-gradient(135deg, #1a8c5e 0%, #2ecc71 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 3px solid #FF6E00;
        }
        
        .logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .header-text h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .header-text p {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-name {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .logout-btn {
            background-color: #FF6E00;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background-color: #e65c00;
        }
        
        /* شريط التنقل */
        nav {
            display: flex;
            background: linear-gradient(135deg, #FF8C42, #FF6E00);
            border-radius: 10px;
            margin-bottom: 30px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
        }
        
        .nav-btn {
            flex: 1;
            min-width: 150px;
            text-align: center;
            padding: 18px 10px;
            background: transparent;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .nav-btn.active {
            background-color: rgba(255, 255, 255, 0.3);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .nav-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .nav-btn.disabled:hover {
            background: transparent;
        }
        
        /* محتوى الصفحات */
        .content-section {
            display: none;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            backdrop-filter: blur(5px);
        }
        
        .content-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-title {
            font-size: 1.5rem;
            color: #1a8c5e;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0f7e9;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: #FF6E00;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #444;
        }
        
        input, select, textarea {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #FF6E00;
        }
        
        .btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #1a8c5e, #2ecc71);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            background: linear-gradient(135deg, #2ecc71, #1a8c5e);
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }
        
        .btn-orange {
            background: linear-gradient(135deg, #FF6E00, #FF8C42);
        }
        
        .btn-orange:hover {
            background: linear-gradient(135deg, #FF8C42, #FF6E00);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #34ce57);
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #34ce57, #28a745);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #e4606d);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #e4606d, #dc3545);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 700;
            color: #1a8c5e;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .action-btns {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 5px 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .edit-btn {
            background: linear-gradient(135deg, #FFC107, #ffd54f);
            color: #333;
        }
        
        .delete-btn {
            background: linear-gradient(135deg, #dc3545, #e4606d);
            color: white;
        }
        
        /* كروت الإحصائيات */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-top: 5px solid #FF6E00;
            transition: all 0.3s ease;
            animation: cardFloat 3s ease-in-out infinite;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        @keyframes cardFloat {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }
        
        .card h3 {
            color: #1a8c5e;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .card-value {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }
        
        .card-profit {
            color: #1a8c5e;
        }
        
        .card-loss {
            color: #dc3545;
        }
        
        .date-filter {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .report-table {
            overflow-x: auto;
        }
        
        .empty-message {
            text-align: center;
            padding: 40px;
            color: #777;
            font-size: 1.1rem;
        }
        
        .empty-message i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ddd;
        }
        
        /* مربعات مصروفات الأوردر */
        .expense-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .expense-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }
        
        .expense-box label {
            display: block;
            margin-bottom: 8px;
            color: #1a8c5e;
            font-weight: 600;
        }
        
        /* شريط البحث */
        .search-bar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #FF6E00;
        }
        
        /* شاشة السلف */
        .advance-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .advance-history {
            margin-top: 30px;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #777;
            font-size: 0.9rem;
        }
        
        .signature-card {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, #FF6E00, #80EF80, #2196F3);
            color: white;
            padding: 12px 22px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1rem;
            font-weight: 600;
            z-index: 1000;
            animation: float 6s ease-in-out infinite;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.2);
            transform: scale(0.9);
        }
        
        .signature-card:hover { 
            transform: scale(0.95); 
            box-shadow: 0 12px 35px rgba(0,0,0,0.4); 
        }
        
        @keyframes float { 
            0% { transform: scale(0.9) translateY(0px); } 
            50% { transform: scale(0.9) translateY(-10px); } 
            100% { transform: scale(0.9) translateY(0px); } 
        }
        
        .signature-card::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(135deg, #FF746C, #FF6E00, #80EF80, #2196F3);
            border-radius: 14px;
            z-index: -1;
            animation: borderGlow 3s linear infinite;
            background-size: 400%;
        }
        
        @keyframes borderGlow { 
            0% { background-position: 0% 50%; } 
            50% { background-position: 100% 50%; } 
            100% { background-position: 0% 50%; } 
        }
        
        .signature-card .name { 
            font-size: 1.2rem; 
            font-weight: 700; 
            margin-bottom: 3px; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3); 
        }
        
        .signature-card .title { 
            font-size: 0.8rem; 
            opacity: 0.9; 
            font-weight: 500; 
        }
        
        @media (max-width: 768px) { 
            .signature-card { 
                position: relative; 
                bottom: auto; 
                left: auto; 
                margin: 20px auto 0; 
                width: fit-content; 
                animation: none; 
                transform: scale(0.85);
            } 
            
            .signature-card:hover { 
                transform: scale(0.9); 
            } 
            
            .nav-btn {
                min-width: 120px;
                font-size: 0.9rem;
                padding: 15px 5px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .header-text h1 {
                font-size: 1.4rem;
            }
            
            .date-filter {
                flex-direction: column;
                align-items: stretch;
            }
        }
        
        /* شاشة تغيير كلمة المرور */
        .change-password-container {
            max-width: 500px;
            margin: 0 auto;
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
        }
        
        /* إخفاء العناصر حسب الصلاحية */
        .hidden-by-role {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- شاشة تسجيل الدخول -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <img src="https://i.postimg.cc/LX5MPzBx/logo.jpg" alt="شعار مركز تراست">
            </div>
            <h1 class="login-title">مركز تراست لصيانة الأجهزة المنزلية</h1>
            <div class="form-group">
                <select id="loginUser" class="login-input">
                    <option value="">اختر المستخدم</option>
                </select>
            </div>
            <div class="form-group">
                <input type="password" id="loginPassword" class="login-input" placeholder="كلمة المرور (123)">
            </div>
            <button id="loginBtn" class="login-btn">
                <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
            </button>
            <div id="loginError" style="color: #dc3545; margin-top: 15px; display: none;">
                <i class="fas fa-exclamation-circle"></i> كلمة المرور غير صحيحة
            </div>
        </div>
    </div>
    
    <!-- الواجهة الرئيسية -->
    <div id="mainApp" style="display: none;">
        <div class="container">
            <header>
                <div class="logo-container">
                    <div class="logo">
                        <img src="https://i.postimg.cc/LX5MPzBx/logo.jpg" alt="شعار مركز تراست">
                    </div>
                    <div class="header-text">
                        <h1>مركز تراست لصيانة الأجهزة المنزلية</h1>
                        <p>برنامج إدارة مركز الصيانة - نظام متكامل للمحاسبة والتقارير</p>
                    </div>
                </div>
                <div class="user-info">
                    <div class="user-name" id="currentUserName"></div>
                    <div class="user-name" id="currentUserRole"></div>
                    <button id="logoutBtn" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                    </button>
                    <button id="changePasswordBtn" class="logout-btn" style="background-color: #1a8c5e;">
                        <i class="fas fa-key"></i> تغيير كلمة المرور
                    </button>
                </div>
            </header>
            
            <nav>
                <button class="nav-btn active" data-section="dashboard">
                    <i class="fas fa-home"></i> لوحة التحكم
                </button>
                <button class="nav-btn" data-section="settings" id="settingsNav">
                    <i class="fas fa-cogs"></i> الإعدادات
                </button>
                <button class="nav-btn" data-section="orders">
                    <i class="fas fa-file-invoice-dollar"></i> تسجيل الفواتير
                </button>
                <button class="nav-btn" data-section="order-expenses">
                    <i class="fas fa-tools"></i> مصروفات الأوردر
                </button>
                <button class="nav-btn" data-section="general-expenses" id="generalExpensesNav">
                    <i class="fas fa-receipt"></i> المصروفات العامة
                </button>
                <button class="nav-btn" data-section="advances">
                    <i class="fas fa-hand-holding-usd"></i> سلف الموظفين
                </button>
                <button class="nav-btn" data-section="reports" id="reportsNav">
                    <i class="fas fa-chart-bar"></i> التقارير
                </button>
                <button class="nav-btn" data-section="summary" id="summaryNav">
                    <i class="fas fa-chart-pie"></i> ملخص العمليات
                </button>
            </nav>
            
            <!-- لوحة التحكم -->
            <section id="dashboard" class="content-section active">
                <h2 class="section-title"><i class="fas fa-home"></i> لوحة التحكم</h2>
                <div class="dashboard-cards">
                    <div class="card">
                        <h3>إجمالي الإيرادات</h3>
                        <div class="card-value" id="totalRevenue">0 ج.م</div>
                        <p>منذ بداية الشهر</p>
                    </div>
                    <div class="card">
                        <h3>عدد الفواتير</h3>
                        <div class="card-value" id="totalOrders">0</div>
                        <p>فواتير هذا الشهر</p>
                    </div>
                    <div class="card">
                        <h3>صافي الربح</h3>
                        <div class="card-value card-profit" id="netProfit">0 ج.م</div>
                        <p>لهذا الشهر</p>
                    </div>
                    <div class="card">
                        <h3>المصروفات</h3>
                        <div class="card-value" id="totalExpenses">0 ج.م</div>
                        <p>إجمالي المصروفات</p>
                    </div>
                    <div class="card">
                        <h3>الفنيين النشطين</h3>
                        <div class="card-value" id="activeTechnicians">0</div>
                        <p>عدد الفنيين المسجلين</p>
                    </div>
                    <div class="card">
                        <h3>السلف المستحقة</h3>
                        <div class="card-value" id="totalAdvances">0 ج.م</div>
                        <p>إجمالي سلف الموظفين</p>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3 class="section-title"><i class="fas fa-chart-line"></i> آخر الفواتير</h3>
                    <div class="report-table">
                        <table id="recentOrdersTable">
                            <thead>
                                <tr>
                                    <th>رقم الفاتورة</th>
                                    <th>التاريخ</th>
                                    <th>اسم العميل</th>
                                    <th>نوع التصليح</th>
                                    <th>المبلغ (ج.م)</th>
                                </tr>
                            </thead>
                            <tbody id="recentOrdersTableBody">
                                <!-- سيتم ملؤها بالبيانات من JavaScript -->
                            </tbody>
                        </table>
                        <div id="noRecentOrders" class="empty-message">
                            <i class="fas fa-file-invoice"></i>
                            <p>لا يوجد فواتير مسجلة بعد.</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- شاشة الإعدادات -->
            <section id="settings" class="content-section">
                <h2 class="section-title"><i class="fas fa-cogs"></i> إعدادات النظام</h2>
                
                <!-- إدارة الفنيين -->
                <div style="margin-bottom: 40px;">
                    <h3 style="color: #1a8c5e; margin-bottom: 15px;"><i class="fas fa-users"></i> إدارة الفنيين</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="techName">اسم الفني</label>
                            <input type="text" id="techName" placeholder="أدخل اسم الفني">
                        </div>
                        <div class="form-group">
                            <label for="techPercentage">نسبة العمولة (%)</label>
                            <input type="number" id="techPercentage" min="0" max="100" placeholder="النسبة من 0 إلى 100">
                        </div>
                    </div>
                    <button id="addTechBtn" class="btn btn-orange">
                        <i class="fas fa-plus"></i> إضافة فني
                    </button>
                    <button id="updateTechBtn" class="btn btn-success hidden-by-role">
                        <i class="fas fa-save"></i> تحديث الفني
                    </button>
                    <button id="cancelTechBtn" class="btn btn-danger hidden-by-role">
                        <i class="fas fa-times"></i> إلغاء التعديل
                    </button>
                    
                    <div class="table-container" style="margin-top: 30px;">
                        <h4 style="color: #444; margin-bottom: 15px;">قائمة الفنيين</h4>
                        <table id="techTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>اسم الفني</th>
                                    <th>نسبة العمولة (%)</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="techTableBody">
                                <!-- سيتم ملؤها بالبيانات من JavaScript -->
                            </tbody>
                        </table>
                        <div id="noTechs" class="empty-message">
                            <i class="fas fa-users"></i>
                            <p>لا يوجد فنيين مسجلين بعد. قم بإضافة فنيين للنظام.</p>
                        </div>
                    </div>
                </div>
                
                <!-- إدارة المستخدمين -->
                <div id="usersManagement" class="hidden-by-role">
                    <h3 style="color: #1a8c5e; margin-bottom: 15px;"><i class="fas fa-user-cog"></i> إدارة المستخدمين</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="userName">اسم المستخدم</label>
                            <input type="text" id="userName" placeholder="أدخل اسم المستخدم">
                        </div>
                        <div class="form-group">
                            <label for="userRole">دور المستخدم</label>
                            <select id="userRole">
                                <option value="superAdmin">سوبر أدمن (وائل)</option>
                                <option value="admin">أدمن (محمد علي)</option>
                                <option value="dataEntry">مدخل بيانات (جمال)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="userPassword">كلمة المرور</label>
                            <input type="text" id="userPassword" placeholder="كلمة المرور (123)">
                        </div>
                    </div>
                    <button id="addUserBtn" class="btn btn-orange">
                        <i class="fas fa-plus"></i> إضافة مستخدم
                    </button>
                    <button id="updateUserBtn" class="btn btn-success hidden-by-role">
                        <i class="fas fa-save"></i> تحديث المستخدم
                    </button>
                    <button id="cancelUserBtn" class="btn btn-danger hidden-by-role">
                        <i class="fas fa-times"></i> إلغاء التعديل
                    </button>
                    
                    <div class="table-container" style="margin-top: 30px;">
                        <h4 style="color: #444; margin-bottom: 15px;">قائمة المستخدمين</h4>
                        <table id="usersTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>اسم المستخدم</th>
                                    <th>الدور</th>
                                    <th>كلمة المرور</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- سيتم ملؤها بالبيانات من JavaScript -->
                            </tbody>
                        </table>
                        <div id="noUsers" class="empty-message">
                            <i class="fas fa-users"></i>
                            <p>لا يوجد مستخدمين مسجلين بعد.</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- شاشة تسجيل الفواتير -->
            <section id="orders" class="content-section">
                <h2 class="section-title"><i class="fas fa-file-invoice-dollar"></i> تسجيل فاتورة إيراد جديدة</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="orderNumber">رقم الأوردر (الفاتورة)</label>
                        <input type="text" id="orderNumber" placeholder="رقم الفاتورة">
                    </div>
                    <div class="form-group">
                        <label for="orderDate">تاريخ الفاتورة</label>
                        <input type="date" id="orderDate">
                    </div>
                    <div class="form-group">
                        <label for="customerName">اسم العميل</label>
                        <input type="text" id="customerName" placeholder="اسم العميل">
                    </div>
                    <div class="form-group">
                        <label for="customerPhone">رقم موبايل العميل</label>
                        <input type="tel" id="customerPhone" placeholder="رقم هاتف العميل">
                    </div>
                    <div class="form-group">
                        <label for="technician">الفني القائم بالتصليح</label>
                        <select id="technician">
                            <option value="">اختر الفني</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="repairType">نوع التصليح</label>
                        <select id="repairType">
                            <option value="ثلاجة وتكييف">ثلاجة وتكييف</option>
                            <option value="تكييف">تكييف</option>
                            <option value="أجهزة منزلية">أجهزة منزلية</option>
                            <option value="أخرى">أخرى</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="orderAmount">مبلغ الفاتورة (ج.م)</label>
                        <input type="number" id="orderAmount" min="0" placeholder="إجمالي مبلغ الفاتورة">
                    </div>
                </div>
                <div class="form-group">
                    <label for="orderDescription">بيان الفاتورة (وصف الأعمال)</label>
                    <textarea id="orderDescription" rows="3" placeholder="تفاصيل الأعمال المنفذة"></textarea>
                </div>
                <button id="saveOrderBtn" class="btn btn-success">
                    <i class="fas fa-save"></i> حفظ الفاتورة
                </button>
                <button id="updateOrderBtn" class="btn btn-success hidden-by-role">
                    <i class="fas fa-save"></i> تحديث الفاتورة
                </button>
                <button id="cancelOrderBtn" class="btn btn-danger hidden-by-role">
                    <i class="fas fa-times"></i> إلغاء التعديل
                </button>
                
                <!-- شريط البحث -->
                <div class="search-bar">
                    <input type="text" id="searchOrders" class="search-input" placeholder="ابحث برقم الفاتورة أو اسم العميل أو رقم الهاتف...">
                </div>
                
                <div class="table-container">
                    <h3 class="section-title"><i class="fas fa-list"></i> الفواتير المسجلة</h3>
                    <table id="ordersTable">
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>التاريخ</th>
                                <th>اسم العميل</th>
                                <th>هاتف العميل</th>
                                <th>نوع التصليح</th>
                                <th>المبلغ (ج.م)</th>
                                <th>اسم الفني</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- سيتم ملؤها بالبيانات من JavaScript -->
                        </tbody>
                    </table>
                    <div id="noOrders" class="empty-message">
                        <i class="fas fa-file-invoice"></i>
                        <p>لا يوجد فواتير مسجلة بعد. قم بإضافة فاتورة جديدة.</p>
                    </div>
                </div>
            </section>
            
            <!-- شاشة مصروفات الأوردر -->
            <section id="order-expenses" class="content-section">
                <h2 class="section-title"><i class="fas fa-tools"></i> تسجيل مصروفات الأوردر</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="expenseOrderNumber">رقم الأوردر (الفاتورة)</label>
                        <select id="expenseOrderNumber">
                            <option value="">اختر رقم الفاتورة</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="expenseDate">تاريخ المصروف</label>
                        <input type="date" id="expenseDate">
                    </div>
                </div>
                
                <div class="expense-inputs">
                    <div class="expense-box">
                        <label for="partsExpense">قطع غيار (ج.م)</label>
                        <input type="number" id="partsExpense" min="0" placeholder="مبلغ قطع الغيار">
                    </div>
                    <div class="expense-box">
                        <label for="transportExpense">مواصلات (ج.م)</label>
                        <input type="number" id="transportExpense" min="0" placeholder="مبلغ المواصلات">
                    </div>
                    <div class="expense-box">
                        <label for="otherExpense">أخرى (ج.م)</label>
                        <input type="number" id="otherExpense" min="0" placeholder="مصاريف أخرى">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="expenseDescription">بيان المصروف</label>
                    <textarea id="expenseDescription" rows="3" placeholder="تفاصيل المصروف"></textarea>
                </div>
                <button id="saveExpenseBtn" class="btn btn-success">
                    <i class="fas fa-save"></i> حفظ المصروف
                </button>
                <button id="updateExpenseBtn" class="btn btn-success hidden-by-role">
                    <i class="fas fa-save"></i> تحديث المصروف
                </button>
                <button id="cancelExpenseBtn" class="btn btn-danger hidden-by-role">
                    <i class="fas fa-times"></i> إلغاء التعديل
                </button>
                
                <div class="table-container" style="margin-top: 40px;">
                    <h3 class="section-title"><i class="fas fa-list"></i> مصروفات الأوردرات</h3>
                    <table id="expensesTable">
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>تاريخ المصروف</th>
                                <th>قطع غيار</th>
                                <th>مواصلات</th>
                                <th>أخرى</th>
                                <th>الإجمالي</th>
                                <th>البيان</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody">
                            <!-- سيتم ملؤها بالبيانات من JavaScript -->
                        </tbody>
                    </table>
                    <div id="noExpenses" class="empty-message">
                        <i class="fas fa-tools"></i>
                        <p>لا يوجد مصروفات مسجلة بعد. قم بإضافة مصروف جديد.</p>
                    </div>
                </div>
            </section>
            
            <!-- شاشة المصروفات العامة -->
            <section id="general-expenses" class="content-section">
                <h2 class="section-title"><i class="fas fa-receipt"></i> تسجيل مصروفات عامة</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="generalExpenseDate">تاريخ المصروف</label>
                        <input type="date" id="generalExpenseDate">
                    </div>
                    <div class="form-group">
                        <label for="generalExpenseType">نوع المصروف</label>
                        <select id="generalExpenseType">
                            <option value="ايجار المركز">ايجار المركز</option>
                            <option value="ايجار سكن الموظفين">ايجار سكن الموظفين</option>
                            <option value="ايجار شقة 1">ايجار شقة 1</option>
                            <option value="الرواتب">الرواتب</option>
                            <option value="النظافة">النظافة</option>
                            <option value="الضيافة">الضيافة</option>
                            <option value="أخرى">أخرى</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="generalExpenseAmount">مبلغ المصروف (ج.م)</label>
                        <input type="number" id="generalExpenseAmount" min="0" placeholder="مبلغ المصروف">
                    </div>
                </div>
                <div class="form-group">
                    <label for="generalExpenseDescription">بيان المصروف</label>
                    <textarea id="generalExpenseDescription" rows="3" placeholder="تفاصيل المصروف"></textarea>
                </div>
                <button id="saveGeneralExpenseBtn" class="btn btn-success">
                    <i class="fas fa-plus"></i> إضافة مصروف عام
                </button>
                <button id="updateGeneralExpenseBtn" class="btn btn-success hidden-by-role">
                    <i class="fas fa-save"></i> تحديث المصروف
                </button>
                <button id="cancelGeneralExpenseBtn" class="btn btn-danger hidden-by-role">
                    <i class="fas fa-times"></i> إلغاء التعديل
                </button>
                
                <div class="table-container" style="margin-top: 40px;">
                    <h3 class="section-title"><i class="fas fa-list"></i> المصروفات العامة المسجلة</h3>
                    <table id="generalExpensesTable">
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>نوع المصروف</th>
                                <th>المبلغ (ج.م)</th>
                                <th>البيان</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="generalExpensesTableBody">
                            <!-- سيتم ملؤها بالبيانات من JavaScript -->
                        </tbody>
                    </table>
                    <div id="noGeneralExpenses" class="empty-message">
                        <i class="fas fa-receipt"></i>
                        <p>لا يوجد مصروفات عامة مسجلة بعد. قم بإضافة مصروف عام جديد.</p>
                    </div>
                </div>
            </section>
            
            <!-- شاشة السلف -->
            <section id="advances" class="content-section">
                <h2 class="section-title"><i class="fas fa-hand-holding-usd"></i> تسجيل سلف الموظفين والفنيين</h2>
                
                <div class="advance-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="advanceEmployee">اسم الموظف/الفني</label>
                            <select id="advanceEmployee">
                                <option value="">اختر الموظف</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="advanceDate">تاريخ السلفة</label>
                            <input type="date" id="advanceDate">
                        </div>
                        <div class="form-group">
                            <label for="advanceAmount">مبلغ السلفة (ج.م)</label>
                            <input type="number" id="advanceAmount" min="0" placeholder="مبلغ السلفة">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="advanceReason">سبب السلفة</label>
                        <textarea id="advanceReason" rows="3" placeholder="سبب السلفة"></textarea>
                    </div>
                    <button id="saveAdvanceBtn" class="btn btn-success">
                        <i class="fas fa-save"></i> حفظ السلفة
                    </button>
                    <button id="updateAdvanceBtn" class="btn btn-success hidden-by-role">
                        <i class="fas fa-save"></i> تحديث السلفة
                    </button>
                    <button id="cancelAdvanceBtn" class="btn btn-danger hidden-by-role">
                        <i class="fas fa-times"></i> إلغاء التعديل
                    </button>
                </div>
                
                <div class="advance-history">
                    <h3 class="section-title"><i class="fas fa-history"></i> تاريخ السلف</h3>
                    <div class="date-filter">
                        <div>
                            <label for="advanceFromDate">من تاريخ</label>
                            <input type="date" id="advanceFromDate">
                        </div>
                        <div>
                            <label for="advanceToDate">إلى تاريخ</label>
                            <input type="date" id="advanceToDate">
                        </div>
                        <button id="filterAdvancesBtn" class="btn">
                            <i class="fas fa-filter"></i> تصفية السلف
                        </button>
                        <button id="resetAdvancesBtn" class="btn">
                            <i class="fas fa-redo"></i> عرض الكل
                        </button>
                    </div>
                    
                    <div class="report-table">
                        <table id="advancesTable">
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>اسم الموظف</th>
                                    <th>مبلغ السلفة</th>
                                    <th>سبب السلفة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="advancesTableBody">
                                <!-- سيتم ملؤها بالبيانات من JavaScript -->
                            </tbody>
                        </table>
                        <div id="noAdvances" class="empty-message">
                            <i class="fas fa-hand-holding-usd"></i>
                            <p>لا يوجد سلف مسجلة بعد. قم بإضافة سلفة جديدة.</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- شاشة التقارير -->
            <section id="reports" class="content-section">
                <h2 class="section-title"><i class="fas fa-chart-bar"></i> تقارير ربحية الفواتير</h2>
                
                <div class="date-filter">
                    <div>
                        <label for="reportFromDate">من تاريخ</label>
                        <input type="date" id="reportFromDate">
                    </div>
                    <div>
                        <label for="reportToDate">إلى تاريخ</label>
                        <input type="date" id="reportToDate">
                    </div>
                    <button id="filterReportBtn" class="btn">
                        <i class="fas fa-filter"></i> تصفية التقارير
                    </button>
                    <button id="resetReportBtn" class="btn">
                        <i class="fas fa-redo"></i> عرض الكل
                    </button>
                </div>
                
                <div class="report-table">
                    <table id="profitReportTable">
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>التاريخ</th>
                                <th>قيمة الفاتورة</th>
                                <th>اسم الفني</th>
                                <th>نسبة الفني</th>
                                <th>مصروفات الأوردر</th>
                                <th>صافي الربح</th>
                                <th>نسبة الربح</th>
                            </tr>
                        </thead>
                        <tbody id="profitReportTableBody">
                            <!-- سيتم ملؤها بالبيانات من JavaScript -->
                        </tbody>
                    </table>
                    <div id="noReportData" class="empty-message">
                        <i class="fas fa-chart-line"></i>
                        <p>لا توجد بيانات لتقرير الربحية. قم بإضافة فواتير ومصروفات أولاً.</p>
                    </div>
                </div>
                
                <div style="margin-top: 40px;">
                    <h3 class="section-title"><i class="fas fa-chart-bar"></i> تقرير مجمع</h3>
                    <div class="dashboard-cards" id="aggregateReport">
                        <!-- سيتم ملؤها بالبيانات من JavaScript -->
                    </div>
                </div>
            </section>
            
            <!-- شاشة ملخص العمليات -->
            <section id="summary" class="content-section">
                <h2 class="section-title"><i class="fas fa-chart-pie"></i> ملخص العمليات</h2>
                
                <div class="date-filter">
                    <div>
                        <label for="summaryFromDate">من تاريخ</label>
                        <input type="date" id="summaryFromDate">
                    </div>
                    <div>
                        <label for="summaryToDate">إلى تاريخ</label>
                        <input type="date" id="summaryToDate">
                    </div>
                    <button id="filterSummaryBtn" class="btn">
                        <i class="fas fa-filter"></i> تصفية الملخص
                    </button>
                </div>
                
                <div class="dashboard-cards" id="operationsSummary">
                    <!-- سيتم ملؤها بالبيانات من JavaScript -->
                </div>
                
                <div style="margin-top: 30px;">
                    <h3 class="section-title"><i class="fas fa-table"></i> تفاصيل الملخص</h3>
                    <div id="detailedSummary">
                        <!-- سيتم ملؤها بالبيانات من JavaScript -->
                    </div>
                </div>
            </section>
            
            <!-- نافذة تغيير كلمة المرور -->
            <div id="changePasswordModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
                <div style="background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px;">
                    <h3 style="color: #1a8c5e; margin-bottom: 20px;"><i class="fas fa-key"></i> تغيير كلمة المرور</h3>
                    <div class="form-group">
                        <label for="oldPassword">كلمة المرور القديمة</label>
                        <input type="password" id="oldPassword" class="login-input">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">كلمة المرور الجديدة</label>
                        <input type="password" id="newPassword" class="login-input">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">تأكيد كلمة المرور الجديدة</label>
                        <input type="password" id="confirmPassword" class="login-input">
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button id="savePasswordBtn" class="btn btn-success">
                            <i class="fas fa-save"></i> حفظ
                        </button>
                        <button id="cancelPasswordBtn" class="btn btn-danger">
                            <i class="fas fa-times"></i> إلغاء
                        </button>
                    </div>
                    <div id="passwordError" style="color: #dc3545; margin-top: 15px; display: none;"></div>
                </div>
            </div>
            
            <footer>
                <p>برنامج إدارة مركز تراست لصيانة الأجهزة المنزلية &copy; 2025 - نظام متكامل للمحاسبة والتقارير</p>
                <p>جميع الحقوق محفوظة</p>
            </footer>
        </div>
        
        <!-- توقيع المطور -->
        <div class="signature-card">
            <div class="name">Yasser Elkhateeb</div>
            <div class="title">مطور البرنامج 67011143</div>
        </div>
    </div>

    <script>
        // البيانات الافتراضية
        let currentUser = null;
        let editingTechId = null;
        let editingOrderId = null;
        let editingExpenseId = null;
        let editingGeneralExpenseId = null;
        let editingAdvanceId = null;
        let editingUserId = null;
        
        // المستخدمون الافتراضيون
        let users = JSON.parse(localStorage.getItem('users')) || [
            {id: 1, name: "وائل", role: "superAdmin", password: "123"},
            {id: 2, name: "محمد علي", role: "admin", password: "123"},
            {id: 3, name: "جمال", role: "dataEntry", password: "123"}
        ];
        
        let technicians = JSON.parse(localStorage.getItem('technicians')) || [
            {id: 1, name: "أبو علي", percentage: 15},
            {id: 2, name: "احمد", percentage: 20},
            {id: 3, name: "جمال", percentage: 18}
        ];
        
        let orders = JSON.parse(localStorage.getItem('orders')) || [
            {id: 1, orderNumber: "ORD-001", date: "2025-10-01", customerName: "علي محمد", customerPhone: "01012345678", technicianId: 1, repairType: "ثلاجة وتكييف", amount: 500, description: "صيانة ثلاجة"},
            {id: 2, orderNumber: "ORD-002", date: "2025-10-05", customerName: "محمود أحمد", customerPhone: "01087654321", technicianId: 2, repairType: "تكييف", amount: 800, description: "صيانة تكييف"},
            {id: 3, orderNumber: "ORD-003", date: "2025-10-10", customerName: "سعيد جمال", customerPhone: "01055556666", technicianId: 3, repairType: "أجهزة منزلية", amount: 300, description: "صيانة غسالة"}
        ];
        
        let orderExpenses = JSON.parse(localStorage.getItem('orderExpenses')) || [
            {id: 1, orderNumber: "ORD-001", date: "2025-10-01", parts: 100, transport: 50, other: 0, description: "شراء قطع غيار للثلاجة ومواصلات"},
            {id: 2, orderNumber: "ORD-002", date: "2025-10-05", parts: 200, transport: 0, other: 0, description: "شراء قطع غيار للتكييف"}
        ];
        
        let generalExpenses = JSON.parse(localStorage.getItem('generalExpenses')) || [
            {id: 1, date: "2025-10-01", type: "ايجار المركز", amount: 2000, description: "ايجار مركز الصيانة"},
            {id: 2, date: "2025-10-01", type: "الرواتب", amount: 5000, description: "رواتب الموظفين"},
            {id: 3, date: "2025-10-05", type: "النظافة", amount: 300, description: "مصاريف نظافة المركز"}
        ];
        
        let advances = JSON.parse(localStorage.getItem('advances')) || [
            {id: 1, employee: "أبو علي", date: "2025-10-01", amount: 500, reason: "سلفة شهرية"},
            {id: 2, employee: "احمد", date: "2025-10-05", amount: 300, reason: "مصاريف علاج"}
        ];
        
        // حفظ البيانات في localStorage
        function saveData() {
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('technicians', JSON.stringify(technicians));
            localStorage.setItem('orders', JSON.stringify(orders));
            localStorage.setItem('orderExpenses', JSON.stringify(orderExpenses));
            localStorage.setItem('generalExpenses', JSON.stringify(generalExpenses));
            localStorage.setItem('advances', JSON.stringify(advances));
        }
        
        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            // تعيين التواريخ الحالية
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('orderDate').value = today;
            document.getElementById('expenseDate').value = today;
            document.getElementById('generalExpenseDate').value = today;
            document.getElementById('advanceDate').value = today;
            
            const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
            document.getElementById('reportFromDate').value = firstDayOfMonth;
            document.getElementById('reportToDate').value = today;
            document.getElementById('summaryFromDate').value = firstDayOfMonth;
            document.getElementById('summaryToDate').value = today;
            document.getElementById('advanceFromDate').value = firstDayOfMonth;
            document.getElementById('advanceToDate').value = today;
            
            // تحميل قائمة المستخدمين في شاشة الدخول
            loadLoginUsers();
            
            // إضافة المستمعين للأحداث
            setupEventListeners();
        });
        
        // تحميل قائمة المستخدمين في شاشة الدخول
        function loadLoginUsers() {
            const loginUserSelect = document.getElementById('loginUser');
            loginUserSelect.innerHTML = '<option value="">اختر المستخدم</option>';
            
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${getRoleName(user.role)})`;
                loginUserSelect.appendChild(option);
            });
        }
        
        // الحصول على اسم الدور
        function getRoleName(role) {
            switch(role) {
                case 'superAdmin': return 'سوبر أدمن';
                case 'admin': return 'أدمن';
                case 'dataEntry': return 'مدخل بيانات';
                default: return role;
            }
        }
        
        // إعداد المستمعين للأحداث
        function setupEventListeners() {
            // تسجيل الدخول
            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            // تسجيل الخروج
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // تغيير كلمة المرور
            document.getElementById('changePasswordBtn').addEventListener('click', showChangePasswordModal);
            document.getElementById('cancelPasswordBtn').addEventListener('click', hideChangePasswordModal);
            document.getElementById('savePasswordBtn').addEventListener('click', changePassword);
            
            // التنقل بين الأقسام
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.classList.contains('disabled')) return;
                    
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(this.dataset.section).classList.add('active');
                });
            });
            
            // إدارة الفنيين
            document.getElementById('addTechBtn').addEventListener('click', addTechnician);
            document.getElementById('updateTechBtn').addEventListener('click', updateTechnician);
            document.getElementById('cancelTechBtn').addEventListener('click', cancelEditTechnician);
            
            // إدارة المستخدمين
            document.getElementById('addUserBtn').addEventListener('click', addUser);
            document.getElementById('updateUserBtn').addEventListener('click', updateUser);
            document.getElementById('cancelUserBtn').addEventListener('click', cancelEditUser);
            
            // إدارة الفواتير
            document.getElementById('saveOrderBtn').addEventListener('click', saveOrder);
            document.getElementById('updateOrderBtn').addEventListener('click', updateOrder);
            document.getElementById('cancelOrderBtn').addEventListener('click', cancelEditOrder);
            document.getElementById('searchOrders').addEventListener('input', searchOrders);
            
            // إدارة مصروفات الأوردر
            document.getElementById('saveExpenseBtn').addEventListener('click', saveOrderExpense);
            document.getElementById('updateExpenseBtn').addEventListener('click', updateOrderExpense);
            document.getElementById('cancelExpenseBtn').addEventListener('click', cancelEditExpense);
            
            // إدارة المصروفات العامة
            document.getElementById('saveGeneralExpenseBtn').addEventListener('click', saveGeneralExpense);
            document.getElementById('updateGeneralExpenseBtn').addEventListener('click', updateGeneralExpense);
            document.getElementById('cancelGeneralExpenseBtn').addEventListener('click', cancelEditGeneralExpense);
            
            // إدارة السلف
            document.getElementById('saveAdvanceBtn').addEventListener('click', saveAdvance);
            document.getElementById('updateAdvanceBtn').addEventListener('click', updateAdvance);
            document.getElementById('cancelAdvanceBtn').addEventListener('click', cancelEditAdvance);
            document.getElementById('filterAdvancesBtn').addEventListener('click', loadAdvances);
            document.getElementById('resetAdvancesBtn').addEventListener('click', function() {
                document.getElementById('advanceFromDate').value = '';
                document.getElementById('advanceToDate').value = '';
                loadAdvances();
            });
            
            // التقارير
            document.getElementById('filterReportBtn').addEventListener('click', loadProfitReport);
            document.getElementById('resetReportBtn').addEventListener('click', function() {
                document.getElementById('reportFromDate').value = '';
                document.getElementById('reportToDate').value = '';
                loadProfitReport();
            });
            
            // ملخص العمليات
            document.getElementById('filterSummaryBtn').addEventListener('click', loadOperationsSummary);
        }
        
        // تسجيل الدخول
        function login() {
            const userId = document.getElementById('loginUser').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!userId) {
                showLoginError('الرجاء اختيار مستخدم');
                return;
            }
            
            const user = users.find(u => u.id == userId);
            
            if (user && user.password === password) {
                currentUser = user;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('currentUserName').textContent = `مرحباً ${user.name}`;
                document.getElementById('currentUserRole').textContent = `الدور: ${getRoleName(user.role)}`;
                
                // تحميل البيانات بناءً على صلاحيات المستخدم
                loadDataBasedOnRole();
                applyUserPermissions();
            } else {
                showLoginError('كلمة المرور غير صحيحة');
            }
        }
        
        // إظهار خطأ تسجيل الدخول
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            errorDiv.style.display = 'block';
        }
        
        // تسجيل الخروج
        function logout() {
            currentUser = null;
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').style.display = 'none';
        }
        
        // تطبيق صلاحيات المستخدم
        function applyUserPermissions() {
            const role = currentUser.role;
            
            // إخفاء/إظهار الأزرار حسب الصلاحية
            const allEditButtons = document.querySelectorAll('.btn-success, .btn-danger, .edit-btn, .delete-btn');
            const allUpdateButtons = document.querySelectorAll('#updateTechBtn, #updateUserBtn, #updateOrderBtn, #updateExpenseBtn, #updateGeneralExpenseBtn, #updateAdvanceBtn');
            const allCancelButtons = document.querySelectorAll('#cancelTechBtn, #cancelUserBtn, #cancelOrderBtn, #cancelExpenseBtn, #cancelGeneralExpenseBtn, #cancelAdvanceBtn');
            
            // إدارة المستخدمين - مرئية فقط لسوبر أدمن
            const usersManagement = document.getElementById('usersManagement');
            const userManagementButtons = document.querySelectorAll('#addUserBtn, #updateUserBtn, #cancelUserBtn');
            
            // إظهار/إخفاء أقسام التنقل
            const settingsNav = document.getElementById('settingsNav');
            const reportsNav = document.getElementById('reportsNav');
            const summaryNav = document.getElementById('summaryNav');
            const generalExpensesNav = document.getElementById('generalExpensesNav');
            
            if (role === 'superAdmin') {
                // سوبر أدمن: كل الصلاحيات
                usersManagement.classList.remove('hidden-by-role');
                userManagementButtons.forEach(btn => btn.classList.remove('hidden-by-role'));
                allEditButtons.forEach(btn => btn.classList.remove('hidden-by-role'));
                allUpdateButtons.forEach(btn => btn.classList.remove('hidden-by-role'));
                allCancelButtons.forEach(btn => btn.classList.remove('hidden-by-role'));
                
                settingsNav.classList.remove('disabled');
                reportsNav.classList.remove('disabled');
                summaryNav.classList.remove('disabled');
                generalExpensesNav.classList.remove('disabled');
            } else if (role === 'admin') {
                // أدمن: لا يرى التقارير أو الإعدادات
                usersManagement.classList.add('hidden-by-role');
                userManagementButtons.forEach(btn => btn.classList.add('hidden-by-role'));
                allEditButtons.forEach(btn => btn.classList.remove('hidden-by-role'));
                allUpdateButtons.forEach(btn => btn.classList.remove('hidden-by-role'));
                allCancelButtons.forEach(btn => btn.classList.remove('hidden-by-role'));
                
                settingsNav.classList.add('disabled');
                reportsNav.classList.add('disabled');
                summaryNav.classList.add('disabled');
                generalExpensesNav.classList.remove('disabled');
            } else if (role === 'dataEntry') {
                // مدخل بيانات: فقط إضافة، لا تعديل ولا حذف ولا تقارير
                usersManagement.classList.add('hidden-by-role');
                userManagementButtons.forEach(btn => btn.classList.add('hidden-by-role'));
                allEditButtons.forEach(btn => btn.classList.add('hidden-by-role'));
                allUpdateButtons.forEach(btn => btn.classList.add('hidden-by-role'));
                allCancelButtons.forEach(btn => btn.classList.add('hidden-by-role'));
                
                settingsNav.classList.add('disabled');
                reportsNav.classList.add('disabled');
                summaryNav.classList.add('disabled');
                generalExpensesNav.classList.add('disabled');
                
                // إظهار أزرار الحفظ فقط
                document.getElementById('saveOrderBtn').classList.remove('hidden-by-role');
                document.getElementById('saveExpenseBtn').classList.remove('hidden-by-role');
            }
            
            // إذا كانت الصفحة الحالية غير مسموح بها، انتقل إلى لوحة التحكم
            const activeSection = document.querySelector('.content-section.active');
            if (activeSection) {
                const activeSectionId = activeSection.id;
                if ((role === 'admin' && (activeSectionId === 'settings' || activeSectionId === 'reports' || activeSectionId === 'summary')) ||
                    (role === 'dataEntry' && (activeSectionId === 'settings' || activeSectionId === 'reports' || activeSectionId === 'summary' || activeSectionId === 'general-expenses'))) {
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                    document.querySelector('[data-section="dashboard"]').classList.add('active');
                    document.getElementById('dashboard').classList.add('active');
                }
            }
        }
        
        // تحميل البيانات بناءً على صلاحيات المستخدم
        function loadDataBasedOnRole() {
            loadTechnicians();
            loadOrders();
            loadOrderExpenses();
            loadGeneralExpenses();
            loadAdvances();
            loadProfitReport();
            loadOperationsSummary();
            loadDashboard();
            
            if (currentUser.role === 'superAdmin') {
                loadUsers();
            }
        }
        
        // تحميل لوحة التحكم
        function loadDashboard() {
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            // الفواتير لهذا الشهر
            const monthlyOrders = orders.filter(order => {
                const orderDate = new Date(order.date);
                return orderDate >= firstDayOfMonth && orderDate <= today;
            });
            
            // الإيرادات لهذا الشهر
            const totalRevenue = monthlyOrders.reduce((sum, order) => sum + order.amount, 0);
            
            // المصروفات لهذا الشهر
            const monthlyExpenses = orderExpenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate >= firstDayOfMonth && expDate <= today;
            });
            
            const monthlyGeneralExpenses = generalExpenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate >= firstDayOfMonth && expDate <= today;
            });
            
            const totalOrderExpenses = monthlyExpenses.reduce((sum, exp) => sum + (exp.parts || 0) + (exp.transport || 0) + (exp.other || 0), 0);
            const totalGeneralExpenses = monthlyGeneralExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const totalExpenses = totalOrderExpenses + totalGeneralExpenses;
            
            // عمولات الفنيين لهذا الشهر
            let totalTechCommission = 0;
            monthlyOrders.forEach(order => {
                const tech = technicians.find(t => t.id === order.technicianId);
                if (tech) {
                    totalTechCommission += order.amount * (tech.percentage / 100);
                }
            });
            
            // صافي الربح لهذا الشهر
            const netProfit = totalRevenue - totalTechCommission - totalExpenses;
            
            // السلف
            const totalAdvances = advances.reduce((sum, adv) => sum + adv.amount, 0);
            
            // تحديث البيانات في لوحة التحكم
            document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString() + ' ج.م';
            document.getElementById('totalOrders').textContent = monthlyOrders.length;
            document.getElementById('netProfit').textContent = netProfit.toLocaleString() + ' ج.م';
            document.getElementById('totalExpenses').textContent = totalExpenses.toLocaleString() + ' ج.م';
            document.getElementById('activeTechnicians').textContent = technicians.length;
            document.getElementById('totalAdvances').textContent = totalAdvances.toLocaleString() + ' ج.م';
            
            // آخر الفواتير (5 فواتير)
            const recentOrders = monthlyOrders.slice(-5).reverse();
            const recentOrdersTableBody = document.getElementById('recentOrdersTableBody');
            const noRecentOrders = document.getElementById('noRecentOrders');
            
            recentOrdersTableBody.innerHTML = '';
            
            if (recentOrders.length === 0) {
                noRecentOrders.style.display = 'block';
                document.getElementById('recentOrdersTable').style.display = 'none';
            } else {
                noRecentOrders.style.display = 'none';
                document.getElementById('recentOrdersTable').style.display = 'table';
                
                recentOrders.forEach(order => {
                    const row = recentOrdersTableBody.insertRow();
                    row.innerHTML = `
                        <td>${order.orderNumber}</td>
                        <td>formatDate(order.date)}</td>
                        <td>${order.customerName}</td>
                        <td>${order.repairType}</td>
                        <td>${order.amount.toLocaleString()} ج.م</td>
                    `;
                });
            }
        }
        
        // تحميل الفنيين
        function loadTechnicians() {
            const techTableBody = document.getElementById('techTableBody');
            const noTechs = document.getElementById('noTechs');
            const technicianSelect = document.getElementById('technician');
            const advanceEmployeeSelect = document.getElementById('advanceEmployee');
            
            techTableBody.innerHTML = '';
            technicianSelect.innerHTML = '<option value="">اختر الفني</option>';
            advanceEmployeeSelect.innerHTML = '<option value="">اختر الموظف</option>';
            
            if (technicians.length === 0) {
                noTechs.style.display = 'block';
                document.getElementById('techTable').style.display = 'none';
            } else {
                noTechs.style.display = 'none';
                document.getElementById('techTable').style.display = 'table';
                
                technicians.forEach((tech, index) => {
                    // إضافة إلى الجدول
                    const row = techTableBody.insertRow();
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${tech.name}</td>
                        <td>${tech.percentage}%</td>
                        <td class="action-btns">
                            <button class="action-btn edit-btn" onclick="editTechnician(${tech.id})">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteTechnician(${tech.id})">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </td>
                    `;
                    
                    // إضافة إلى القائمة المنسدلة للفواتير
                    const option = document.createElement('option');
                    option.value = tech.id;
                    option.textContent = `${tech.name} (${tech.percentage}%)`;
                    technicianSelect.appendChild(option);
                    
                    // إضافة إلى القائمة المنسدلة للسلف
                    const option2 = document.createElement('option');
                    option2.value = tech.name;
                    option2.textContent = tech.name;
                    advanceEmployeeSelect.appendChild(option2);
                });
            }
            
            // تحديث قائمة الفواتير في شاشة المصروفات
            updateOrderNumberSelect();
        }
        
        // إضافة فني جديد
        function addTechnician() {
            const nameInput = document.getElementById('techName');
            const percentageInput = document.getElementById('techPercentage');
            
            const name = nameInput.value.trim();
            const percentage = parseInt(percentageInput.value);
            
            if (!name || isNaN(percentage) || percentage < 0 || percentage > 100) {
                alert('الرجاء إدخال اسم فني ونسبة صحيحة بين 0 و 100');
                return;
            }
            
            const newId = technicians.length > 0 ? Math.max(...technicians.map(t => t.id)) + 1 : 1;
            
            technicians.push({
                id: newId,
                name: name,
                percentage: percentage
            });
            
            saveData();
            loadTechnicians();
            loadDashboard();
            
            // مسح الحقول
            nameInput.value = '';
            percentageInput.value = '';
        }
        
        // تعديل فني
        function editTechnician(id) {
            const tech = technicians.find(t => t.id === id);
            if (tech) {
                document.getElementById('techName').value = tech.name;
                document.getElementById('techPercentage').value = tech.percentage;
                
                editingTechId = id;
                
                // إظهار أزرار التحديث والإلغاء
                document.getElementById('addTechBtn').classList.add('hidden-by-role');
                document.getElementById('updateTechBtn').classList.remove('hidden-by-role');
                document.getElementById('cancelTechBtn').classList.remove('hidden-by-role');
            }
        }
        
        // تحديث فني
        function updateTechnician() {
            if (!editingTechId) return;
            
            const nameInput = document.getElementById('techName');
            const percentageInput = document.getElementById('techPercentage');
            
            const name = nameInput.value.trim();
            const percentage = parseInt(percentageInput.value);
            
            if (!name || isNaN(percentage) || percentage < 0 || percentage > 100) {
                alert('الرجاء إدخال اسم فني ونسبة صحيحة بين 0 و 100');
                return;
            }
            
            const techIndex = technicians.findIndex(t => t.id === editingTechId);
            if (techIndex !== -1) {
                technicians[techIndex].name = name;
                technicians[techIndex].percentage = percentage;
                
                saveData();
                loadTechnicians();
                loadDashboard();
                
                // مسح الحقول وإعادة الحالة
                cancelEditTechnician();
            }
        }
        
        // إلغاء تعديل فني
        function cancelEditTechnician() {
            editingTechId = null;
            document.getElementById('techName').value = '';
            document.getElementById('techPercentage').value = '';
            
            document.getElementById('addTechBtn').classList.remove('hidden-by-role');
            document.getElementById('updateTechBtn').classList.add('hidden-by-role');
            document.getElementById('cancelTechBtn').classList.add('hidden-by-role');
        }
        
        // تحميل المستخدمين
        function loadUsers() {
            const usersTableBody = document.getElementById('usersTableBody');
            const noUsers = document.getElementById('noUsers');
            
            usersTableBody.innerHTML = '';
            
            if (users.length === 0) {
                noUsers.style.display = 'block';
                document.getElementById('usersTable').style.display = 'none';
            } else {
                noUsers.style.display = 'none';
                document.getElementById('usersTable').style.display = 'table';
                
                users.forEach((user, index) => {
                    const row = usersTableBody.insertRow();
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${user.name}</td>
                        <td>${getRoleName(user.role)}</td>
                        <td>${user.password}</td>
                        <td class="action-btns">
                            <button class="action-btn edit-btn" onclick="editUser(${user.id})">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteUser(${user.id})">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </td>
                    `;
                });
            }
        }
        
        // إضافة مستخدم جديد
        function addUser() {
            const nameInput = document.getElementById('userName');
            const roleInput = document.getElementById('userRole');
            const passwordInput = document.getElementById('userPassword');
            
            const name = nameInput.value.trim();
            const role = roleInput.value;
            const password = passwordInput.value.trim();
            
            if (!name || !role || !password) {
                alert('الرجاء إدخال جميع البيانات المطلوبة');
                return;
            }
            
            const newId = users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1;
            
            users.push({
                id: newId,
                name: name,
                role: role,
                password: password
            });
            
            saveData();
            loadUsers();
            loadLoginUsers();
            
            // مسح الحقول
            nameInput.value = '';
            roleInput.value = 'superAdmin';
            passwordInput.value = '';
        }
        
        // تعديل مستخدم
        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (user) {
                document.getElementById('userName').value = user.name;
                document.getElementById('userRole').value = user.role;
                document.getElementById('userPassword').value = user.password;
                
                editingUserId = id;
                
                // إظهار أزرار التحديث والإلغاء
                document.getElementById('addUserBtn').classList.add('hidden-by-role');
                document.getElementById('updateUserBtn').classList.remove('hidden-by-role');
                document.getElementById('cancelUserBtn').classList.remove('hidden-by-role');
            }
        }
        
        // تحديث مستخدم
        function updateUser() {
            if (!editingUserId) return;
            
            const nameInput = document.getElementById('userName');
            const roleInput = document.getElementById('userRole');
            const passwordInput = document.getElementById('userPassword');
            
            const name = nameInput.value.trim();
            const role = roleInput.value;
            const password = passwordInput.value.trim();
            
            if (!name || !role || !password) {
                alert('الرجاء إدخال جميع البيانات المطلوبة');
                return;
            }
            
            const userIndex = users.findIndex(u => u.id === editingUserId);
            if (userIndex !== -1) {
                users[userIndex].name = name;
                users[userIndex].role = role;
                users[userIndex].password = password;
                
                saveData();
                loadUsers();
                loadLoginUsers();
                
                // مسح الحقول وإعادة الحالة
                cancelEditUser();
            }
        }
        
        // إلغاء تعديل مستخدم
        function cancelEditUser() {
            editingUserId = null;
            document.getElementById('userName').value = '';
            document.getElementById('userRole').value = 'superAdmin';
            document.getElementById('userPassword').value = '';
            
            document.getElementById('addUserBtn').classList.remove('hidden-by-role');
            document.getElementById('updateUserBtn').classList.add('hidden-by-role');
            document.getElementById('cancelUserBtn').classList.add('hidden-by-role');
        }
        
        // تحميل الفواتير
        function loadOrders() {
            const ordersTableBody = document.getElementById('ordersTableBody');
            const noOrders = document.getElementById('noOrders');
            
            ordersTableBody.innerHTML = '';
            
            if (orders.length === 0) {
                noOrders.style.display = 'block';
                document.getElementById('ordersTable').style.display = 'none';
            } else {
                noOrders.style.display = 'none';
                document.getElementById('ordersTable').style.display = 'table';
                
                orders.forEach(order => {
                    const tech = technicians.find(t => t.id === order.technicianId);
                    const techName = tech ? tech.name : 'غير معروف';
                    
                    const row = ordersTableBody.insertRow();
                    row.innerHTML = `
                        <td>${order.orderNumber}</td>
                        <td>${formatDate(order.date)}</td>
                        <td>${order.customerName}</td>
                        <td>${order.customerPhone}</td>
                        <td>${order.repairType}</td>
                        <td>${order.amount.toLocaleString()} ج.م</td>
                        <td>${techName}</td>
                        <td class="action-btns">
                            <button class="action-btn edit-btn ${currentUser.role === 'dataEntry' ? 'hidden-by-role' : ''}" onclick="editOrder(${order.id})">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="action-btn delete-btn ${currentUser.role === 'dataEntry' ? 'hidden-by-role' : ''}" onclick="deleteOrder(${order.id})">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </td>
                    `;
                });
            }
            
            // تحديث قائمة الفواتير في شاشة المصروفات
            updateOrderNumberSelect();
        }
        
        // البحث في الفواتير
        function searchOrders() {
            const searchText = document.getElementById('searchOrders').value.toLowerCase();
            const rows = document.querySelectorAll('#ordersTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchText) ? '' : 'none';
            });
        }
        
        // حفظ فاتورة جديدة
        function saveOrder() {
            const orderNumber = document.getElementById('orderNumber').value.trim();
            const orderDate = document.getElementById('orderDate').value;
            const customerName = document.getElementById('customerName').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const technicianId = parseInt(document.getElementById('technician').value);
            const repairType = document.getElementById('repairType').value;
            const orderAmount = parseInt(document.getElementById('orderAmount').value);
            const orderDescription = document.getElementById('orderDescription').value.trim();
            
            if (!orderNumber || !orderDate || !customerName || !customerPhone || !technicianId || !repairType || isNaN(orderAmount) || orderAmount <= 0) {
                alert('الرجاء ملء جميع الحقول المطلوبة بشكل صحيح');
                return;
            }
            
            // التحقق من عدم تكرار رقم الفاتورة
            if (orders.some(order => order.orderNumber === orderNumber)) {
                alert('رقم الفاتورة موجود مسبقاً. الرجاء استخدام رقم فاتورة مختلف.');
                return;
            }
            
            const newId = orders.length > 0 ? Math.max(...orders.map(o => o.id)) + 1 : 1;
            
            orders.push({
                id: newId,
                orderNumber: orderNumber,
                date: orderDate,
                customerName: customerName,
                customerPhone: customerPhone,
                technicianId: technicianId,
                repairType: repairType,
                amount: orderAmount,
                description: orderDescription
            });
            
            saveData();
            loadOrders();
            loadDashboard();
            
            // مسح الحقول
            clearOrderForm();
        }
        
        // تعديل فاتورة
        function editOrder(id) {
            const order = orders.find(o => o.id === id);
            if (order) {
                document.getElementById('orderNumber').value = order.orderNumber;
                document.getElementById('orderDate').value = order.date;
                document.getElementById('customerName').value = order.customerName;
                document.getElementById('customerPhone').value = order.customerPhone;
                document.getElementById('technician').value = order.technicianId;
                document.getElementById('repairType').value = order.repairType;
                document.getElementById('orderAmount').value = order.amount;
                document.getElementById('orderDescription').value = order.description;
                
                editingOrderId = id;
                
                // إظهار أزرار التحديث والإلغاء
                document.getElementById('saveOrderBtn').classList.add('hidden-by-role');
                document.getElementById('updateOrderBtn').classList.remove('hidden-by-role');
                document.getElementById('cancelOrderBtn').classList.remove('hidden-by-role');
            }
        }
        
        // تحديث فاتورة
        function updateOrder() {
            if (!editingOrderId) return;
            
            const orderNumber = document.getElementById('orderNumber').value.trim();
            const orderDate = document.getElementById('orderDate').value;
            const customerName = document.getElementById('customerName').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const technicianId = parseInt(document.getElementById('technician').value);
            const repairType = document.getElementById('repairType').value;
            const orderAmount = parseInt(document.getElementById('orderAmount').value);
            const orderDescription = document.getElementById('orderDescription').value.trim();
            
            if (!orderNumber || !orderDate || !customerName || !customerPhone || !technicianId || !repairType || isNaN(orderAmount) || orderAmount <= 0) {
                alert('الرجاء ملء جميع الحقول المطلوبة بشكل صحيح');
                return;
            }
            
            // التحقق من عدم تكرار رقم الفاتورة (باستثناء الفاتورة الحالية)
            if (orders.some(order => order.orderNumber === orderNumber && order.id !== editingOrderId)) {
                alert('رقم الفاتورة موجود مسبقاً. الرجاء استخدام رقم فاتورة مختلف.');
                return;
            }
            
            const orderIndex = orders.findIndex(o => o.id === editingOrderId);
            if (orderIndex !== -1) {
                orders[orderIndex].orderNumber = orderNumber;
                orders[orderIndex].date = orderDate;
                orders[orderIndex].customerName = customerName;
                orders[orderIndex].customerPhone = customerPhone;
                orders[orderIndex].technicianId = technicianId;
                orders[orderIndex].repairType = repairType;
                orders[orderIndex].amount = orderAmount;
                orders[orderIndex].description = orderDescription;
                
                saveData();
                loadOrders();
                loadDashboard();
                
                // مسح الحقول وإعادة الحالة
                cancelEditOrder();
            }
        }
        
        // إلغاء تعديل فاتورة
        function cancelEditOrder() {
            editingOrderId = null;
            clearOrderForm();
            
            document.getElementById('saveOrderBtn').classList.remove('hidden-by-role');
            document.getElementById('updateOrderBtn').classList.add('hidden-by-role');
            document.getElementById('cancelOrderBtn').classList.add('hidden-by-role');
        }
        
        // مسح نموذج الفاتورة
        function clearOrderForm() {
            document.getElementById('orderNumber').value = '';
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('technician').value = '';
            document.getElementById('orderAmount').value = '';
            document.getElementById('orderDescription').value = '';
        }
        
        // تحديث قائمة أرقام الفواتير في شاشة المصروفات
        function updateOrderNumberSelect() {
            const orderNumberSelect = document.getElementById('expenseOrderNumber');
            orderNumberSelect.innerHTML = '<option value="">اختر رقم الفاتورة</option>';
            
            orders.forEach(order => {
                const option = document.createElement('option');
                option.value = order.orderNumber;
                option.textContent = `${order.orderNumber} (${formatDate(order.date)})`;
                orderNumberSelect.appendChild(option);
            });
        }
        
        // تحميل مصروفات الأوردر
        function loadOrderExpenses() {
            const expensesTableBody = document.getElementById('expensesTableBody');
            const noExpenses = document.getElementById('noExpenses');
            
            expensesTableBody.innerHTML = '';
            
            if (orderExpenses.length === 0) {
                noExpenses.style.display = 'block';
                document.getElementById('expensesTable').style.display = 'none';
            } else {
                noExpenses.style.display = 'none';
                document.getElementById('expensesTable').style.display = 'table';
                
                orderExpenses.forEach(expense => {
                    const total = (expense.parts || 0) + (expense.transport || 0) + (expense.other || 0);
                    
                    const row = expensesTableBody.insertRow();
                    row.innerHTML = `
                        <td>${expense.orderNumber}</td>
                        <td>${formatDate(expense.date)}</td>
                        <td>${(expense.parts || 0).toLocaleString()} ج.م</td>
                        <td>${(expense.transport || 0).toLocaleString()} ج.م</td>
                        <td>${(expense.other || 0).toLocaleString()} ج.م</td>
                        <td>${total.toLocaleString()} ج.م</td>
                        <td>${expense.description}</td>
                        <td class="action-btns">
                            <button class="action-btn edit-btn ${currentUser.role === 'dataEntry' ? 'hidden-by-role' : ''}" onclick="editOrderExpense(${expense.id})">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="action-btn delete-btn ${currentUser.role === 'dataEntry' ? 'hidden-by-role' : ''}" onclick="deleteOrderExpense(${expense.id})">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </td>
                    `;
                });
            }
        }
        
        // حفظ مصروف أوردر
        function saveOrderExpense() {
            const orderNumber = document.getElementById('expenseOrderNumber').value;
            const expenseDate = document.getElementById('expenseDate').value;
            const partsExpense = parseInt(document.getElementById('partsExpense').value) || 0;
            const transportExpense = parseInt(document.getElementById('transportExpense').value) || 0;
            const otherExpense = parseInt(document.getElementById('otherExpense').value) || 0;
            const expenseDescription = document.getElementById('expenseDescription').value.trim();
            
            if (!orderNumber || !expenseDate || (partsExpense === 0 && transportExpense === 0 && otherExpense === 0)) {
                alert('الرجاء ملء جميع الحقول المطلوبة بشكل صحيح');
                return;
            }
            
            const newId = orderExpenses.length > 0 ? Math.max(...orderExpenses.map(e => e.id)) + 1 : 1;
            
            orderExpenses.push({
                id: newId,
                orderNumber: orderNumber,
                date: expenseDate,
                parts: partsExpense,
                transport: transportExpense,
                other: otherExpense,
                description: expenseDescription
            });
            
            saveData();
            loadOrderExpenses();
            loadDashboard();
            
            // مسح الحقول
            clearExpenseForm();
        }
        
        // تعديل مصروف أوردر
        function editOrderExpense(id) {
            const expense = orderExpenses.find(e => e.id === id);
            if (expense) {
                document.getElementById('expenseOrderNumber').value = expense.orderNumber;
                document.getElementById('expenseDate').value = expense.date;
                document.getElementById('partsExpense').value = expense.parts || 0;
                document.getElementById('transportExpense').value = expense.transport || 0;
                document.getElementById('otherExpense').value = expense.other || 0;
                document.getElementById('expenseDescription').value = expense.description;
                
                editingExpenseId = id;
                
                // إظهار أزرار التحديث والإلغاء
                document.getElementById('saveExpenseBtn').classList.add('hidden-by-role');
                document.getElementById('updateExpenseBtn').classList.remove('hidden-by-role');
                document.getElementById('cancelExpenseBtn').classList.remove('hidden-by-role');
            }
        }
        
        // تحديث مصروف أوردر
        function updateOrderExpense() {
            if (!editingExpenseId) return;
            
            const orderNumber = document.getElementById('expenseOrderNumber').value;
            const expenseDate = document.getElementById('expenseDate').value;
            const partsExpense = parseInt(document.getElementById('partsExpense').value) || 0;
            const transportExpense = parseInt(document.getElementById('transportExpense').value) || 0;
            const otherExpense = parseInt(document.getElementById('otherExpense').value) || 0;
            const expenseDescription = document.getElementById('expenseDescription').value.trim();
            
            if (!orderNumber || !expenseDate || (partsExpense === 0 && transportExpense === 0 && otherExpense === 0)) {
                alert('الرجاء ملء جميع الحقول المطلوبة بشكل صحيح');
                return;
            }
            
            const expenseIndex = orderExpenses.findIndex(e => e.id === editingExpenseId);
            if (expenseIndex !== -1) {
                orderExpenses[expenseIndex].orderNumber = orderNumber;
                orderExpenses[expenseIndex].date = expenseDate;
                orderExpenses[expenseIndex].parts = partsExpense;
                orderExpenses[expenseIndex].transport = transportExpense;
                orderExpenses[expenseIndex].other = otherExpense;
                orderExpenses[expenseIndex].description = expenseDescription;
                
                saveData();
                loadOrderExpenses();
                loadDashboard();
                
                // مسح الحقول وإعادة الحالة
                cancelEditExpense();
            }
        }
        
        // إلغاء تعديل مصروف أوردر
        function cancelEditExpense() {
            editingExpenseId = null;
            clearExpenseForm();
            
            document.getElementById('saveExpenseBtn').classList.remove('hidden-by-role');
            document.getElementById('updateExpenseBtn').classList.add('hidden-by-role');
            document.getElementById('cancelExpenseBtn').classList.add('hidden-by-role');
        }
        
        // مسح نموذج المصروف
        function clearExpenseForm() {
            document.getElementById('expenseOrderNumber').value = '';
            document.getElementById('partsExpense').value = '';
            document.getElementById('transportExpense').value = '';
            document.getElementById('otherExpense').value = '';
            document.getElementById('expenseDescription').value = '';
        }
        
        // تحميل المصروفات العامة
        function loadGeneralExpenses() {
            const generalExpensesTableBody = document.getElementById('generalExpensesTableBody');
            const noGeneralExpenses = document.getElementById('noGeneralExpenses');
            
            generalExpensesTableBody.innerHTML = '';
            
            if (generalExpenses.length === 0) {
                noGeneralExpenses.style.display = 'block';
                document.getElementById('generalExpensesTable').style.display = 'none';
            } else {
                noGeneralExpenses.style.display = 'none';
                document.getElementById('generalExpensesTable').style.display = 'table';
                
                generalExpenses.forEach(expense => {
                    const row = generalExpensesTableBody.insertRow();
                    row.innerHTML = `
                        <td>${formatDate(expense.date)}</td>
                        <td>${expense.type}</td>
                        <td>${expense.amount.toLocaleString()} ج.م</td>
                        <td>${expense.description}</td>
                        <td class="action-btns">
                            <button class="action-btn edit-btn ${currentUser.role === 'dataEntry' ? 'hidden-by-role' : ''}" onclick="editGeneralExpense(${expense.id})">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="action-btn delete-btn ${currentUser.role === 'dataEntry' ? 'hidden-by-role' : ''}" onclick="deleteGeneralExpense(${expense.id})">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </td>
                    `;
                });
            }
        }
        
        // حفظ مصروف عام
        function saveGeneralExpense() {
            const expenseDate = document.getElementById('generalExpenseDate').value;
            const expenseType = document.getElementById('generalExpenseType').value;
            const expenseAmount = parseInt(document.getElementById('generalExpenseAmount').value);
            const expenseDescription = document.getElementById('generalExpenseDescription').value.trim();
            
            if (!expenseDate || !expenseType || isNaN(expenseAmount) || expenseAmount <= 0) {
                alert('الرجاء ملء جميع الحقول المطلوبة بشكل صحيح');
                return;
            }
            
            const newId = generalExpenses.length > 0 ? Math.max(...generalExpenses.map(e => e.id)) + 1 : 1;
            
            generalExpenses.push({
                id: newId,
                date: expenseDate,
                type: expenseType,
                amount: expenseAmount,
                description: expenseDescription
            });
            
            saveData();
            loadGeneralExpenses();
            loadDashboard();
            
            // مسح الحقول
            clearGeneralExpenseForm();
        }
        
        // تعديل مصروف عام
        function editGeneralExpense(id) {
            const expense = generalExpenses.find(e => e.id === id);
            if (expense) {
                document.getElementById('generalExpenseDate').value = expense.date;
                document.getElementById('generalExpenseType').value = expense.type;
                document.getElementById('generalExpenseAmount').value = expense.amount;
                document.getElementById('generalExpenseDescription').value = expense.description;
                
                editingGeneralExpenseId = id;
                
                // إظهار أزرار التحديث والإلغاء
                document.getElementById('saveGeneralExpenseBtn').classList.add('hidden-by-role');
                document.getElementById('updateGeneralExpenseBtn').classList.remove('hidden-by-role');
                document.getElementById('cancelGeneralExpenseBtn').classList.remove('hidden-by-role');
            }
        }
        
        // تحديث مصروف عام
        function updateGeneralExpense() {
            if (!editingGeneralExpenseId) return;
            
            const expenseDate = document.getElementById('generalExpenseDate').value;
            const expenseType = document.getElementById('generalExpenseType').value;
            const expenseAmount = parseInt(document.getElementById('generalExpenseAmount').value);
            const expenseDescription = document.getElementById('generalExpenseDescription').value.trim();
            
            if (!expenseDate || !expenseType || isNaN(expenseAmount) || expenseAmount <= 0) {
                alert('الرجاء ملء جميع الحقول المطلوبة بشكل صحيح');
                return;
            }
            
            const expenseIndex = generalExpenses.findIndex(e => e.id === editingGeneralExpenseId);
            if (expenseIndex !== -1) {
                generalExpenses[expenseIndex].date = expenseDate;
                generalExpenses[expenseIndex].type = expenseType;
                generalExpenses[expenseIndex].amount = expenseAmount;
                generalExpenses[expenseIndex].description = expenseDescription;
                
                saveData();
                loadGeneralExpenses();
                loadDashboard();
                
                // مسح الحقول وإعادة الحالة
                cancelEditGeneralExpense();
            }
        }
        
        // إلغاء تعديل مصروف عام
        function cancelEditGeneralExpense() {
            editingGeneralExpenseId = null;
            clearGeneralExpenseForm();
            
            document.getElementById('saveGeneralExpenseBtn').classList.remove('hidden-by-role');
            document.getElementById('updateGeneralExpenseBtn').classList.add('hidden-by-role');
            document.getElementById('cancelGeneralExpenseBtn').classList.add('hidden-by-role');
        }
        
        // مسح نموذج المصروف العام
        function clearGeneralExpenseForm() {
            document.getElementById('generalExpenseType').value = 'ايجار المركز';
            document.getElementById('generalExpenseAmount').value = '';
            document.getElementById('generalExpenseDescription').value = '';
        }
        
        // تحميل السلف
        function loadAdvances() {
            const fromDate = document.getElementById('advanceFromDate').value;
            const toDate = document.getElementById('advanceToDate').value;
            
            const advancesTableBody = document.getElementById('advancesTableBody');
            const noAdvances = document.getElementById('noAdvances');
            
            advancesTableBody.innerHTML = '';
            
            // تصفية السلف حسب التاريخ
            let filteredAdvances = advances;
            if (fromDate || toDate) {
                filteredAdvances = advances.filter(advance => {
                    const advanceDate = new Date(advance.date);
                    const from = fromDate ? new Date(fromDate) : null;
                    const to = toDate ? new Date(toDate) : null;
                    
                    if (from && advanceDate < from) return false;
                    if (to && advanceDate > to) return false;
                    
                    return true;
                });
            }
            
            if (filteredAdvances.length === 0) {
                noAdvances.style.display = 'block';
                document.getElementById('advancesTable').style.display = 'none';
            } else {
                noAdvances.style.display = 'none';
                document.getElementById('advancesTable').style.display = 'table';
                
                filteredAdvances.forEach(advance => {
                    const row = advancesTableBody.insertRow();
                    row.innerHTML = `
                        <td>${formatDate(advance.date)}</td>
                        <td>${advance.employee}</td>
                        <td>${advance.amount.toLocaleString()} ج.م</td>
                        <td>${advance.reason}</td>
                        <td class="action-btns">
                            <button class="action-btn edit-btn ${currentUser.role === 'dataEntry' ? 'hidden-by-role' : ''}" onclick="editAdvance(${advance.id})">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="action-btn delete-btn ${currentUser.role === 'dataEntry' ? 'hidden-by-role' : ''}" onclick="deleteAdvance(${advance.id})">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </td>
                    `;
                });
            }
            
            loadDashboard();
        }
        
        // حفظ سلفة
        function saveAdvance() {
            const employee = document.getElementById('advanceEmployee').value;
            const advanceDate = document.getElementById('advanceDate').value;
            const advanceAmount = parseInt(document.getElementById('advanceAmount').value);
            const advanceReason = document.getElementById('advanceReason').value.trim();
            
            if (!employee || !advanceDate || isNaN(advanceAmount) || advanceAmount <= 0) {
                alert('الرجاء ملء جميع الحقول المطلوبة بشكل صحيح');
                return;
            }
            
            const newId = advances.length > 0 ? Math.max(...advances.map(a => a.id)) + 1 : 1;
            
            advances.push({
                id: newId,
                employee: employee,
                date: advanceDate,
                amount: advanceAmount,
                reason: advanceReason
            });
            
            saveData();
            loadAdvances();
            
            // مسح الحقول
            clearAdvanceForm();
        }
        
        // تعديل سلفة
        function editAdvance(id) {
            const advance = advances.find(a => a.id === id);
            if (advance) {
                document.getElementById('advanceEmployee').value = advance.employee;
                document.getElementById('advanceDate').value = advance.date;
                document.getElementById('advanceAmount').value = advance.amount;
                document.getElementById('advanceReason').value = advance.reason;
                
                editingAdvanceId = id;
                
                // إظهار أزرار التحديث والإلغاء
                document.getElementById('saveAdvanceBtn').classList.add('hidden-by-role');
                document.getElementById('updateAdvanceBtn').classList.remove('hidden-by-role');
                document.getElementById('cancelAdvanceBtn').classList.remove('hidden-by-role');
            }
        }
        
        // تحديث سلفة
        function updateAdvance() {
            if (!editingAdvanceId) return;
            
            const employee = document.getElementById('advanceEmployee').value;
            const advanceDate = document.getElementById('advanceDate').value;
            const advanceAmount = parseInt(document.getElementById('advanceAmount').value);
            const advanceReason = document.getElementById('advanceReason').value.trim();
            
            if (!employee || !advanceDate || isNaN(advanceAmount) || advanceAmount <= 0) {
                alert('الرجاء ملء جميع الحقول المطلوبة بشكل صحيح');
                return;
            }
            
            const advanceIndex = advances.findIndex(a => a.id === editingAdvanceId);
            if (advanceIndex !== -1) {
                advances[advanceIndex].employee = employee;
                advances[advanceIndex].date = advanceDate;
                advances[advanceIndex].amount = advanceAmount;
                advances[advanceIndex].reason = advanceReason;
                
                saveData();
                loadAdvances();
                
                // مسح الحقول وإعادة الحالة
                cancelEditAdvance();
            }
        }
        
        // إلغاء تعديل سلفة
        function cancelEditAdvance() {
            editingAdvanceId = null;
            clearAdvanceForm();
            
            document.getElementById('saveAdvanceBtn').classList.remove('hidden-by-role');
            document.getElementById('updateAdvanceBtn').classList.add('hidden-by-role');
            document.getElementById('cancelAdvanceBtn').classList.add('hidden-by-role');
        }
        
        // مسح نموذج السلفة
        function clearAdvanceForm() {
            document.getElementById('advanceEmployee').value = '';
            document.getElementById('advanceAmount').value = '';
            document.getElementById('advanceReason').value = '';
        }
        
        // تحميل تقرير الربحية
        function loadProfitReport() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            
            const reportTableBody = document.getElementById('profitReportTableBody');
            const noReportData = document.getElementById('noReportData');
            const aggregateReport = document.getElementById('aggregateReport');
            
            reportTableBody.innerHTML = '';
            
            // تصفية الفواتير حسب التاريخ
            let filteredOrders = orders;
            if (fromDate || toDate) {
                filteredOrders = orders.filter(order => {
                    const orderDate = new Date(order.date);
                    const from = fromDate ? new Date(fromDate) : null;
                    const to = toDate ? new Date(toDate) : null;
                    
                    if (from && orderDate < from) return false;
                    if (to && orderDate > to) return false;
                    
                    return true;
                });
            }
            
            if (filteredOrders.length === 0) {
                noReportData.style.display = 'block';
                document.getElementById('profitReportTable').style.display = 'none';
                aggregateReport.innerHTML = '<p>لا توجد بيانات لعرض التقرير المجمع.</p>';
                return;
            }
            
            noReportData.style.display = 'none';
            document.getElementById('profitReportTable').style.display = 'table';
            
            let totalRevenue = 0;
            let totalTechCommission = 0;
            let totalOrderExpenses = 0;
            let totalNetProfit = 0;
            
            filteredOrders.forEach(order => {
                const tech = technicians.find(t => t.id === order.technicianId);
                const techName = tech ? tech.name : 'غير معروف';
                const techPercentage = tech ? tech.percentage : 0;
                
                // حساب عمولة الفني
                const techCommission = order.amount * (techPercentage / 100);
                
                // حساب مصروفات هذا الأوردر
                const orderExpensesTotal = orderExpenses
                    .filter(exp => exp.orderNumber === order.orderNumber)
                    .reduce((sum, exp) => sum + (exp.parts || 0) + (exp.transport || 0) + (exp.other || 0), 0);
                
                // حساب صافي الربح
                const netProfit = order.amount - techCommission - orderExpensesTotal;
                
                // حساب نسبة الربح
                const profitPercentage = order.amount > 0 ? (netProfit / order.amount * 100).toFixed(2) : 0;
                
                // تحديث المجاميع
                totalRevenue += order.amount;
                totalTechCommission += techCommission;
                totalOrderExpenses += orderExpensesTotal;
                totalNetProfit += netProfit;
                
                // إضافة الصف إلى الجدول
                const row = reportTableBody.insertRow();
                row.innerHTML = `
                    <td>${order.orderNumber}</td>
                    <td>${formatDate(order.date)}</td>
                    <td>${order.amount.toLocaleString()} ج.م</td>
                    <td>${techName}</td>
                    <td>${techCommission.toLocaleString()} ج.م</td>
                    <td>${orderExpensesTotal.toLocaleString()} ج.م</td>
                    <td class="${netProfit >= 0 ? 'card-profit' : 'card-loss'}">${netProfit.toLocaleString()} ج.م</td>
                    <td>${profitPercentage}%</td>
                `;
            });
            
            // حساب المصروفات العامة في الفترة
            let filteredGeneralExpenses = generalExpenses;
            if (fromDate || toDate) {
                filteredGeneralExpenses = generalExpenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    const from = fromDate ? new Date(fromDate) : null;
                    const to = toDate ? new Date(toDate) : null;
                    
                    if (from && expenseDate < from) return false;
                    if (to && expenseDate > to) return false;
                    
                    return true;
                });
            }
            
            const totalGeneralExpenses = filteredGeneralExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            
            // حساب صافي الربح النهائي بعد المصروفات العامة
            const finalNetProfit = totalNetProfit - totalGeneralExpenses;
            
            // عرض التقرير المجمع
            aggregateReport.innerHTML = `
                <div class="card">
                    <h3>الإيرادات (الفواتير)</h3>
                    <div class="card-value">${totalRevenue.toLocaleString()} ج.م</div>
                    <p>إجمالي قيمة الفواتير</p>
                </div>
                <div class="card">
                    <h3>عمولات الفنيين</h3>
                    <div class="card-value">${totalTechCommission.toLocaleString()} ج.م</div>
                    <p>إجمالي عمولات الفنيين</p>
                </div>
                <div class="card">
                    <h3>مصروفات التشغيل</h3>
                    <div class="card-value">${totalOrderExpenses.toLocaleString()} ج.م</div>
                    <p>إجمالي مصروفات الأوردرات</p>
                </div>
                <div class="card">
                    <h3>المصروفات العامة</h3>
                    <div class="card-value">${totalGeneralExpenses.toLocaleString()} ج.م</div>
                    <p>إجمالي المصروفات العامة</p>
                </div>
                <div class="card">
                    <h3>صافي الربح</h3>
                    <div class="card-value ${finalNetProfit >= 0 ? 'card-profit' : 'card-loss'}">${finalNetProfit.toLocaleString()} ج.م</div>
                    <p>الإيرادات - (عمولات الفنيين + المصروفات)</p>
                </div>
            `;
        }
        
        // تحميل ملخص العمليات
        function loadOperationsSummary() {
            const fromDate = document.getElementById('summaryFromDate').value;
            const toDate = document.getElementById('summaryToDate').value;
            
            const operationsSummary = document.getElementById('operationsSummary');
            const detailedSummary = document.getElementById('detailedSummary');
            
            // تصفية الفواتير حسب التاريخ
            let filteredOrders = orders;
            if (fromDate || toDate) {
                filteredOrders = orders.filter(order => {
                    const orderDate = new Date(order.date);
                    const from = fromDate ? new Date(fromDate) : null;
                    const to = toDate ? new Date(toDate) : null;
                    
                    if (from && orderDate < from) return false;
                    if (to && orderDate > to) return false;
                    
                    return true;
                });
            }
            
            // تصفية المصروفات حسب التاريخ
            let filteredOrderExpenses = orderExpenses;
            let filteredGeneralExpenses = generalExpenses;
            
            if (fromDate || toDate) {
                filteredOrderExpenses = orderExpenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    const from = fromDate ? new Date(fromDate) : null;
                    const to = toDate ? new Date(toDate) : null;
                    
                    if (from && expenseDate < from) return false;
                    if (to && expenseDate > to) return false;
                    
                    return true;
                });
                
                filteredGeneralExpenses = generalExpenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    const from = fromDate ? new Date(fromDate) : null;
                    const to = toDate ? new Date(toDate) : null;
                    
                    if (from && expenseDate < from) return false;
                    if (to && expenseDate > to) return false;
                    
                    return true;
                });
            }
            
            // حساب الإيرادات حسب النوع
            const revenueByType = {};
            filteredOrders.forEach(order => {
                if (!revenueByType[order.repairType]) {
                    revenueByType[order.repairType] = 0;
                }
                revenueByType[order.repairType] += order.amount;
            });
            
            // حساب مصروفات التشغيل حسب النوع
            const orderExpensesByType = {
                "قطع غيار": 0,
                "مواصلات": 0,
                "أخرى": 0
            };
            
            filteredOrderExpenses.forEach(expense => {
                orderExpensesByType["قطع غيار"] += expense.parts || 0;
                orderExpensesByType["مواصلات"] += expense.transport || 0;
                orderExpensesByType["أخرى"] += expense.other || 0;
            });
            
            // حساب عمولات الفنيين
            const techCommissions = {};
            filteredOrders.forEach(order => {
                const tech = technicians.find(t => t.id === order.technicianId);
                if (tech) {
                    if (!techCommissions[tech.name]) {
                        techCommissions[tech.name] = 0;
                    }
                    techCommissions[tech.name] += order.amount * (tech.percentage / 100);
                }
            });
            
            // حساب المصروفات العامة حسب النوع
            const generalExpensesByType = {};
            filteredGeneralExpenses.forEach(expense => {
                if (!generalExpensesByType[expense.type]) {
                    generalExpensesByType[expense.type] = 0;
                }
                generalExpensesByType[expense.type] += expense.amount;
            });
            
            // حساب المجاميع
            const totalRevenue = filteredOrders.reduce((sum, order) => sum + order.amount, 0);
            const totalOrderExpenses = filteredOrderExpenses.reduce((sum, exp) => sum + (exp.parts || 0) + (exp.transport || 0) + (exp.other || 0), 0);
            const totalTechCommission = Object.values(techCommissions).reduce((sum, val) => sum + val, 0);
            const totalGeneralExpenses = filteredGeneralExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const netProfit = totalRevenue - totalTechCommission - totalOrderExpenses - totalGeneralExpenses;
            
            // عرض ملخص العمليات
            operationsSummary.innerHTML = `
                <div class="card">
                    <h3>الإيرادات</h3>
                    <div class="card-value">${totalRevenue.toLocaleString()} ج.م</div>
                    <p>إجمالي الفواتير</p>
                </div>
                <div class="card">
                    <h3>مصروفات التشغيل</h3>
                    <div class="card-value">${totalOrderExpenses.toLocaleString()} ج.م</div>
                    <p>مصروفات الأوردرات</p>
                </div>
                <div class="card">
                    <h3>عمولات الفنيين</h3>
                    <div class="card-value">${totalTechCommission.toLocaleString()} ج.م</div>
                    <p>إجمالي عمولات الفنيين</p>
                </div>
                <div class="card">
                    <h3>المصروفات العامة</h3>
                    <div class="card-value">${totalGeneralExpenses.toLocaleString()} ج.م</div>
                    <p>إجمالي المصروفات العامة</p>
                </div>
                <div class="card">
                    <h3>صافي الربح</h3>
                    <div class="card-value ${netProfit >= 0 ? 'card-profit' : 'card-loss'}">${netProfit.toLocaleString()} ج.م</div>
                    <p>النتيجة النهائية</p>
                </div>
            `;
            
            // عرض التفاصيل
            let detailedHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #1a8c5e; margin-bottom: 10px;">الإيرادات حسب النوع</h4>
                        <ul style="list-style: none; padding: 0;">
            `;
            
            // إيرادات حسب النوع
            for (const [type, amount] of Object.entries(revenueByType)) {
                detailedHTML += `<li style="padding: 5px 0; border-bottom: 1px solid #eee;">${type}: <strong>${amount.toLocaleString()} ج.م</strong></li>`;
            }
            
            detailedHTML += `
                        </ul>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #1a8c5e; margin-bottom: 10px;">مصروفات التشغيل</h4>
                        <ul style="list-style: none; padding: 0;">
            `;
            
            // مصروفات التشغيل حسب النوع
            for (const [type, amount] of Object.entries(orderExpensesByType)) {
                if (amount > 0) {
                    detailedHTML += `<li style="padding: 5px 0; border-bottom: 1px solid #eee;">${type}: <strong>${amount.toLocaleString()} ج.م</strong></li>`;
                }
            }
            
            detailedHTML += `
                        </ul>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #1a8c5e; margin-bottom: 10px;">عمولات الفنيين</h4>
                        <ul style="list-style: none; padding: 0;">
            `;
            
            // عمولات الفنيين
            for (const [name, amount] of Object.entries(techCommissions)) {
                detailedHTML += `<li style="padding: 5px 0; border-bottom: 1px solid #eee;">${name}: <strong>${amount.toLocaleString()} ج.م</strong></li>`;
            }
            
            detailedHTML += `
                        </ul>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #1a8c5e; margin-bottom: 10px;">المصروفات العامة</h4>
                        <ul style="list-style: none; padding: 0;">
            `;
            
            // المصروفات العامة
            for (const [type, amount] of Object.entries(generalExpensesByType)) {
                detailedHTML += `<li style="padding: 5px 0; border-bottom: 1px solid #eee;">${type}: <strong>${amount.toLocaleString()} ج.م</strong></li>`;
            }
            
            detailedHTML += `
                        </ul>
                    </div>
                </div>
            `;
            
            detailedSummary.innerHTML = detailedHTML;
        }
        
        // إظهار نافذة تغيير كلمة المرور
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'flex';
        }
        
        // إخفاء نافذة تغيير كلمة المرور
        function hideChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'none';
            document.getElementById('oldPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('passwordError').style.display = 'none';
        }
        
        // تغيير كلمة المرور
        function changePassword() {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const passwordError = document.getElementById('passwordError');
            
            if (!oldPassword || !newPassword || !confirmPassword) {
                passwordError.textContent = 'الرجاء إدخال جميع الحقول';
                passwordError.style.display = 'block';
                return;
            }
            
            if (oldPassword !== currentUser.password) {
                passwordError.textContent = 'كلمة المرور القديمة غير صحيحة';
                passwordError.style.display = 'block';
                return;
            }
            
            if (newPassword !== confirmPassword) {
                passwordError.textContent = 'كلمة المرور الجديدة غير متطابقة';
                passwordError.style.display = 'block';
                return;
            }
            
            // تحديث كلمة المرور
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex].password = newPassword;
                currentUser.password = newPassword;
                saveData();
                
                alert('تم تغيير كلمة المرور بنجاح');
                hideChangePasswordModal();
            }
        }
        
        // حذف فني
        function deleteTechnician(id) {
            if (confirm('هل أنت متأكد من حذف هذا الفني؟')) {
                technicians = technicians.filter(tech => tech.id !== id);
                saveData();
                loadTechnicians();
                loadOrders();
                loadDashboard();
            }
        }
        
        // حذف مستخدم
        function deleteUser(id) {
            if (id === currentUser.id) {
                alert('لا يمكن حذف المستخدم الحالي');
                return;
            }
            
            if (confirm('هل أنت متأكد من حذف هذا المستخدم؟')) {
                users = users.filter(user => user.id !== id);
                saveData();
                loadUsers();
                loadLoginUsers();
            }
        }
        
        // حذف فاتورة
        function deleteOrder(id) {
            if (confirm('هل أنت متأكد من حذف هذه الفاتورة؟')) {
                orders = orders.filter(order => order.id !== id);
                saveData();
                loadOrders();
                loadDashboard();
            }
        }
        
        // حذف مصروف أوردر
        function deleteOrderExpense(id) {
            if (confirm('هل أنت متأكد من حذف هذا المصروف؟')) {
                orderExpenses = orderExpenses.filter(expense => expense.id !== id);
                saveData();
                loadOrderExpenses();
                loadDashboard();
            }
        }
        
        // حذف مصروف عام
        function deleteGeneralExpense(id) {
            if (confirm('هل أنت متأكد من حذف هذا المصروف العام؟')) {
                generalExpenses = generalExpenses.filter(expense => expense.id !== id);
                saveData();
                loadGeneralExpenses();
                loadDashboard();
            }
        }
        
        // حذف سلفة
        function deleteAdvance(id) {
            if (confirm('هل أنت متأكد من حذف هذه السلفة؟')) {
                advances = advances.filter(advance => advance.id !== id);
                saveData();
                loadAdvances();
            }
        }
        
        // وظائف مساعدة
        function formatDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // جعل الدوال متاحة عالمياً للاستخدام في الأزرار
        window.editTechnician = editTechnician;
        window.deleteTechnician = deleteTechnician;
        window.editUser = editUser;
        window.deleteUser = deleteUser;
        window.editOrder = editOrder;
        window.deleteOrder = deleteOrder;
        window.editOrderExpense = editOrderExpense;
        window.deleteOrderExpense = deleteOrderExpense;
        window.editGeneralExpense = editGeneralExpense;
        window.deleteGeneralExpense = deleteGeneralExpense;
        window.editAdvance = editAdvance;
        window.deleteAdvance = deleteAdvance;
    </script>
</body>
</html>